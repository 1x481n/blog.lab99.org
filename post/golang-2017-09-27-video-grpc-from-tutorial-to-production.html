<!DOCTYPE html><html lang="zh-cn"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 视频笔记：gRPC 从学习到生产 - Alan Shreve · 大桥下的蜗牛</title><meta name="description" content="无善无恶心之体，有善有恶意之动，知善知恶是良知，为善去恶是格物。"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/jekyll.css"><link rel="stylesheet" href="https://cdn.bootcss.com/mermaid/7.0.0/mermaid.min.css"><!--[if lt IE 9]>
<script src="js/html5shiv.min.js"></script>
<script src="js/respond.min.js"></script>
<![endif]--></head><body><header class="row-flex-row limit-width vh-center"><a href="/" class="logo"><img src="/favicon.png"></a><nav><ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-link">主页</a></li><li class="nav-list-item"><a href="/archives/" class="nav-link active">   博客</a></li><li class="nav-list-item"><a href="https://github.com/twang2218" target="_blank" class="nav-link">github</a></li><li class="nav-list-item"><a href="https://coding.net/u/twang2218" target="_blank" class="nav-link">coding</a></li><li class="nav-list-item"><a href="/atom.xml" class="nav-link">rss</a></li></ul></nav></header><div class="container limit-width"><section class="row-flex-row"><div class="post"><article class="post-block"><h2 class="post-title"><a href="/post/golang-2017-09-27-video-grpc-from-tutorial-to-production.html" class="post-title-link">视频笔记：gRPC 从学习到生产 - Alan Shreve</a></h2><div class="post-meta"><ul class="post-tag-list"><li class="post-tag-item"><a href="/tags/youtube/" class="post-tag-link">youtube</a></li><li class="post-tag-item"><a href="/tags/notes/" class="post-tag-link">notes</a></li><li class="post-tag-item"><a href="/tags/golang/" class="post-tag-link">golang</a></li><li class="post-tag-item"><a href="/tags/gophercon2017/" class="post-tag-link">gophercon2017</a></li></ul><div class="post-time">2017年9月23日 星期六</div></div><div class="post-content"><link rel="stylesheet" href="/style/owl.css"><!-- toc -->
<ul>
<li><a href="#shi-pin-xin-xi">&#x89C6;&#x9891;&#x4FE1;&#x606F;</a><ul>
<li><a href="#yan-jiang-zhe">&#x6F14;&#x8BB2;&#x8005;</a></li>
<li><a href="#wei-fu-wu-zhi-jian-ying-gai-ru-he-tong-xun">&#x5FAE;&#x670D;&#x52A1;&#x4E4B;&#x95F4;&#x5E94;&#x8BE5;&#x5982;&#x4F55;&#x901A;&#x8BAF;&#xFF1F;</a></li>
<li><a href="#wei-shi-me-rest-api-bu-hao-yong">&#x4E3A;&#x4EC0;&#x4E48; REST API &#x4E0D;&#x597D;&#x7528;&#xFF1F;</a></li>
<li><a href="#shi-me-shi-grpc">&#x4EC0;&#x4E48;&#x662F; gRPC</a></li>
<li><a href="#jian-yi-ge-huan-cun-fu-wu">&#x5EFA;&#x4E00;&#x4E2A;&#x7F13;&#x5B58;&#x670D;&#x52A1;</a><ul>
<li><a href="#app-proto">app.proto</a></li>
<li><a href="#server-go">server.go</a></li>
<li><a href="#client-go">client.go</a></li>
<li><a href="#zhe-bu-jiu-shi-wsdl-me">&#x8FD9;&#x4E0D;&#x5C31;&#x662F; WSDL &#x4E48;&#xFF1F;</a></li>
<li><a href="#shi-xian-ju-ti-de-cacheservice">&#x5B9E;&#x73B0;&#x5177;&#x4F53;&#x7684; CacheService</a></li>
<li><a href="#cuo-wu-chu-li">&#x9519;&#x8BEF;&#x5904;&#x7406;</a></li>
<li><a href="#jia-mi-chuan-shu">&#x52A0;&#x5BC6;&#x4F20;&#x8F93;</a></li>
</ul>
</li>
<li><a href="#sheng-chan-huan-jing-ru-he-shi-yong-grpc">&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x5982;&#x4F55;&#x4F7F;&#x7528; gRPC</a><ul>
<li><a href="#grpc-de-shi-xian">gRPC &#x7684;&#x5B9E;&#x73B0;</a></li>
<li><a href="#grpc-cong-na-lai-de">gRPC &#x4ECE;&#x54EA;&#x6765;&#x7684;</a></li>
<li><a href="#sheng-chan-huan-jing-an-li-duo-zu-hu">&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;&#x591A;&#x79DF;&#x6237;</a></li>
<li><a href="#sheng-chan-huan-jing-an-li-xing-neng">&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;&#x6027;&#x80FD;</a></li>
<li><a href="#sheng-chan-huan-jing-an-li-chao-shi">&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;&#x8D85;&#x65F6;</a></li>
<li><a href="#sheng-chan-huan-jing-an-li-shang-xia-wen-chuan-di">&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;&#x4E0A;&#x4E0B;&#x6587;&#x4F20;&#x9012;</a></li>
<li><a href="#sheng-chan-huan-jing-an-li-grpc-metadata">&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;GRPC Metadata</a></li>
<li><a href="#sheng-chan-huan-jing-an-li-retry">&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;Retry</a></li>
<li><a href="#sheng-chan-huan-jing-an-li-jie-gou-hua-cuo-wu">&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;&#x7ED3;&#x6784;&#x5316;&#x9519;&#x8BEF;</a></li>
<li><a href="#sheng-chan-huan-jing-an-li-dump">&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;Dump</a></li>
<li><a href="#sheng-chan-huan-jing-an-li-liu-liang-kong-zhi">&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;&#x6D41;&#x91CF;&#x63A7;&#x5236;</a></li>
<li><a href="#sheng-chan-huan-jing-an-li-streaming">&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;Streaming</a></li>
<li><a href="#sheng-chan-huan-jing-an-li-heng-xiang-kuo-zhan-fu-zai-jun-heng">&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;&#x6A2A;&#x5411;&#x6269;&#x5C55;&#x3001;&#x8D1F;&#x8F7D;&#x5747;&#x8861;</a></li>
<li><a href="#sheng-chan-huan-jing-an-li-duo-yu-yan-xie-zuo">&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;&#x591A;&#x8BED;&#x8A00;&#x534F;&#x4F5C;</a></li>
</ul>
</li>
<li><a href="#grpc-shang-bu-wan-mei-de-di-fang">gRPC &#x5C1A;&#x4E0D;&#x5B8C;&#x7F8E;&#x7684;&#x5730;&#x65B9;</a></li>
<li><a href="#grpc-zai-sheng-chan-huan-jing-zhong-de-yong-li">gRPC &#x5728;&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x4E2D;&#x7684;&#x7528;&#x4F8B;</a></li>
<li><a href="#grpc-wei-lai-de-bian-hua">gRPC &#x672A;&#x6765;&#x7684;&#x53D8;&#x5316;</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->
<h1 id="shi-pin-xin-xi"><a href="#&#x89C6;&#x9891;&#x4FE1;&#x606F;" class="headerlink" title="&#x89C6;&#x9891;&#x4FE1;&#x606F;"></a>&#x89C6;&#x9891;&#x4FE1;&#x606F; <a href="#shi-pin-xin-xi" class="header-anchor">#</a></h1><p><strong>grpc: From Tutorial to Production</strong><br>by Alan Shreve<br>at GopherCon 2017</p>
<div class="owl-media owl-video owl-youtube"><iframe src="//www.youtube.com/embed/7FZ6ZyzGex0" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe></div>
<p><a href="https://www.youtube.com/watch?v=7FZ6ZyzGex0" target="_blank" rel="noopener">https://www.youtube.com/watch?v=7FZ6ZyzGex0</a></p>
<p>&#x535A;&#x6587;&#xFF1A;<a href="https://about.sourcegraph.com/go/grpc-in-production-alan-shreve/" target="_blank" rel="noopener">https://about.sourcegraph.com/go/grpc-in-production-alan-shreve/</a></p>
<h2 id="yan-jiang-zhe"><a href="#&#x6F14;&#x8BB2;&#x8005;" class="headerlink" title="&#x6F14;&#x8BB2;&#x8005;"></a>&#x6F14;&#x8BB2;&#x8005; <a href="#yan-jiang-zhe" class="header-anchor">#</a></h2><p>Alan Shreve, <a href="https://ngrok.com" target="_blank" rel="noopener">https://ngrok.com</a> &amp; <a href="https://equinox.io" target="_blank" rel="noopener">https://equinox.io</a><br>Github: <a href="https://github.com/inconshreveable" target="_blank" rel="noopener">@inconshreveable</a> &amp; Twitter: <a href="https://twitter.com/inconshreveable?lang=en" target="_blank" rel="noopener">@inconshreveable</a></p>
<h2 id="wei-fu-wu-zhi-jian-ying-gai-ru-he-tong-xun"><a href="#&#x5FAE;&#x670D;&#x52A1;&#x4E4B;&#x95F4;&#x5E94;&#x8BE5;&#x5982;&#x4F55;&#x901A;&#x8BAF;&#xFF1F;" class="headerlink" title="&#x5FAE;&#x670D;&#x52A1;&#x4E4B;&#x95F4;&#x5E94;&#x8BE5;&#x5982;&#x4F55;&#x901A;&#x8BAF;&#xFF1F;"></a>&#x5FAE;&#x670D;&#x52A1;&#x4E4B;&#x95F4;&#x5E94;&#x8BE5;&#x5982;&#x4F55;&#x901A;&#x8BAF;&#xFF1F; <a href="#wei-fu-wu-zhi-jian-ying-gai-ru-he-tong-xun" class="header-anchor">#</a></h2><p>&#x7B54;&#x6848;&#x5C31;&#x662F;&#xFF1A;<strong><a href="https://en.wikipedia.org/wiki/SOAP" target="_blank" rel="noopener">SOAP</a></strong>&#x2026;&#x2026;&#x597D;&#x5427;&#xFF0C;&#x5F00;&#x4E2A;&#x73A9;&#x7B11;&#xFF0C;&#x5F53;&#x7136;&#x4E0D;&#x53EF;&#x80FD;&#x662F; SOAP &#x4E86;&#x3002;</p>
<p>&#x73B0;&#x5728;&#x6D41;&#x884C;&#x7684;&#x505A;&#x6CD5;&#x662F; <strong>HTTP + JSON (<a href="https://en.wikipedia.org/wiki/Representational_state_transfer" target="_blank" rel="noopener">REST API</a>)</strong></p>
<p>Alan &#x8BF4;&#x201C;&#x5982;&#x679C;&#x8FD9;&#x8F88;&#x5B50;&#x518D;&#x4E5F;&#x4E0D;&#x5199;&#x53E6;&#x4E00;&#x4E2A; REST &#x5BA2;&#x6237;&#x7AEF;&#x5E93;&#x7684;&#x8BDD;&#xFF0C;&#x90A3;&#x5C31;&#x53EF;&#x4EE5;&#x5F88;&#x5E78;&#x798F;&#x7684;&#x6B7B;&#x53BB;&#x4E86;&#x2026;&#x2026;&#x1F602;&#x201D;&#xFF0C;&#x56E0;&#x4E3A;&#x8FD9;&#x662F;&#x6700;&#x65E0;&#x804A;&#x7684;&#x4E8B;&#x60C5;&#xFF0C;&#x4E00;&#x904D;&#x4E00;&#x904D;&#x7684;&#x5728;&#x505A;&#x540C;&#x6837;&#x7684;&#x4E8B;&#x60C5;&#x3002;</p>
<h2 id="wei-shi-me-rest-api-bu-hao-yong"><a href="#&#x4E3A;&#x4EC0;&#x4E48;-REST-API-&#x4E0D;&#x597D;&#x7528;&#xFF1F;" class="headerlink" title="&#x4E3A;&#x4EC0;&#x4E48; REST API &#x4E0D;&#x597D;&#x7528;&#xFF1F;"></a>&#x4E3A;&#x4EC0;&#x4E48; REST API &#x4E0D;&#x597D;&#x7528;&#xFF1F; <a href="#wei-shi-me-rest-api-bu-hao-yong" class="header-anchor">#</a></h2><ul>
<li>&#x5B9E;&#x73B0; Stream &#x592A;&#x96BE;&#x4E86;</li>
<li>&#x800C;&#x53CC;&#x5411;&#x7684;&#x6D41;&#x5C31;&#x6839;&#x672C;&#x4E0D;&#x53EF;&#x80FD;</li>
<li>&#x5F88;&#x96BE;&#x5BF9;&#x64CD;&#x4F5C;&#x5EFA;&#x7ACB;&#x6A21;&#x578B;</li>
<li>&#x6548;&#x7387;&#x5F88;&#x5DEE;&#xFF0C;&#x6587;&#x672C;&#x8868;&#x793A;&#x5BF9;&#x4E8E;&#x7F51;&#x7EDC;&#x6765;&#x8BF4;&#x5E76;&#x4E0D;&#x662F;&#x6700;&#x597D;&#x7684;&#x9009;&#x62E9;</li>
<li>&#x800C;&#x4E14;&#xFF0C;&#x5176;&#x5B9E;&#x670D;&#x52A1;&#x5185;&#x90E8;&#x6839;&#x672C;&#x4E0D;&#x662F; RESTful &#x7684;&#x65B9;&#x5F0F;&#xFF0C;&#x8FD9;&#x53EA;&#x662F; HTTP endpoint</li>
<li>&#x5F88;&#x96BE;&#x5728;&#x4E00;&#x4E2A;&#x8BF7;&#x6C42;&#x4E2D;&#x53D6;&#x5F97;&#x591A;&#x4E2A;&#x8D44;&#x6E90;&#x6570;&#x636E; &#xFF08;&#x53CD;&#x4F8B;&#x770B; <a href="http://graphql.org/learn/" target="_blank" rel="noopener">GraphQL</a>&#xFF09;</li>
<li>&#x6CA1;&#x6709;<strong>&#x6B63;&#x5F0F;&#x7684;</strong>&#xFF08;&#x673A;&#x5668;&#x53EF;&#x8BFB;&#x7684;&#xFF09;API&#x7EA6;&#x675F;<ul>
<li>&#x56E0;&#x6B64;&#x5199;&#x5BA2;&#x6237;&#x7AEF;&#x9700;&#x8981;&#x4EBA;&#x7C7B;<ul>
<li>&#x800C;&#x4E14;&#x56E0;&#x4E3A;&#x1F477;&#x5F88;&#x8D35;&#xFF0C;&#x800C;&#x4E14;&#x4E0D;&#x559C;&#x6B22;&#x5199;&#x5BA2;&#x6237;&#x7AEF;</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="shi-me-shi-grpc"><a href="#&#x4EC0;&#x4E48;&#x662F;-gRPC" class="headerlink" title="&#x4EC0;&#x4E48;&#x662F; gRPC"></a>&#x4EC0;&#x4E48;&#x662F; gRPC <a href="#shi-me-shi-grpc" class="header-anchor">#</a></h2><blockquote>
<p><a href="https://grpc.io" target="_blank" rel="noopener">gPRC</a> &#x662F;&#x9AD8;&#x6027;&#x80FD;&#x3001;&#x5F00;&#x6E90;&#x3001;&#x901A;&#x7528;&#x7684; RPC &#x6846;&#x67B6;&#x3002;</p>
</blockquote>
<p>&#x4E0E;&#x5176;&#x8BB2;&#x89E3;&#x5B9A;&#x4E49;&#xFF0C;&#x4E0D;&#x5982;&#x6765;&#x5B9E;&#x9645;&#x505A;&#x4E2A;&#x4E1C;&#x897F;&#x66F4;&#x6E05;&#x695A;&#x3002;</p>
<h2 id="jian-yi-ge-huan-cun-fu-wu"><a href="#&#x5EFA;&#x4E00;&#x4E2A;&#x7F13;&#x5B58;&#x670D;&#x52A1;" class="headerlink" title="&#x5EFA;&#x4E00;&#x4E2A;&#x7F13;&#x5B58;&#x670D;&#x52A1;"></a>&#x5EFA;&#x4E00;&#x4E2A;&#x7F13;&#x5B58;&#x670D;&#x52A1; <a href="#jian-yi-ge-huan-cun-fu-wu" class="header-anchor">#</a></h2><p>&#x4F7F;&#x7528; gRPC &#x8FD9;&#x7C7B;&#x4E1C;&#x897F;&#xFF0C;&#x6211;&#x4EEC;&#x5E76;&#x975E;&#x5F00;&#x59CB;&#x4E8E;&#x5199; Go &#x4EE3;&#x7801;&#xFF0C;&#x6211;&#x4EEC;&#x662F;&#x4ECE;&#x64B0;&#x5199; gRPC &#x7684; <a href="https://developers.google.com/protocol-buffers/docs/overview" target="_blank" rel="noopener">IDL</a> &#x5F00;&#x59CB;&#x7684;&#x3002;</p>
<h3 id="app-proto"><a href="#app-proto" class="headerlink" title="app.proto"></a>app.proto <a href="#app-proto" class="header-anchor">#</a></h3><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span></span><br><span class="line"><span class="keyword">package</span> <span class="function"><span class="keyword">rpc</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">service</span> <span class="title">Cache</span> </span>{</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> Store(StoreReq) <span class="keyword">returns</span> (StoreResp) {}</span></span><br><span class="line"><span class="function">  <span class="keyword">rpc</span> Get(GetReq) <span class="keyword">returns</span> (GetResp) {}</span></span><br><span class="line"><span class="function">}</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">message StoreReq {</span></span><br><span class="line"><span class="function">  string key = 1</span>;</span><br><span class="line">  <span class="built_in">bytes</span> val = <span class="number">2</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">StoreResp</span> </span>{</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">GetReq</span> </span>{</span><br><span class="line">  <span class="built_in">string</span> key = <span class="number">1</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">GetResp</span> </span>{</span><br><span class="line">  <span class="built_in">bytes</span> val = <span class="number">1</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x5F53;&#x5199;&#x4E86;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x7ACB;&#x523B;&#x62E5;&#x6709;&#x4E86;<strong>9</strong>&#x79CD;&#x8BED;&#x8A00;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x5E93;&#x3002;</p>
<ul>
<li>C++</li>
<li>Java(and Android)</li>
<li>Python</li>
<li>Go</li>
<li>Ruby</li>
<li>C#</li>
<li>Javascript(node.js)</li>
<li>Objective-C (iOS!)</li>
<li>PHP</li>
</ul>
<p>&#x540C;&#x65F6;&#xFF0C;&#x6211;&#x4EEC;&#x4E5F;&#x62E5;&#x6709;&#x4E86;<strong>7</strong>&#x79CD;&#x8BED;&#x8A00;&#x7684;&#x670D;&#x52A1;&#x7AEF;&#x7684; API Stub&#xFF1A;</p>
<ul>
<li>C++</li>
<li>Java</li>
<li>Python</li>
<li>Go</li>
<li>Ruby</li>
<li>C#</li>
<li>Javascript(node.js)</li>
</ul>
<h3 id="server-go"><a href="#server-go" class="headerlink" title="server.go"></a>server.go <a href="#server-go" class="header-anchor">#</a></h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">serverMain</span><span class="params">()</span></span> {</span><br><span class="line">  <span class="keyword">if</span> err := runServer(); err != <span class="literal">nil</span> {</span><br><span class="line">    fmt.Fprintf(os.Stderr, <span class="string">&quot;Failed to run cache server: %s\n&quot;</span>, err)</span><br><span class="line">    os.Exit(<span class="number">1</span>)</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">runServer</span><span class="params">()</span> <span class="title">error</span></span> {</span><br><span class="line">  srv := grpc.NewServer()</span><br><span class="line">  rpc.RegisterCacheServer(srv, &amp;CacheService{})</span><br><span class="line">  l, err := net.Listen(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;localhost:5051&quot;</span>)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">//  block</span></span><br><span class="line">  <span class="keyword">return</span> srv.Serve(l)</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x6682;&#x65F6;&#x5148;&#x4E0D;&#x5B9E;&#x73B0; <code>CacheService</code>&#xFF0C;&#x5148;&#x653E;&#x4E2A;&#x7A7A;&#x7684;&#xFF0C;&#x7A0D;&#x540E;&#x518D;&#x5B9E;&#x73B0;&#x3002;</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> CacheService <span class="keyword">struct</span> {</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *CacheService)</span> <span class="title">Get</span><span class="params">(ctx context.Context, req *rpc.GetReq)</span> <span class="params">(*rpc.GetResp, error)</span></span> {</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;unimplemented&quot;</span>)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *CacheService)</span> <span class="title">Store</span><span class="params">(ctx context.Context, req *rpc.StoreReq)</span> <span class="params">(*rpc.StoreResp, error)</span></span> {</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;unimplemented&quot;</span>)</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="client-go"><a href="#client-go" class="headerlink" title="client.go"></a>client.go <a href="#client-go" class="header-anchor">#</a></h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">clientMain</span><span class="params">()</span></span> {</span><br><span class="line">  <span class="keyword">if</span> err != runClient(); err != <span class="literal">nil</span> {</span><br><span class="line">    fmt.Fprintf(os.Stderr, <span class="string">&quot;failed: %v\n&quot;</span>, err)</span><br><span class="line">    os.Exit(<span class="number">1</span>)</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">runClient</span><span class="params">()</span> <span class="title">error</span></span> {</span><br><span class="line">  <span class="comment">//  &#x5EFA;&#x7ACB;&#x8FDE;&#x63A5;</span></span><br><span class="line">  conn, err := grpc.Dial(<span class="string">&quot;localhost:5053&quot;</span>, grpc.WithInsecure())</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">    <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to dial server: %v&quot;</span>, err)</span><br><span class="line">  }</span><br><span class="line">  cache := rpc.NewCacheClient(conn)</span><br><span class="line">  <span class="comment">//  &#x8C03;&#x7528; grpc &#x7684; store() &#x65B9;&#x6CD5;&#x5B58;&#x50A8;&#x952E;&#x503C;&#x5BF9; { &quot;gopher&quot;: &quot;con&quot; }</span></span><br><span class="line">  _, err = cache.Store(context.Background(), &amp;rpc.StoreReq{Key: <span class="string">&quot;gopher&quot;</span>, Val: []<span class="keyword">byte</span>(<span class="string">&quot;con&quot;</span>)})</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">    <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to store: %v&quot;</span>, err)</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">//  &#x8C03;&#x7528; grpc &#x7684; get() &#x65B9;&#x6CD5;&#x53D6;&#x56DE;&#x952E;&#x4E3A; `gopher` &#x7684;&#x503C;</span></span><br><span class="line">  resp, err := cache.Get(context.Background(), &amp;rpc.GetReq{Key: <span class="string">&quot;gopher&quot;</span>})</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">    <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to get: %v&quot;</span>, err)</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">//  &#x8F93;&#x51FA;</span></span><br><span class="line">  fmt.Printf(<span class="string">&quot;Got cached value %s\n&quot;</span>, resp.Val)</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="zhe-bu-jiu-shi-wsdl-me"><a href="#&#x8FD9;&#x4E0D;&#x5C31;&#x662F;-WSDL-&#x4E48;&#xFF1F;" class="headerlink" title="&#x8FD9;&#x4E0D;&#x5C31;&#x662F; WSDL &#x4E48;&#xFF1F;"></a>&#x8FD9;&#x4E0D;&#x5C31;&#x662F; WSDL &#x4E48;&#xFF1F; <a href="#zhe-bu-jiu-shi-wsdl-me" class="header-anchor">#</a></h3><p>&#x6216;&#x8BB8;&#x6709;&#x4E9B;&#x4EBA;&#x4F1A;&#x8BA4;&#x4E3A;&#x8FD9;&#x548C; <a href="https://en.wikipedia.org/wiki/Web_Services_Description_Language" target="_blank" rel="noopener">WSDL</a> &#x4E5F;&#x592A;&#x50CF;&#x4E86;&#xFF0C;&#x8FD9;&#x4E48;&#x60F3;&#x6CA1;&#x6709;&#x9519;&#xFF0C;&#x56E0;&#x4E3A; gRPC &#x5728;&#x501F;&#x9274;&#x4E4B;&#x524D;&#x7684; SOAP/WSDL &#x7684;&#x9519;&#x8BEF;&#x57FA;&#x7840;&#x4E0A;&#xFF0C;&#x4E5F;&#x5438;&#x53D6;&#x4E86;&#x4ED6;&#x4EEC;&#x4F18;&#x79C0;&#x7684;&#x5730;&#x65B9;&#x3002;</p>
<ul>
<li>&#x548C; XML &#x5173;&#x7CFB;&#x6CA1;&#x90A3;&#x4E48;&#x7D27;(grpc &#x662F;&#x53EF;&#x63D2;&#x62D4;&#x5F0F;&#x7684;&#xFF0C;&#x53EF;&#x4EE5;&#x6362;&#x6210;&#x5404;&#x79CD;&#x5E95;&#x5C42;&#x8868;&#x8FF0;)</li>
<li>&#x5199;&#x8FC7; XML/XSD &#x7684;&#x4EBA;&#x90FD;&#x77E5;&#x9053;&#x8FD9;&#x4E9B;&#x670D;&#x52A1;&#x5B9A;&#x4E49;&#x592A;&#x7E41;&#x91CD;&#x4E86;&#xFF0C;gRPC &#x6CA1;&#x6709;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;</li>
<li>WSDL&#x8FD9;&#x7C7B;&#x6709;&#x5B8C;&#x5168;&#x4E0D;&#x5FC5;&#x8981;&#x7684;&#x590D;&#x6742;&#x5EA6;&#x3001;&#x548C;&#x57FA;&#x672C;&#x4E0D;&#x9700;&#x8981;&#x7684;&#x529F;&#x80FD;&#xFF08;&#x4E24;&#x6B65; commit&#xFF09;</li>
<li>WSDL &#x4E0D;&#x7075;&#x6D3B;&#x3001;&#x800C;&#x4E14;&#x65E0;&#x6CD5;&#x524D;&#x5411;&#x517C;&#x5BB9;&#xFF08;&#x4E0D;&#x50CF; <a href="https://developers.google.com/protocol-buffers/" target="_blank" rel="noopener">protobuf</a>&#xFF09;</li>
<li>SOAP/WSDL &#x6027;&#x80FD;&#x592A;&#x5DEE;&#xFF0C;&#x4EE5;&#x53CA;&#x65E0;&#x6CD5;&#x4F7F;&#x7528;&#x6D41;</li>
<li>&#x4F46;&#x662F;WSDL&#x4E2D;&#x7684;&#x673A;&#x5668;&#x53EF;&#x4EE5;&#x7406;&#x89E3;&#x7684;API&#x5B9A;&#x4E49;&#x786E;&#x5B9E;&#x662F;&#x4E2A;&#x597D;&#x4E1C;&#x897F;</li>
</ul>
<h3 id="shi-xian-ju-ti-de-cacheservice"><a href="#&#x5B9E;&#x73B0;&#x5177;&#x4F53;&#x7684;-CacheService" class="headerlink" title="&#x5B9E;&#x73B0;&#x5177;&#x4F53;&#x7684; CacheService"></a>&#x5B9E;&#x73B0;&#x5177;&#x4F53;&#x7684; CacheService <a href="#shi-xian-ju-ti-de-cacheservice" class="header-anchor">#</a></h3><p><strong>server.go</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> CacheService <span class="keyword">struct</span> {</span><br><span class="line">  store <span class="keyword">map</span>[<span class="keyword">string</span>][]<span class="keyword">byte</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *CacheService)</span> <span class="title">Get</span><span class="params">(ctx context.Context, req *rpc.GetReq)</span> <span class="params">(*rpc.GetResp, error)</span></span> {</span><br><span class="line">  val := s.store[req.Key]</span><br><span class="line">  <span class="keyword">return</span> &amp;rpc.GetResp{Val: val}, <span class="literal">nil</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *CacheService)</span> <span class="title">Store</span><span class="params">(ctx context.Context, req *rpc.StoreReq)</span> <span class="params">(*rpc.StoreResp, error)</span></span> {</span><br><span class="line">  s.store[req.Key] = req.Val</span><br><span class="line">  <span class="keyword">return</span> &amp;rpc.StoreResp{}, <span class="literal">nil</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x6CE8;&#x610F;&#x8FD9;&#x91CC;&#x6CA1;&#x6709;&#x9501;&#xFF0C;&#x4F60;&#x53EF;&#x4EE5;&#x60F3;&#x60F3;&#x4ED6;&#x4EEC;&#x4E2D;&#x6709;&#xFF0C;&#x56E0;&#x4E3A;&#x5C06;&#x6765;&#x4ED6;&#x4EEC;&#x4F1A;&#x88AB;&#x5E76;&#x53D1;&#x7684;&#x8C03;&#x7528;&#x7684;&#x3002;</p>
<h3 id="cuo-wu-chu-li"><a href="#&#x9519;&#x8BEF;&#x5904;&#x7406;" class="headerlink" title="&#x9519;&#x8BEF;&#x5904;&#x7406;"></a>&#x9519;&#x8BEF;&#x5904;&#x7406; <a href="#cuo-wu-chu-li" class="header-anchor">#</a></h3><p>&#x5F53;&#x7136;&#xFF0C;gRPC &#x652F;&#x6301;&#x9519;&#x8BEF;&#x5904;&#x7406;&#x3002;&#x5047;&#x8BBE;&#x6539;&#x5199;&#x4E0A;&#x9762;&#x7684; <code>Get()</code>&#xFF0C;&#x5BF9;&#x4E0D;&#x5B58;&#x5728;&#x7684;&#x952E;&#x8FDB;&#x884C;&#x62A5;&#x9519;&#xFF1A;</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *CacheService)</span> <span class="title">Get</span><span class="params">(ctx context.Context, req *rpc.GetReq)</span> <span class="params">(*rpc.GetResp, error)</span></span> {</span><br><span class="line">  val, ok := s.store[req.Key]</span><br><span class="line">  <span class="keyword">if</span> !ok {</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, status.Errorf(code.NotFound, <span class="string">&quot;Key not found %s&quot;</span>, req.Key)</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> &amp;rpc.GetResp{Val: val}, <span class="literal">nil</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="jia-mi-chuan-shu"><a href="#&#x52A0;&#x5BC6;&#x4F20;&#x8F93;" class="headerlink" title="&#x52A0;&#x5BC6;&#x4F20;&#x8F93;"></a>&#x52A0;&#x5BC6;&#x4F20;&#x8F93; <a href="#jia-mi-chuan-shu" class="header-anchor">#</a></h3><p>&#x5982;&#x679C;&#x8FD9;&#x6837;&#x7684;&#x4EE3;&#x7801;&#x6253;&#x7B97;&#x53BB;&#x90E8;&#x7F72;&#x7684;&#x8BDD;&#xFF0C;&#x4E00;&#x5B9A;&#x4F1A;&#x88AB; <a href="https://en.wikipedia.org/wiki/Site_reliability_engineering" target="_blank" rel="noopener">SRE</a> &#x62E6;&#x622A;&#x4E0B;&#x6765;&#xFF0C;&#x56E0;&#x4E3A;&#x6240;&#x6709;&#x901A;&#x8BAF;&#x5FC5;&#x987B;&#x52A0;&#x5BC6;&#x4F20;&#x8F93;&#x3002;</p>
<p>&#x5728; gRPC &#x4E2D;&#x6DFB;&#x52A0; TLS &#x52A0;&#x5BC6;&#x4F20;&#x8F93;&#x5F88;&#x5BB9;&#x6613;&#x3002;&#x6BD4;&#x5982;&#x6211;&#x4EEC;&#x4FEE;&#x6539; <code>runServer()</code> &#x6DFB;&#x52A0; TLS &#x52A0;&#x5BC6;&#x4F20;&#x8F93;&#x3002;</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">runServer</span><span class="params">()</span> <span class="title">error</span></span> {</span><br><span class="line">  tlsCreds, err := credentials.NewServerTLSFromFile(<span class="string">&quot;tls.crt&quot;</span>, <span class="string">&quot;tls.key&quot;</span>)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">  }</span><br><span class="line">  srv := grpc.NewServer(grpc.Creds(tlsCreds))</span><br><span class="line">  ...</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x540C;&#x6837;&#xFF0C;&#x6211;&#x4EEC;&#x4E5F;&#x9700;&#x8981;&#x4FEE;&#x6539;&#x4E00;&#x4E0B; <code>runClient()</code>&#x3002;</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">runClient</span><span class="params">()</span> <span class="title">error</span></span> {</span><br><span class="line">  tlsCreds := credentials.NewTLS(&amp;tls.Config(InsecureSkipVerify: <span class="literal">true</span>))</span><br><span class="line">  conn, err := grpc.Dial(<span class="string">&quot;localhost:5051&quot;</span>, grpc.WithTransportCredentials(tlsCreds))</span><br><span class="line">  ...</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h2 id="sheng-chan-huan-jing-ru-he-shi-yong-grpc"><a href="#&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x5982;&#x4F55;&#x4F7F;&#x7528;-gRPC" class="headerlink" title="&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x5982;&#x4F55;&#x4F7F;&#x7528; gRPC"></a>&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x5982;&#x4F55;&#x4F7F;&#x7528; gRPC <a href="#sheng-chan-huan-jing-ru-he-shi-yong-grpc" class="header-anchor">#</a></h2><ul>
<li>HTTP/2</li>
<li>protobuf serialization (pluggable)</li>
<li>&#x5BA2;&#x6237;&#x7AEF;&#x4F1A;&#x548C; grpc &#x670D;&#x52A1;&#x5668;&#x6253;&#x5F00;&#x4E00;&#x4E2A;&#x957F;&#x8FDE;&#x63A5;<ul>
<li>&#x5BF9;&#x4E8E;&#x6BCF;&#x4E00;&#x4E2A; RPC &#x8C03;&#x7528;&#x90FD;&#x5C06;&#x662F;&#x4E00;&#x4E2A;&#x65B0;&#x7684; HTTP/2 stream</li>
<li>&#x5141;&#x8BB8;&#x6A21;&#x62DF;&#x98DE;&#x884C;&#x6A21;&#x5F0F;&#x7684; RPC &#x8C03;&#x7528;</li>
</ul>
</li>
<li>&#x5141;&#x8BB8;&#x5BA2;&#x6237;&#x7AEF;<em>&#x548C;</em>&#x670D;&#x52A1;&#x7AEF; Streaming</li>
</ul>
<h3 id="grpc-de-shi-xian"><a href="#gRPC-&#x7684;&#x5B9E;&#x73B0;" class="headerlink" title="gRPC &#x7684;&#x5B9E;&#x73B0;"></a>gRPC &#x7684;&#x5B9E;&#x73B0; <a href="#grpc-de-shi-xian" class="header-anchor">#</a></h3><p>&#x73B0;&#x5728;&#x6709;3&#x4E2A;&#x9AD8;&#x6027;&#x80FD;&#x7684;&#x3001;&#x4E8B;&#x4EF6;&#x9A71;&#x52A8;&#x7684;&#x5B9E;&#x73B0;</p>
<ul>
<li>C<ul>
<li>Ruby, Python, Node.js, PHP, C#, Objective-C, C++ &#x90FD;&#x662F;&#x5BF9;&#x8FD9;&#x4E2A; C core &#x5B9E;&#x73B0;&#x7684;&#x7ED1;&#x5B9A;</li>
<li>PHP &#x5219;&#x662F;&#x901A;&#x8FC7; PECL &#x548C;&#x8FD9;&#x4E2A;&#x5B9E;&#x73B0;&#x7684;&#x7ED1;&#x5B9A;</li>
</ul>
</li>
<li>Java<ul>
<li>Netty + BoringSSL &#x901A;&#x8FC7; JNI</li>
</ul>
</li>
<li>Go<ul>
<li>&#x7EAF; Go &#x5B9E;&#x73B0;&#xFF0C;&#x4F7F;&#x7528;&#x4E86; Go &#x6807;&#x51C6;&#x5E93;&#x7684; <code>crypto/tls</code></li>
</ul>
</li>
</ul>
<h3 id="grpc-cong-na-lai-de"><a href="#gRPC-&#x4ECE;&#x54EA;&#x6765;&#x7684;" class="headerlink" title="gRPC &#x4ECE;&#x54EA;&#x6765;&#x7684;"></a>gRPC &#x4ECE;&#x54EA;&#x6765;&#x7684; <a href="#grpc-cong-na-lai-de" class="header-anchor">#</a></h3><ul>
<li>&#x6700;&#x521D;&#x662F; Google &#x7684;&#x4E00;&#x4E2A;&#x56E2;&#x961F;&#x521B;&#x5EFA;&#x7684;</li>
<li>&#x66F4;&#x65E9;&#x671F;&#x7684;&#x662F; Google &#x4E00;&#x4E2A;&#x5185;&#x90E8;&#x9879;&#x76EE;&#x53EB;&#x505A; <code>stubby</code></li>
<li>&#x8FD9;&#x4E2A; gRPC &#x662F;&#x5176;&#x4E0B;&#x4E00;&#x4EE3;&#x5F00;&#x6E90;&#x9879;&#x76EE;&#xFF0C;&#x5E76;&#x4E14;&#x73B0;&#x5728;&#x4E0D;&#x4EC5;&#x4EC5;&#x662F; Google &#x5728;&#x4F7F;&#x7528;&#xFF0C;&#x5F88;&#x591A;&#x516C;&#x53F8;&#x90FD;&#x5728;&#x8D21;&#x732E;&#x4EE3;&#x7801;<ul>
<li>&#x5F53;&#x7136;&#xFF0C;Google &#x8FD8;&#x662F;&#x4E3B;&#x8981;&#x4EE3;&#x7801;&#x8D21;&#x732E;&#x8005;</li>
</ul>
</li>
</ul>
<h3 id="sheng-chan-huan-jing-an-li-duo-zu-hu"><a href="#&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;&#x591A;&#x79DF;&#x6237;" class="headerlink" title="&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;&#x591A;&#x79DF;&#x6237;"></a>&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;&#x591A;&#x79DF;&#x6237; <a href="#sheng-chan-huan-jing-an-li-duo-zu-hu" class="header-anchor">#</a></h3><p>&#x4E0A;&#x7EBF;&#x751F;&#x4EA7;&#x540E;&#xFF0C;&#x53D1;&#x73B0;&#x6709;&#x4E00;&#x90E8;&#x5206;&#x5BA2;&#x6237;&#x4EA7;&#x751F;&#x4E86;&#x5927;&#x91CF;&#x7684;&#x952E;&#x503C;&#xFF0C;&#x8BE2;&#x95EE;&#x5F97;&#x77E5;&#xFF0C;&#x6709;&#x7684;&#x5BA2;&#x6237;&#x5E0C;&#x671B;&#x5BF9;&#x6240;&#x6709;&#x4E1C;&#x897F;&#x90FD;&#x7F13;&#x5B58;&#xFF0C;&#x8FD9;&#x663E;&#x7136;&#x4E0D;&#x662F;&#x5BF9;&#x6211;&#x4EEC;&#x8FD9;&#x4E2A;&#x7F13;&#x5B58;&#x670D;&#x52A1;&#x5F88;&#x597D;&#x7684;&#x4E8B;&#x60C5;&#x3002;</p>
<p>&#x6211;&#x4EEC;&#x5E0C;&#x671B;&#x9650;&#x5236;&#x8FD9;&#x79CD;&#x884C;&#x4E3A;&#xFF0C;&#x4F46;&#x5BF9;&#x4E8E;&#x5F53;&#x524D;&#x7CFB;&#x7EDF;&#x800C;&#x8A00;&#xFF0C;&#x65E0;&#x6CD5;&#x6EE1;&#x8DB3;&#x8FD9;&#x79CD;&#x9700;&#x6C42;&#xFF0C;&#x56E0;&#x6B64;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x4FEE;&#x6539;&#x5B9E;&#x73B0;&#xFF0C;&#x5BF9;&#x6BCF;&#x4E2A;&#x5BA2;&#x6237;&#x53D1;&#x653E;&#x5BA2;&#x6237; token&#xFF0C;&#x90A3;&#x4E48;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x7EA6;&#x675F;&#x7279;&#x5B9A;&#x5BA2;&#x6237;&#x6700;&#x591A;&#x53EF;&#x4EE5;&#x5EFA;&#x7ACB;&#x591A;&#x5C11;&#x952E;&#x503C;&#xFF0C;&#x907F;&#x514D;&#x7CFB;&#x7EDF;&#x6EE5;&#x7528;&#x3002;&#x8FD9;&#x5C31;&#x6210;&#x4E3A;&#x4E86;&#x591A;&#x79DF;&#x6237;&#x7684;&#x7F13;&#x5B58;&#x670D;&#x52A1;&#x3002;</p>
<p>&#x548C;&#x4E4B;&#x524D;&#x4E00;&#x6837;&#xFF0C;&#x6211;&#x4EEC;&#x8FD8;&#x662F;&#x4ECE; IDL &#x5F00;&#x59CB;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x4FEE;&#x6539;&#x63A5;&#x53E3;&#xFF0C;&#x589E;&#x52A0; <code>account_token</code> &#x9879;&#x3002;</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">StoreReq</span> </span>{</span><br><span class="line">  <span class="built_in">string</span> key = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">bytes</span> val = <span class="number">2</span>;</span><br><span class="line">  <span class="built_in">string</span> account_token = <span class="number">3</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x540C;&#x6837;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x6709;&#x72EC;&#x7ACB;&#x7684;&#x670D;&#x52A1;&#x9488;&#x5BF9;&#x8D26;&#x6237;&#x670D;&#x52A1;&#xFF0C;&#x6765;&#x83B7;&#x53D6;&#x8D26;&#x6237;&#x6240;&#x5141;&#x8BB8;&#x7684;&#x7F13;&#x5B58;&#x952E;&#x6570;&#xFF1A;</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">service</span> <span class="title">Accounts</span> </span>{</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> GetByToken(GetByTokenReq) return (GetByTokenResp) {}</span></span><br><span class="line"><span class="function">}</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">message GetByTokenReq {</span></span><br><span class="line"><span class="function">  string token = 1</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">GetByTokenResp</span> </span>{</span><br><span class="line">  Account account = <span class="number">1</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Account</span> </span>{</span><br><span class="line">  <span class="built_in">int64</span> max_cache_keys = <span class="number">1</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x91CC;&#x5EFA;&#x7ACB;&#x4E86;&#x4E00;&#x4E2A;&#x65B0;&#x7684; <code>Accounts</code> &#x670D;&#x52A1;&#xFF0C;&#x5E76;&#x4E14;&#x6709;&#x4E00;&#x4E2A; <code>GetByToken()</code> &#x65B9;&#x6CD5;&#xFF0C;&#x7ED9;&#x5165; <code>token</code>&#xFF0C;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A; <code>Account</code> &#x7C7B;&#x578B;&#x7684;&#x7ED3;&#x679C;&#xFF0C;&#x800C; <code>Account</code> &#x5185;&#x6709; <code>max_cache_keys</code> &#x952E;&#x5BF9;&#x5E94;&#x6700;&#x5927;&#x53EF;&#x7F13;&#x5B58;&#x7684;&#x952E;&#x503C;&#x6570;&#x3002;</p>
<p>&#x73B0;&#x5728;&#x6211;&#x4EEC;&#x8FDB;&#x4E00;&#x6B65;&#x4FEE;&#x6539; <strong>client.go</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">runClient</span><span class="params">()</span> <span class="title">error</span></span> {</span><br><span class="line">  ...</span><br><span class="line">  cache := rpc.NewCacheClient(conn)</span><br><span class="line"></span><br><span class="line">  _, err = cache.Store(context.Background(), &amp;rpc.StoreReq{</span><br><span class="line">    AccountToken: <span class="string">&quot;inconshreveable&quot;</span>,</span><br><span class="line">    Key:          <span class="string">&quot;gopher&quot;</span>,</span><br><span class="line">    Val:          []<span class="keyword">byte</span>(<span class="string">&quot;con&quot;</span>),</span><br><span class="line">  })</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">    <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to store: %v&quot;</span>, err)</span><br><span class="line">  }</span><br><span class="line">  ...</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x670D;&#x52A1;&#x7AEF;&#x7684;&#x6539;&#x53D8;&#x8981;&#x7A0D;&#x5FAE;&#x5927;&#x4E00;&#x4E9B;&#xFF0C;&#x4F46;&#x4E0D;&#x8FC7;&#x5206;&#x3002;</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> CacheService <span class="keyword">struct</span> {</span><br><span class="line">  accounts      rpc.AccountsClient</span><br><span class="line">  store         <span class="keyword">map</span>[<span class="keyword">string</span>][]<span class="keyword">byte</span></span><br><span class="line">  keysByAccount <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int64</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x6CE8;&#x610F;&#x8FD9;&#x91CC;&#x7684; <code>accounts</code> &#x662F;&#x4E00;&#x4E2A; grpc &#x7684;&#x5BA2;&#x6237;&#x7AEF;&#xFF0C;&#x56E0;&#x4E3A;&#x6211;&#x4EEC;&#x8FD9;&#x4E2A;&#x670D;&#x52A1;&#xFF0C;&#x540C;&#x65F6;&#x4E5F;&#x662F;&#x53E6;&#x4E00;&#x4E2A; grpc &#x670D;&#x52A1;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x3002;&#x6240;&#x4EE5;&#x5728;&#x63A5;&#x4E0B;&#x6765;&#x7684; <code>Store()</code> &#x5B9E;&#x73B0;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5148;&#x901A;&#x8FC7; <code>accounts</code> &#x8C03;&#x7528;&#x53E6;&#x4E00;&#x4E2A;&#x670D;&#x52A1;&#x53D6;&#x5F97;&#x8D26;&#x6237;&#x4FE1;&#x606F;&#x3002;</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *CacheService)</span> <span class="title">Store</span><span class="params">(ctx context.Context, req *rpc.StoreReq)</span> <span class="params">(*rpc.StoreResp, error)</span></span> {</span><br><span class="line">  <span class="comment">//  &#x8C03;&#x7528;&#x53E6;&#x4E00;&#x4E2A;&#x670D;&#x52A1;&#x53D6;&#x5F97;&#x8D26;&#x6237;&#x4FE1;&#x606F;&#xFF0C;&#x5305;&#x542B;&#x5176;&#x952E;&#x503C;&#x9650;&#x5236;</span></span><br><span class="line">  resp, err := s.accounts.GetByToken(context.Background(), &amp;rpc.GetByTokenReq{</span><br><span class="line">    Token: req.AccountToken,</span><br><span class="line">  })</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">//  &#x68C0;&#x67E5;&#x662F;&#x5426;&#x8D85;&#x91CF;&#x4F7F;&#x7528;</span></span><br><span class="line">  <span class="keyword">if</span> s.keysByAccount[req.AccountToken] &gt;= resp.Account.MaxCacheKeys {</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, status.Errorf(codes.FailedPrecondition, <span class="string">&quot;Account %s exceeds max key limit %d&quot;</span>, req.AccountToken, resp.Account.MaxCacheKeys)</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">//  &#x5982;&#x679C;&#x952E;&#x4E0D;&#x5B58;&#x5728;&#xFF0C;&#x9700;&#x8981;&#x65B0;&#x52A0;&#x952E;&#x503C;&#xFF0C;&#x90A3;&#x4E48;&#x6211;&#x4EEC;&#x5C31;&#x5BF9;&#x8BA1;&#x6570;&#x5668;&#x52A0;&#x4E00;</span></span><br><span class="line">  <span class="keyword">if</span> _, ok := s.store[req.Key]; !ok {</span><br><span class="line">    s.keysByAccount[req.AccountToken] += <span class="number">1</span></span><br><span class="line">  }</span><br><span class="line">  <span class="comment">//  &#x4FDD;&#x5B58;&#x952E;&#x503C;</span></span><br><span class="line">  s.store[req.Key] = req.Val</span><br><span class="line">  <span class="keyword">return</span> &amp;rpc.StoreResp{}, <span class="literal">nil</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="sheng-chan-huan-jing-an-li-xing-neng"><a href="#&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;&#x6027;&#x80FD;" class="headerlink" title="&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;&#x6027;&#x80FD;"></a>&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;&#x6027;&#x80FD; <a href="#sheng-chan-huan-jing-an-li-xing-neng" class="header-anchor">#</a></h3><p>&#x4E0A;&#x9762;&#x7684;&#x95EE;&#x9898;&#x89E3;&#x51B3;&#x4E86;&#xFF0C;&#x6211;&#x4EEC;&#x670D;&#x52A1;&#x53C8;&#x6062;&#x590D;&#x4E86;&#x6B63;&#x5E38;&#xFF0C;&#x4E0D;&#x4F1A;&#x6709;&#x7528;&#x6237;&#x5EFA;&#x7ACB;&#x8FC7;&#x591A;&#x7684;&#x952E;&#x503C;&#x4E86;&#x3002;&#x4F46;&#x662F;&#x5F88;&#x5FEB;&#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x53C8;&#x6536;&#x5230;&#x4E86;&#x5176;&#x4ED6;&#x7528;&#x6237;&#x53D1;&#x6765;&#x7684;&#x65B0;&#x7684; issue&#xFF0C;&#x5F88;&#x591A;&#x4EBA;&#x53CD;&#x5E94;&#x8BF4;&#x65B0;&#x7CFB;&#x7EDF;&#x53D8;&#x6162;&#x4E86;&#xFF0C;&#x6CA1;&#x6709;&#x8FBE;&#x5230; <a href="https://en.wikipedia.org/wiki/Service-level_agreement" target="_blank" rel="noopener">SLA</a> &#x7684;&#x8981;&#x6C42;&#x3002;</p>
<p>&#x53EF;&#x662F;&#x6211;&#x4EEC;&#x6839;&#x672C;&#x4E0D;&#x77E5;&#x9053;&#x5230;&#x5E95;&#x53D1;&#x751F;&#x4E86;&#x4EC0;&#x4E48;&#xFF0C;&#x4E8E;&#x662F;&#x610F;&#x8BC6;&#x5230;&#x4E86;&#xFF0C;&#x6211;&#x4EEC;&#x7684;&#x7A0B;&#x5E8F;&#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x53EF;&#x89C2;&#x5BDF;&#x6027;&#xFF08;Observability&#xFF09;&#xFF0C;&#x6362;&#x53E5;&#x8BDD;&#x8BF4;&#xFF0C;&#x6211;&#x4EEC;&#x7684;&#x7A0B;&#x5E8F;&#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x8BA1;&#x91CF;&#x7CFB;&#x7EDF;&#x6765;&#x7EDF;&#x8BA1;&#x6027;&#x80FD;&#x76F8;&#x5173;&#x7684;&#x6570;&#x636E;&#x3002;</p>
<p>&#x6211;&#x4EEC;&#x5148;&#x4ECE;&#x6700;&#x7B80;&#x5355;&#x7684;&#x505A;&#x8D77;&#xFF0C;&#x6DFB;&#x52A0;&#x65E5;&#x5FD7;&#x3002;</p>
<p>&#x6211;&#x4EEC;&#x5148;&#x4ECE; <strong>client.go</strong> &#x5F00;&#x59CB;&#xFF0C;&#x589E;&#x52A0;&#x4E00;&#x4E9B;&#x6D4B;&#x91CF;&#x548C;&#x8BA1;&#x6570;&#x4EE5;&#x53CA;&#x65E5;&#x5FD7;&#x8F93;&#x51FA;&#x3002;</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment">//  &#x5F00;&#x59CB;&#x8BA1;&#x65F6;</span></span><br><span class="line">start := time.Now()</span><br><span class="line"></span><br><span class="line">_, err = cache.Store(context.Background(), &amp;rpc.StoreReq{</span><br><span class="line">  AccountToken: <span class="string">&quot;inconshreveable&quot;</span>,</span><br><span class="line">  Key:          <span class="string">&quot;gopher&quot;</span>,</span><br><span class="line">  Val:          []<span class="keyword">byte</span>(<span class="string">&quot;con&quot;</span>),</span><br><span class="line">})</span><br><span class="line"></span><br><span class="line"><span class="comment">//  &#x8BA1;&#x7B97; cache.Store() &#x8C03;&#x7528;&#x65F6;&#x95F4;</span></span><br><span class="line">log.Printf(<span class="string">&quot;cache.Store duration %s&quot;</span>, time.Since(start))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">  <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to store: %v&quot;</span>, err)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//  &#x518D;&#x6B21;&#x5F00;&#x59CB;&#x8BA1;&#x65F6;</span></span><br><span class="line">start = time.Now()</span><br><span class="line"></span><br><span class="line"><span class="comment">//  &#x8C03;&#x7528; grpc &#x7684; get() &#x65B9;&#x6CD5;&#x53D6;&#x56DE;&#x952E;&#x4E3A; `gopher` &#x7684;&#x503C;</span></span><br><span class="line">resp, err := cache.Get(context.Background(), &amp;rpc.GetReq{Key: <span class="string">&quot;gopher&quot;</span>})</span><br><span class="line"></span><br><span class="line"><span class="comment">//  &#x8BA1;&#x7B97; cache.Get() &#x8C03;&#x7528;&#x65F6;&#x95F4;</span></span><br><span class="line">log.Printf(<span class="string">&quot;cache.Get duration %s&quot;</span>, time.Since(start))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">  <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to get: %v&quot;</span>, err)</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x540C;&#x6837;&#xFF0C;&#x5728;&#x670D;&#x52A1;&#x7AEF;&#x4E5F;&#x8FD9;&#x4E48;&#x5904;&#x7406;&#x3002;</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *CacheService)</span> <span class="title">Store</span><span class="params">(ctx context.Context, req *rpc.StoreReq)</span> <span class="params">(*rpc.StoreResp, error)</span></span> {</span><br><span class="line">  <span class="comment">//  &#x5F00;&#x59CB;&#x8BA1;&#x65F6;</span></span><br><span class="line">  start := time.Now()</span><br><span class="line"></span><br><span class="line">  <span class="comment">//  &#x8C03;&#x7528;&#x53E6;&#x4E00;&#x4E2A;&#x670D;&#x52A1;&#x53D6;&#x5F97;&#x8D26;&#x6237;&#x4FE1;&#x606F;&#xFF0C;&#x5305;&#x542B;&#x5176;&#x952E;&#x503C;&#x9650;&#x5236;</span></span><br><span class="line">  resp, err := s.accounts.GetByToken(context.Background(), &amp;rpc.GetByTokenReq{</span><br><span class="line">    Token: req.AccountToken,</span><br><span class="line">  })</span><br><span class="line"></span><br><span class="line">  <span class="comment">//  &#x8F93;&#x51FA; account.GetByToken() &#x7684;&#x8C03;&#x7528;&#x65F6;&#x95F4;</span></span><br><span class="line">  log.Printf(<span class="string">&quot;accounts.GetByToken duration %s&quot;</span>, time.Since(start))</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x7ECF;&#x8FC7;&#x8FD9;&#x4E9B;&#x4FEE;&#x6539;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x53D1;&#x73B0;&#x4E00;&#x6837;&#x7684;&#x4E8B;&#x60C5;&#x5728;&#x53CD;&#x53CD;&#x590D;&#x590D;&#x7684;&#x505A;&#xFF0C;&#x90A3;&#x4E48;&#x6709;&#x4EC0;&#x4E48;&#x529E;&#x6CD5;&#x53EF;&#x4EE5;&#x6539;&#x53D8;&#x8FD9;&#x79CD;&#x65E0;&#x804A;&#x7684;&#x505A;&#x6CD5;&#x4E48;&#xFF1F;&#x67E5;&#x9605; grpc &#x6587;&#x6863;&#x540E;&#xFF0C;&#x770B;&#x5230;&#x6709;&#x4E00;&#x4E2A;&#x53EB;&#x505A; <strong>Client Interceptor</strong> &#x7684;&#x4E1C;&#x897F;&#x3002;</p>
<p>&#x8FD9;&#x76F8;&#x5F53;&#x4E8E;&#x662F;&#x4E00;&#x4E2A;&#x4E2D;&#x95F4;&#x4EF6;&#xFF0C;&#x4F46;&#x662F;&#x662F;&#x5728;&#x5BA2;&#x6237;&#x7AEF;&#x3002;&#x5F53;&#x5BA2;&#x6237;&#x7AEF;&#x8FDB;&#x884C; rpc &#x8C03;&#x7528;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x8FD9;&#x4E2A;&#x4E2D;&#x95F4;&#x4EF6;&#x5148;&#x4F1A;&#x88AB;&#x8C03;&#x7528;&#xFF0C;&#x56E0;&#x6B64;&#x8FD9;&#x4E2A;&#x4E2D;&#x95F4;&#x4EF6;&#x53EF;&#x4EE5;&#x5BF9;&#x8C03;&#x7528;&#x8FDB;&#x884C;&#x4E00;&#x5C42;&#x5305;&#x88C5;&#xFF0C;&#x7136;&#x540E;&#x518D;&#x8FDB;&#x884C;&#x8C03;&#x7528;&#x3002;</p>
<p>&#x4E3A;&#x4E86;&#x5B9E;&#x73B0;&#x8FD9;&#x4E2A;&#x529F;&#x80FD;&#xFF0C;&#x6211;&#x4EEC;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x6587;&#x4EF6;&#xFF0C;&#x53EB;&#x505A; <code>interceptor.go</code>&#xFF1A;</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithClientInterceptor</span><span class="params">()</span> <span class="title">grpc</span>.<span class="title">DialOption</span></span> {</span><br><span class="line">  <span class="keyword">return</span> grpc.WithUnaryInterceptor(clientInterceptor)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">clientInterceptor</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  ctx context.Context,</span></span></span><br><span class="line"><span class="function"><span class="params">  method <span class="keyword">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  req <span class="keyword">interface</span>{},</span></span></span><br><span class="line"><span class="function"><span class="params">  reply <span class="keyword">interface</span>{},</span></span></span><br><span class="line"><span class="function"><span class="params">  cc *grpc.ClientConn,</span></span></span><br><span class="line"><span class="function"><span class="params">  invoker grpc.UnaryInvoker,</span></span></span><br><span class="line"><span class="function"><span class="params">  opts ...grpc.CallOption,</span></span></span><br><span class="line"><span class="function"><span class="params">)</span> <span class="title">error</span></span> {</span><br><span class="line">  start := time.Now()</span><br><span class="line">  err := invoker(ctx, method, req, reply, cc, opts...)</span><br><span class="line">  log.Printf(<span class="string">&quot;invoke remote method=%s duration=%s error=%v&quot;</span>, method, time.Since(start), err)</span><br><span class="line">  <span class="keyword">return</span> err</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x6211;&#x4EEC;&#x6709;&#x4E86;&#x8FD9;&#x4E2A; <code>WithClientInterceptor()</code> &#x4E4B;&#x540E;&#xFF0C;&#x53EF;&#x4EE5;&#x5728; <code>grpc.Dial()</code> &#x7684;&#x65F6;&#x5019;&#x6CE8;&#x518C;&#x8FDB;&#x53BB;&#x3002;</p>
<p><strong>client.go</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">runClient</span><span class="params">()</span> <span class="title">error</span></span> {</span><br><span class="line">  ...</span><br><span class="line">  conn, err := grpc.Dial(<span class="string">&quot;localhost:5051&quot;</span>,</span><br><span class="line">    grpc.WithTransportCredentials(tlsCreds),</span><br><span class="line">    WithClientInterceptor())</span><br><span class="line">  ...</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x6CE8;&#x518C;&#x4E4B;&#x540E;&#xFF0C;&#x6240;&#x6709;&#x7684; grpc &#x8C03;&#x7528;&#x90FD;&#x4F1A;&#x7ECF;&#x8FC7;&#x6211;&#x4EEC;&#x6CE8;&#x518C;&#x7684; <code>clientInterceptor()</code>&#xFF0C;&#x56E0;&#x6B64;&#x6240;&#x6709;&#x7684;&#x65F6;&#x95F4;&#x5C31;&#x90FD;&#x6709;&#x7EDF;&#x8BA1;&#x4E86;&#xFF0C;&#x800C;&#x4E0D;&#x7528;&#x6BCF;&#x4E2A;&#x51FD;&#x6570;&#x5185;&#x90E8;&#x53CD;&#x53CD;&#x590D;&#x590D;&#x7684;&#x6DFB;&#x52A0;&#x65F6;&#x95F4;&#x3001;&#x8BA1;&#x91CF;&#x3001;&#x8F93;&#x51FA;&#x3002;</p>
<p>&#x6DFB;&#x52A0;&#x4E86;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x8FD9;&#x4E2A;&#x8BA1;&#x91CF;&#x540E;&#xFF0C;&#x81EA;&#x7136;&#x800C;&#x7136;&#x5C31;&#x8054;&#x60F3;&#x5230;&#x670D;&#x52A1;&#x7AEF;&#x662F;&#x4E0D;&#x662F;&#x4E5F;&#x53EF;&#x4EE5;&#x505A;&#x540C;&#x6837;&#x7684;&#x4E8B;&#x60C5;&#xFF1F;&#x7ECF;&#x8FC7;&#x67E5;&#x770B;&#x6587;&#x6863;&#xFF0C;&#x53EF;&#x4EE5;&#xFF0C;&#x6709;&#x4E2A;&#x53EB;&#x505A; <strong>Server Interceptor</strong> &#x7684;&#x4E1C;&#x897F;&#x3002;</p>
<p>&#x540C;&#x6837;&#x7684;&#x505A;&#x6CD5;&#xFF0C;&#x6211;&#x4EEC;&#x5728;&#x670D;&#x52A1;&#x7AEF;&#x6DFB;&#x52A0; <code>interceptor.go</code>&#xFF0C;&#x5E76;&#x4E14;&#x6DFB;&#x52A0; <code>ServerInterceptor()</code> &#x51FD;&#x6570;&#x3002;</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ServerInterceptor</span><span class="params">()</span> <span class="title">grpc</span>.<span class="title">ServerOption</span></span> {</span><br><span class="line">  <span class="keyword">return</span> grpc.UnaryInterceptor(serverInterceptor)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">serverInterceptor</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  ctx context.Context,</span></span></span><br><span class="line"><span class="function"><span class="params">  req <span class="keyword">interface</span>{},</span></span></span><br><span class="line"><span class="function"><span class="params">  info *grpc.UnaryServerInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">  handler grpc.UnaryHandler,</span></span></span><br><span class="line"><span class="function"><span class="params">)</span> <span class="params">(<span class="keyword">interface</span>{}, error)</span></span> {</span><br><span class="line">  start := time.Now()</span><br><span class="line">  resp, err := handler(ctx, req)</span><br><span class="line">  log.Printf(<span class="string">&quot;invoke server method=%s duration=%s error=%v&quot;</span>,</span><br><span class="line">    info.FullMethod,</span><br><span class="line">    time.Since(start),</span><br><span class="line">    err)</span><br><span class="line">  <span class="keyword">return</span> resp, err</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x548C;&#x5BA2;&#x6237;&#x7AEF;&#x4E00;&#x6837;&#xFF0C;&#x9700;&#x8981;&#x5728; <code>runServer()</code> &#x7684;&#x65F6;&#x5019;&#x6CE8;&#x518C;&#x6211;&#x4EEC;&#x5B9A;&#x4E49;&#x7684;&#x8FD9;&#x4E2A;&#x4E2D;&#x95F4;&#x4EF6;&#x3002;</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">runServer</span><span class="params">()</span> <span class="title">error</span></span> {</span><br><span class="line">  ...</span><br><span class="line">  srv := grpc.NewServer(grpc.Creds(tlsCreds), ServerInterceptor())</span><br><span class="line">  ...</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="sheng-chan-huan-jing-an-li-chao-shi"><a href="#&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;&#x8D85;&#x65F6;" class="headerlink" title="&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;&#x8D85;&#x65F6;"></a>&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;&#x8D85;&#x65F6; <a href="#sheng-chan-huan-jing-an-li-chao-shi" class="header-anchor">#</a></h3><p>&#x6DFB;&#x52A0;&#x4E86;&#x65E5;&#x5FD7;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x7EC8;&#x4E8E;&#x5728;&#x65E5;&#x5FD7;&#x4E2D;&#x53D1;&#x73B0;&#xFF0C;<code>/rpc.Accounts/GetByToken/</code> &#x82B1;&#x4E86;&#x597D;&#x957F;&#x7684;&#x65F6;&#x95F4;&#x3002;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5BF9;&#x8FD9;&#x4E2A;&#x64CD;&#x4F5C;&#x8BBE;&#x7F6E;&#x8D85;&#x65F6;&#x3002;</p>
<p><strong>server.go</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *CacheService)</span> <span class="title">Store</span><span class="params">(ctx context.Context, req *rpc.StoreReq)</span> <span class="params">(*rpc.StoreResp, error)</span></span> {</span><br><span class="line">  accountsCtx, _ := context.WithTimeout(context.Background(), <span class="number">2</span> * time.Second)</span><br><span class="line">  resp, err := s.accounts.GetByToken(accountsCtx, &amp;rpc.GetByTokenReq{</span><br><span class="line">    Token: req.AccountToken,</span><br><span class="line">  })</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x91CC;&#x64CD;&#x4F5C;&#x5F88;&#x7B80;&#x5355;&#xFF0C;&#x76F4;&#x63A5;&#x4F7F;&#x7528;&#x6807;&#x51C6;&#x5E93;&#x4E2D; <code>context.WithTimeout()</code> &#x5C31;&#x53EF;&#x4EE5;&#x4E86;&#x3002;</p>
<h3 id="sheng-chan-huan-jing-an-li-shang-xia-wen-chuan-di"><a href="#&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;&#x4E0A;&#x4E0B;&#x6587;&#x4F20;&#x9012;" class="headerlink" title="&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;&#x4E0A;&#x4E0B;&#x6587;&#x4F20;&#x9012;"></a>&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;&#x4E0A;&#x4E0B;&#x6587;&#x4F20;&#x9012; <a href="#sheng-chan-huan-jing-an-li-shang-xia-wen-chuan-di" class="header-anchor">#</a></h3><p>&#x7ECF;&#x8FC7;&#x4E0A;&#x9762;&#x4FEE;&#x6539;&#x540E;&#xFF0C;&#x5BA2;&#x6237;&#x4F9D;&#x65E7;&#x62B1;&#x6028;&#x8BF4;&#x6CA1;&#x6709;&#x6EE1;&#x8DB3; SLA&#xFF0C;&#x4ED4;&#x7EC6;&#x4E00;&#x60F3;&#x4E5F;&#x5BF9;&#x3002;&#x5C31;&#x7B97;&#x8FD9;&#x91CC;&#x7EA6;&#x675F;&#x4E86; 2 &#x79D2;&#x949F;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x8C03;&#x7528;&#x8FD8;&#x9700;&#x8981;&#x65F6;&#x95F4;&#xFF0C;&#x522B;&#x7684;&#x4EE3;&#x7801;&#x5728;&#x4E2D;&#x95F4;&#x4E5F;&#x6709;&#x65F6;&#x95F4;&#x5F00;&#x9500;&#x3002;&#x800C;&#x4E14;&#x6709;&#x7684;&#x5BA2;&#x6237;&#x8BF4;&#xFF0C;&#x6211;&#x4EEC;&#x8FD9;&#x91CC;&#x9700;&#x8981;1&#x79D2;&#x949F;&#xFF0C;&#x800C;&#x4E0D;&#x662F;2&#x79D2;&#x949F;&#x3002;</p>
<p>&#x597D;&#x5427;&#xFF0C;&#x8BA9;&#x6211;&#x4EEC;&#x628A;&#x8FD9;&#x4E2A;&#x65F6;&#x95F4;&#x8BBE;&#x5B9A;&#x63A8;&#x5411;&#x8C03;&#x7528;&#x65B9;&#x3002;</p>
<p>&#x9996;&#x5148;&#x6211;&#x4EEC;&#x8981;&#x6C42;&#x5728;&#x5BA2;&#x6237;&#x7AEF;&#x8FDB;&#x884C;&#x8C03;&#x7528;&#x65F6;&#x95F4;&#x7EA6;&#x675F;&#x7684;&#x8BBE;&#x5B9A;&#xFF1A;</p>
<p><strong>client.go</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">runClient</span><span class="params">()</span> <span class="title">error</span></span> {</span><br><span class="line">  ...</span><br><span class="line">  ctx, _ := context.WithTimeout(context.Background(), time.Second)</span><br><span class="line">  _, err = cache.Store(ctx, &amp;rpc.StoreReq{Key: <span class="string">&quot;gopher&quot;</span>, Val: []<span class="keyword">byte</span>(<span class="string">&quot;con&quot;</span>)})</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  ctx, _ = context.WithTimeout(context.Background(), <span class="number">50</span>*time.Millisecond)</span><br><span class="line">  resp, err := cache.Get(ctx, &amp;rpc.GetReq{Key: <span class="string">&quot;gopher&quot;</span>})</span><br><span class="line">  ...</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x7136;&#x540E;&#x5728;&#x670D;&#x52A1;&#x7AEF;&#xFF0C;&#x6211;&#x4EEC;&#x5C06;&#x4E0A;&#x4E0B;&#x6587;&#x4F20;&#x9012;&#x3002;&#x76F4;&#x63A5;&#x53D6;&#x8C03;&#x7528;&#x65B9;&#x7684; <code>ctx</code>&#x3002;</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *CacheService)</span> <span class="title">Store</span><span class="params">(ctx context.Context, req *rpc.StoreReq)</span> <span class="params">(*rpc.StoreResp, error)</span></span> {</span><br><span class="line">  resp, err := s.accounts.GetByToken(ctx, &amp;rpc.GetByTokenReq{</span><br><span class="line">    Token: req.AccountToken,</span><br><span class="line">  })</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="sheng-chan-huan-jing-an-li-grpc-metadata"><a href="#&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;GRPC-Metadata" class="headerlink" title="&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;GRPC Metadata"></a>&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;GRPC Metadata <a href="#sheng-chan-huan-jing-an-li-grpc-metadata" class="header-anchor">#</a></h3><p>&#x4E0A;&#x9762;&#x7684;&#x95EE;&#x9898;&#x90FD;&#x89E3;&#x51B3;&#x4E86;&#xFF0C;&#x7EC8;&#x4E8E;&#x53EF;&#x4EE5;&#x677E;&#x4E00;&#x53E3;&#x6C14;&#x4E86;&#x3002;&#x53EF;&#x662F;&#x5BA2;&#x6237;&#x53C8;&#x63D0;&#x65B0;&#x7684;&#x9700;&#x6C42;&#x4E86;&#x2026;&#x2026;&#x1F605;&#xFF0C;&#x8BF4;&#x6211;&#x4EEC;&#x80FD;&#x4E0D;&#x80FD;&#x589E;&#x52A0;&#x4E00;&#x4E2A; <code>Dry Run</code> &#x7684;&#x6807;&#x5FD7;&#xFF0C;&#x5C31;&#x662F;&#x8BF4;&#x6211;&#x5E0C;&#x671B;&#x4F60;&#x505A;&#x6240;&#x6709;&#x9700;&#x8981;&#x505A;&#x7684;&#x4E8B;&#x60C5;&#xFF0C;&#x9664;&#x4E86;&#x771F;&#x7684;&#x4FEE;&#x6539;&#x952E;&#x503C;&#x5E93;&#x3002;</p>
<p>GRPC metadata&#xFF0C;&#x4E5F;&#x79F0;&#x4E3A; GRPC &#x7684; Header&#x3002;&#x5C31;&#x50CF; HTTP &#x5934;&#x4E00;&#x6837;&#xFF0C;&#x53EF;&#x4EE5;&#x6709;&#x4E00;&#x4E9B; Metadata &#x4FE1;&#x606F;&#x4F20;&#x9012;&#x8FC7;&#x6765;&#x3002;&#x4F7F;&#x7528; metadata&#xFF0C;&#x53EF;&#x4EE5;&#x8BA9;&#x6211;&#x4EEC;&#x7684; Dry Run &#x7684;&#x5B9E;&#x73B0;&#x53D8;&#x5F97;&#x66F4;&#x7B80;&#x6D01;&#xFF0C;&#x4E0D;&#x5FC5;&#x6BCF;&#x4E2A; RPC &#x65B9;&#x6CD5;&#x5185;&#x90FD;&#x5B9E;&#x73B0;&#x4E00;&#x904D;&#x68C0;&#x67E5; Dry Run &#x6807;&#x5FD7;&#x7684;&#x903B;&#x8F91;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x72EC;&#x7ACB;&#x51FA;&#x6765;&#x3002;</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *CacheService)</span> <span class="title">Store</span><span class="params">(ctx context.Context, req *rpc.StoreReq)</span> <span class="params">(*rpc.StoreResp, error)</span></span> {</span><br><span class="line">  resp, err := s.accounts.GetByToken(ctx, &amp;rpc.GetByTokenReq{</span><br><span class="line">    Token: req.AccountToken,</span><br><span class="line">  })</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> !dryRun(ctx) {</span><br><span class="line">    <span class="keyword">if</span> _, ok := s.store[req.Key]; !ok {</span><br><span class="line">      s.keysByAccount[req.AccountToke] += <span class="number">1</span></span><br><span class="line">    }</span><br><span class="line">    s.store[req.Key] = req.Val</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> &amp;rpc.StoreResp{}, <span class="literal">nil</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">dryRun</span><span class="params">(ctx context.Context)</span> <span class="title">bool</span></span> {</span><br><span class="line">  md, ok := metadata.FromContext(ctx)</span><br><span class="line">  <span class="keyword">if</span> !ok {</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  }</span><br><span class="line">  val, ok := md[<span class="string">&quot;dry-run&quot;</span>]</span><br><span class="line">  <span class="keyword">if</span> !ok {</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">len</span>(val) &lt; <span class="number">1</span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> val[<span class="number">0</span>] == <span class="string">&quot;1&quot;</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x5F53;&#x7136;&#xFF0C;&#x8FD9;&#x4E48;&#x505A;&#x662F;&#x6709;&#x59A5;&#x534F;&#x7684;&#xFF0C;&#x56E0;&#x4E3A;&#x901A;&#x7528;&#x5316;&#x540E;&#x5C31;&#x5931;&#x53BB;&#x4E86;&#x7C7B;&#x578B;&#x68C0;&#x67E5;&#x7684;&#x80FD;&#x529B;&#x3002;</p>
<p>&#x5728;&#x5BA2;&#x6237;&#x7AEF;&#x8C03;&#x7528;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5219;&#x9700;&#x8981;&#x6839;&#x636E;&#x60C5;&#x51B5;&#x6DFB;&#x52A0; <code>dry-run</code> &#x53C2;&#x6570;&#x7ED9; metadata&#x3002;</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">runClient</span><span class="params">()</span> <span class="title">error</span></span> {</span><br><span class="line">  ...</span><br><span class="line">  ctx, _ := context.WithTimeout(context.Background(), time.Second)</span><br><span class="line">  ctx = metadata.NewContext(ctx, metadata.Pairs(<span class="string">&quot;dry-run&quot;</span>, <span class="string">&quot;1&quot;</span>))</span><br><span class="line">  _, err = cache.Store(ctx, &amp;rpc.StoreReq{Key: <span class="string">&quot;gopher&quot;</span>, Val: []<span class="keyword">byte</span>(<span class="string">&quot;con&quot;</span>)})</span><br><span class="line">  ...</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="sheng-chan-huan-jing-an-li-retry"><a href="#&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;Retry" class="headerlink" title="&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;Retry"></a>&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;Retry <a href="#sheng-chan-huan-jing-an-li-retry" class="header-anchor">#</a></h3><p>&#x5B9E;&#x73B0;&#x4E86; Dry Run &#x4EE5;&#x4E3A;&#x53EF;&#x4EE5;&#x4F11;&#x606F;&#x4E86;&#xFF0C;&#x4E4B;&#x524D;&#x62B1;&#x6028;&#x6162;&#x7684;&#x5BA2;&#x6237;&#x53C8;&#x6765;&#x62B1;&#x6028;&#x4E86;&#xFF0C;&#x867D;&#x7136;&#x6709;&#x8D85;&#x65F6;&#x63A7;&#x5236;&#xFF0C;&#x6EE1;&#x8DB3; SLA&#xFF0C;&#x4F46;&#x662F;&#x670D;&#x52A1;&#x90A3;&#x8FB9;&#x8FD8;&#x662F;&#x6162;&#xFF0C;&#x603B;&#x8D85;&#x65F6;&#x4E0D;&#x6210;&#x529F;&#x3002;&#x68C0;&#x67E5;&#x4E86;&#x4E00;&#x4E0B;&#xFF0C;&#x53D1;&#x73B0;&#x662F;&#x7F51;&#x7EDC;&#x4E0A;&#x7684;&#x4E8B;&#x60C5;&#xFF0C;&#x6211;&#x4EEC;&#x6CA1;&#x6709;&#x592A;&#x591A;&#x53EF;&#x4EE5;&#x505A;&#x7684;&#x4E8B;&#x60C5;&#x3002;&#x4E3A;&#x4E86;&#x89E3;&#x51B3;&#x5BA2;&#x6237;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x6211;&#x4EEC;&#x6765;&#x6DFB;&#x52A0;&#x4E00;&#x4E2A;&#x91CD;&#x8BD5;&#x7684;&#x673A;&#x5236;&#x3002;</p>
<p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5BF9;&#x6BCF;&#x4E00;&#x4E2A; gRPC &#x8C03;&#x7528;&#x6DFB;&#x52A0;&#x4E00;&#x4E2A; Retry &#x673A;&#x5236;&#xFF0C;&#x6211;&#x4EEC;&#x4E5F;&#x53EF;&#x4EE5;&#x50CF;&#x4E4B;&#x524D;&#x8BA1;&#x65F6;&#x7EDF;&#x8BA1;&#x90A3;&#x6837;&#xFF0C;&#x4F7F;&#x7528; Interceptor &#x5427;&#xFF1F;</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">clientInterceptor</span><span class="params">(...)</span> <span class="title">error</span></span> {</span><br><span class="line">  <span class="keyword">var</span> (</span><br><span class="line">    start     = time.Now()</span><br><span class="line">    attempts  = <span class="number">0</span></span><br><span class="line">    err       error</span><br><span class="line">    backoff   retryBackOff</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> {</span><br><span class="line">    attempts += <span class="number">1</span></span><br><span class="line">    <span class="keyword">select</span> {</span><br><span class="line">    <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">      err = status.Errorf(codes.DeadlineExceeded, <span class="string">&quot;timeout reached before next retry attempt&quot;</span>)</span><br><span class="line">    <span class="keyword">case</span> &lt;-backoff.Next():</span><br><span class="line">      startAttempt := time.Now()</span><br><span class="line">      err = invoker(ctx, method, req, reply, cc, opts...)</span><br><span class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">        log.Printf(...)</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">break</span></span><br><span class="line">  }</span><br><span class="line">  log.Printf(...)</span><br><span class="line">  <span class="keyword">return</span> err</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x770B;&#x8D77;&#x6765;&#x8FD8;&#x4E0D;&#x9519;&#xFF0C;&#x7136;&#x540E;&#x5C31;&#x6253;&#x7B97;&#x53D1;&#x5E03;&#x8FD9;&#x4E2A;&#x4EE3;&#x7801;&#x4E86;&#x3002;&#x7ED3;&#x679C;&#x63D0;&#x4EA4;&#x5BA1;&#x6838;&#x7684;&#x65F6;&#x5019;&#x88AB;&#x6253;&#x56DE;&#x6765;&#x4E86;&#xFF0C;&#x8BF4;&#x8FD9;&#x4E2A;&#x4EE3;&#x7801;&#x4E0D;&#x5408;&#x7406;&#xFF0C;&#x56E0;&#x4E3A;&#x5982;&#x679C;&#x662F;<strong>&#x975E;&#x5E42;&#x7B49;&#xFF08;non-idempotent&#xFF09;</strong> &#x7684;&#x64CD;&#x4F5C;&#xFF0C;&#x8FD9;&#x6837;&#x5C31;&#x4F1A;&#x5BFC;&#x81F4;&#x591A;&#x6B21;&#x6267;&#x884C;&#xFF0C;&#x6539;&#x53D8;&#x671F;&#x671B;&#x7ED3;&#x679C;&#x4E86;&#x3002;</p>
<p>&#x770B;&#x6765;&#x6211;&#x4EEC;&#x5F97;&#x9488;&#x5BF9;&#x5E42;&#x7B49;&#x548C;&#x975E;&#x5E42;&#x7B49;&#x64CD;&#x4F5C;&#x533A;&#x522B;&#x5BF9;&#x5F85;&#x4E86;&#x3002;</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">silo.FireZeMissiles(NotIdempotent(ctx), req)</span><br></pre></td></tr></table></figure>
<p>&#x55EF;&#xFF0C;&#x5F53;&#x7136;&#xFF0C;&#x6CA1;&#x8FD9;&#x4E2A;&#x4E1C;&#x897F;&#x3002;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x81EA;&#x5DF1;&#x6765;&#x521B;&#x9020;&#x4E00;&#x4E2A;&#x6807;&#x8BB0;&#xFF0C;&#x901A;&#x8FC7; context&#xFF0C;&#x6765;&#x6807;&#x660E;&#x64CD;&#x4F5C;&#x662F;&#x5426;&#x5E42;&#x7B49;&#x3002;</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NotIdempotent</span><span class="params">(ctx context.Context)</span> <span class="title">context</span>.<span class="title">Context</span></span> {</span><br><span class="line">  <span class="keyword">return</span> context.WithValue(ctx, <span class="string">&quot;idempotent&quot;</span>, <span class="literal">false</span>)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">isIdempotent</span><span class="params">(ctx context.Context)</span> <span class="title">bool</span></span> {</span><br><span class="line">  val, ok := ctx.Value(<span class="string">&quot;idempotent&quot;</span>).(<span class="keyword">bool</span>)</span><br><span class="line">  <span class="keyword">if</span> !ok {</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> val</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x7136;&#x540E;&#x5728;&#x6211;&#x4EEC;&#x7684; <code>clientInterceptor()</code> &#x5B9E;&#x73B0;&#x4E2D;&#x52A0;&#x5165; <code>isIdempotent()</code> &#x5224;&#x65AD;&#xFF1A;</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">clientInterceptor</span><span class="params">(...)</span> <span class="title">error</span></span> {</span><br><span class="line">  <span class="keyword">var</span> (</span><br><span class="line">    start     = time.Now()</span><br><span class="line">    attempts  = <span class="number">0</span></span><br><span class="line">    err       error</span><br><span class="line">    backoff   retryBackOff</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> {</span><br><span class="line">    attempts += <span class="number">1</span></span><br><span class="line">    <span class="keyword">select</span> {</span><br><span class="line">    <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">      err = status.Errorf(codes.DeadlineExceeded, <span class="string">&quot;timeout reached before next retry attempt&quot;</span>)</span><br><span class="line">    <span class="keyword">case</span> &lt;-backoff.Next():</span><br><span class="line">      startAttempt := time.Now()</span><br><span class="line">      err = invoker(ctx, method, req, reply, cc, opts...)</span><br><span class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> &amp;&amp; isIdempotent(ctx) {</span><br><span class="line">        log.Printf(...)</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">break</span></span><br><span class="line">  }</span><br><span class="line">  log.Printf(...)</span><br><span class="line">  <span class="keyword">return</span> err</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x6837;&#x5F53;&#x8C03;&#x7528;&#x5931;&#x8D25;&#x540E;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x68C0;&#x67E5;&#x53D1;&#x73B0;&#x662F;&#x5E42;&#x7B49;&#x7684;&#x60C5;&#x51B5;&#xFF0C;&#x624D;&#x91CD;&#x8BD5;&#xFF0C;&#x5426;&#x5219;&#x4E0D;&#x91CD;&#x8BD5;&#x3002;&#x907F;&#x514D;&#x4E86;&#x975E;&#x5E42;&#x7B49;&#x64CD;&#x4F5C;&#x7684;&#x53CD;&#x590D;&#x64CD;&#x4F5C;&#x3002;</p>
<h3 id="sheng-chan-huan-jing-an-li-jie-gou-hua-cuo-wu"><a href="#&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;&#x7ED3;&#x6784;&#x5316;&#x9519;&#x8BEF;" class="headerlink" title="&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;&#x7ED3;&#x6784;&#x5316;&#x9519;&#x8BEF;"></a>&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;&#x7ED3;&#x6784;&#x5316;&#x9519;&#x8BEF; <a href="#sheng-chan-huan-jing-an-li-jie-gou-hua-cuo-wu" class="header-anchor">#</a></h3><p>&#x611F;&#x89C9;&#x6CA1;&#x5565;&#x95EE;&#x9898;&#x4E86;&#xFF0C;&#x4E8E;&#x662F;&#x90E8;&#x7F72;&#x4E0A;&#x7EBF;&#x4E86;&#x3002;&#x53EF;&#x662F;&#x8FD0;&#x884C;&#x4E00;&#x6BB5;&#x65F6;&#x95F4;&#x540E;&#xFF0C;&#x53D1;&#x73B0;&#x6709;&#x4E9B;&#x4E0D;&#x5BF9;&#x52B2;&#x3002;&#x6240;&#x6709;&#x6210;&#x529F;&#x7684;RPC&#x8C03;&#x7528;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x8FD9;&#x4E2A;&#x64CD;&#x4F5C;&#x672C;&#x8EAB;&#x662F;&#x6B63;&#x786E;&#x7684;&#xFF0C;&#x90FD;&#x6CA1;&#x6709;&#x95EE;&#x9898;&#xFF0C;&#x8D85;&#x65F6;&#x91CD;&#x8BD5;&#x4E5F;&#x6B63;&#x5E38;&#x3002;&#x4F46;&#x662F;&#x6240;&#x6709;&#x5931;&#x8D25;&#x7684; RPC &#x8C03;&#x7528;&#x90FD;&#x4E0D;&#x5BF9;&#x4E86;&#xFF0C;&#x6240;&#x6709;&#x5931;&#x8D25;&#x7684; RPC &#x8C03;&#x7528;&#xFF0C;&#x90FD;&#x8FD4;&#x56DE;&#x8D85;&#x65F6;&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x9519;&#x8BEF;&#x672C;&#x8EAB;&#x3002;&#x8FD9;&#x91CC;&#x8BF4;&#x7684;&#x5931;&#x8D25;&#xFF0C;&#x4E0D;&#x662F;&#x8BF4;&#x7F51;&#x7EDC;&#x95EE;&#x9898;&#x5BFC;&#x81F4;&#x8D85;&#x65F6;&#x5565;&#x7684;&#xFF0C;&#x800C;&#x662F;&#x8BF4;&#x8BF7;&#x6C42;&#x672C;&#x8EAB;&#x7684;&#x5931;&#x8D25;&#xFF0C;&#x6BD4;&#x5982;&#x4E4B;&#x524D;&#x63D0;&#x5230;&#x7684;&#xFF0C;<code>Get()</code> &#x4E0D;&#x5B58;&#x5728;&#x7684;&#x952E;&#xFF0C;&#x5E94;&#x8BE5;&#x8FD4;&#x56DE;&#x9519;&#x8BEF;&#xFF1B;&#x6216;&#x8005; <code>Store()</code> &#x8D85;&#x8FC7;&#x4E86;&#x914D;&#x989D;&#xFF0C;&#x5E94;&#x8BE5;&#x8FD4;&#x56DE;&#x9519;&#x8BEF;&#xFF0C;&#x8FD9;&#x7C7B;&#x9519;&#x8BEF;&#x5728;&#x65E5;&#x5FD7;&#x4E2D;&#x90FD;&#x6CA1;&#x770B;&#x5230;&#xFF0C;&#x53CD;&#x800C;&#x90FD;&#x5BF9;&#x5E94;&#x4E86;&#x8D85;&#x65F6;&#x3002;</p>
<p>&#x7ECF;&#x8FC7;&#x5206;&#x6790;&#x53D1;&#x73B0;&#xFF0C;&#x670D;&#x52A1;&#x7AEF;&#x8BE5;&#x62A5;&#x9519;&#x90FD;&#x62A5;&#x9519;&#xFF0C;&#x6CA1;&#x5565;&#x95EE;&#x9898;&#xFF0C;&#x4F46;&#x662F;&#x5BA2;&#x6237;&#x7AEF;&#x4E0D;&#x5BF9;&#xFF0C;&#x672C;&#x5E94;&#x8BE5;&#x8FD4;&#x56DE;&#x9519;&#x8BEF;&#x7ED9;&#x8C03;&#x7528;&#x65B9;&#x7684;&#x5730;&#x65B9;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x4EE3;&#x7801;&#x53CD;&#x800C;&#x53C8;&#x5F00;&#x59CB;&#x91CD;&#x8BD5;&#x8FD9;&#x4E2A;&#x64CD;&#x4F5C;&#x4E86;&#x3002;&#x770B;&#x6765;&#x4E4B;&#x524D;&#x91CD;&#x8BD5;&#x7684;&#x4EE3;&#x7801;&#x8FD8;&#x6709;&#x95EE;&#x9898;&#x3002;</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">err = invoker(ctx, method, req, reply, cc, opts...)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &amp;&amp; isIdempotent(ctx) {</span><br><span class="line">  log.Printf(...)</span><br><span class="line">  <span class="keyword">continue</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x5982;&#x679C;&#x4ED4;&#x7EC6;&#x89C2;&#x5BDF;&#x8FD9;&#x90E8;&#x5206;&#x4EE3;&#x7801;&#xFF0C;&#x4F1A;&#x53D1;&#x73B0;&#xFF0C;&#x65E0;&#x8BBA; <code>err</code> &#x662F;&#x4EC0;&#x4E48;&#xFF0C;&#x53EA;&#x8981;&#x975E; <code>nil</code>&#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x91CD;&#x8BD5;&#x3002;&#x5176;&#x5B9E;&#x8FD9;&#x662F;&#x4E0D;&#x5BF9;&#x7684;&#xFF0C;&#x6211;&#x4EEC;&#x53EA;&#x6709;&#x9488;&#x5BF9;&#x67D0;&#x4E9B;&#x9519;&#x8BEF;&#x91CD;&#x8BD5;&#xFF0C;&#x6BD4;&#x5982;&#x7F51;&#x7EDC;&#x95EE;&#x9898;&#x4E4B;&#x7C7B;&#x7684;&#xFF0C;&#x800C;&#x4E0D;&#x5E94;&#x8BE5;&#x5BF9;&#x6211;&#x4EEC;&#x5E0C;&#x671B;&#x8FD4;&#x56DE;&#x7ED9;&#x8C03;&#x7528;&#x65B9;&#x7684;&#x9519;&#x8BEF;&#x91CD;&#x8BD5;&#xFF0C;&#x90A3;&#x6CA1;&#x6709;&#x610F;&#x4E49;&#x3002;</p>
<p>&#x90A3;&#x4E48;&#x95EE;&#x9898;&#x5C31;&#x53D8;&#x6210;&#x4E86;&#xFF0C;&#x6211;&#x4EEC;&#x5230;&#x5E95;&#x5E94;&#x8BE5;&#x600E;&#x4E48;&#x5BF9; <code>err</code> &#x5224;&#x65AD;&#x6765;&#x51B3;&#x5B9A;&#x662F;&#x5426;&#x91CD;&#x8BD5;&#xFF1F;</p>
<ul>
<li>&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x4E0D;&#x540C;&#x7684; Error Code&#xFF0C;&#x7279;&#x5B9A;&#x7684; Code &#x9700;&#x8981; Retry&#xFF0C;&#x5176;&#x5B83;&#x7684;&#x4E0D;&#x9700;&#x8981;&#xFF0C;&#x90A3;&#x5C31;&#x9700;&#x8981;&#x81EA;&#x5B9A;&#x4E49; gRPC &#x9519;&#x8BEF;&#x7801;&#xFF1B;</li>
<li>&#x6211;&#x4EEC;&#x4E5F;&#x53EF;&#x4EE5;&#x5B9A;&#x4E49;&#x4E00;&#x4E2A; <code>Error</code> &#x7C7B;&#x578B;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x91CC;&#x9762;&#x5305;&#x542B;&#x4E86;&#x67D0;&#x79CD;&#x6807;&#x5FD7;&#x4F4D;&#xFF0C;&#x6765;&#x544A;&#x77E5;&#x662F;&#x5426;&#x503C;&#x5F97; retry</li>
<li>&#x6216;&#x8005;&#x5E72;&#x8106;&#x628A;&#x9519;&#x8BEF;&#x7801;&#x653E;&#x5230; Response &#x7684;&#x6D88;&#x606F;&#x91CC;&#xFF0C;&#x786E;&#x4FDD;&#x6BCF;&#x4E2A;&#x6D88;&#x606F;&#x90FD;&#x6709;&#x4E00;&#x4E2A;&#x6211;&#x4EEC;&#x5B9A;&#x4E49;&#x7684;&#x9519;&#x8BEF;&#x7801;&#xFF0C;&#x6765;&#x6807;&#x660E;&#x662F;&#x5426;&#x9700;&#x8981; retry&#x3002;</li>
</ul>
<p>&#x6240;&#x4EE5;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x7684;&#x662F;&#x4E00;&#x4E2A;&#x5B8C;&#x6574;&#x7684;&#x7ED3;&#x6784;&#x5316;&#x7684;&#x9519;&#x8BEF;&#x4FE1;&#x606F;&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x7B80;&#x5355;&#x7684;&#x4E00;&#x4E2A; Error Code &#x548C;&#x5B57;&#x7B26;&#x4E32;&#x3002;&#x5F53;&#x7136;&#x8FD9;&#x6761;&#x8DEF;&#x4E0D;&#x597D;&#x8D70;&#xFF0C;&#x4F46;&#x662F;&#x6211;&#x4EEC;&#x5DF2;&#x7ECF;&#x505A;&#x4E86;&#x8FD9;&#x4E48;&#x591A;&#x4E86;&#xFF0C;&#x575A;&#x6301;&#x4E00;&#x4E0B;&#x8FD8;&#x662F;&#x53EF;&#x4EE5;&#x514B;&#x670D;&#x7684;&#x3002;</p>
<p>&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x8FD8;&#x662F;&#x4ECE; IDL &#x5F00;&#x59CB;&#xFF1A;</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Error</span> </span>{</span><br><span class="line">  <span class="built_in">int64</span> code = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">string</span> messsage = <span class="number">2</span>;</span><br><span class="line">  <span class="built_in">bool</span> temporary = <span class="number">3</span>;</span><br><span class="line">  <span class="built_in">int64</span> userErrorCode = <span class="number">4</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x7136;&#x540E;&#x6211;&#x4EEC;&#x5B9E;&#x73B0;&#x8FD9;&#x4E2A; Error &#x7C7B;&#x578B;&#x3002;</p>
<p><strong>rpc/error.go</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *Error)</span> <span class="title">Error</span><span class="params">()</span> <span class="title">string</span></span> {</span><br><span class="line">  <span class="keyword">return</span> e.Message</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Errorf</span><span class="params">(code codes.Code, temporary <span class="keyword">bool</span>, msg <span class="keyword">string</span>, args ..<span class="keyword">interface</span>{})</span> <span class="title">error</span></span> {</span><br><span class="line">  <span class="keyword">return</span> &amp;Error{</span><br><span class="line">    Code:      <span class="keyword">int64</span>(code),</span><br><span class="line">    Message:   fmt.Sprintf(msg, args...),</span><br><span class="line">    Temporary: temporary,</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x6709;&#x8FD9;&#x4E24;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x663E;&#x793A;&#x548C;&#x6784;&#x9020;&#x8FD9;&#x4E2A; <code>Error</code> &#x7C7B;&#x578B;&#x7684;&#x53D8;&#x91CF;&#x4E86;&#xFF0C;&#x4F46;&#x662F;&#x6211;&#x4EEC;&#x8BE5;&#x600E;&#x4E48;&#x628A;&#x9519;&#x8BEF;&#x6D88;&#x606F;&#x4F20;&#x56DE;&#x5BA2;&#x6237;&#x7AEF;&#x5462;&#xFF1F;&#x7136;&#x540E;&#x95EE;&#x9898;&#x5C31;&#x5F00;&#x59CB;&#x53D8;&#x7684;&#x7E41;&#x7410;&#x8D77;&#x6765;&#x4E86;&#xFF1A;</p>
<p><strong>rpc/error.go</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MarshalError</span> <span class="params">(err error, ctx context.Context)</span> <span class="title">error</span></span> {</span><br><span class="line">  rerr, ok := err.(*Error)</span><br><span class="line">  <span class="keyword">if</span> !ok {</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">  }</span><br><span class="line">  pberr, marshalerr := pb.Marshal(rerr)</span><br><span class="line">  <span class="keyword">if</span> marshalerr == <span class="literal">nil</span> {</span><br><span class="line">    md := metadata.Pairs(<span class="string">&quot;rpc-error&quot;</span>, base64.StdEncoding.EncodeToString(pberr))</span><br><span class="line">    _ = grpc.SetTrailer(ctx, md)</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> status.Errorf(codes.Code(rerr.Code), rerr.Message)</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">UnmarshalError</span><span class="params">(err error, md metadata.MD)</span> *<span class="title">Error</span></span> {</span><br><span class="line">  vals, ok := md[<span class="string">&quot;rpc-error&quot;</span>]</span><br><span class="line">  <span class="keyword">if</span> !ok {</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">  }</span><br><span class="line">  buf, err := base64.StdEncoding.DecodeString(vals[<span class="number">0</span>])</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">var</span> rerr Error</span><br><span class="line">  <span class="keyword">if</span> err := pb.Unmarshal(buf, &amp;rerr); err != <span class="literal">nil</span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> &amp;rerr</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>interceptor.go</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">serverInterceptor</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  ctx context.Context,</span></span></span><br><span class="line"><span class="function"><span class="params">  req <span class="keyword">interface</span>{},</span></span></span><br><span class="line"><span class="function"><span class="params">  info *grpc.UnaryServerInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">  handler grpc.UnaryHandler,</span></span></span><br><span class="line"><span class="function"><span class="params">)</span> <span class="params">(<span class="keyword">interface</span>{}, error)</span></span> {</span><br><span class="line">  start := time.Now()</span><br><span class="line">  resp, err := handler(ctx, req)</span><br><span class="line">  err = rpc.MarshalError(err, ctx)</span><br><span class="line">  log.Print(...)</span><br><span class="line">  <span class="keyword">return</span> resp, err</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>it&#x2019;s ugly&#xFF0C;but works.</p>
<p>&#x8FD9;&#x662F;&#x5728; gRPC &#x4E0D;&#x652F;&#x6301;&#x9AD8;&#x7EA7; <code>Error</code> &#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x600E;&#x4E48;&#x53BB; work around &#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#xFF0C;&#x5E76;&#x4E14;&#x51D1;&#x5408;&#x7528;&#x8D77;&#x6765;&#x3002;&#x73B0;&#x5728;&#x8FD9;&#x4E48;&#x505A;&#xFF0C;&#x9519;&#x8BEF;&#x5C31;&#x53EF;&#x4EE5;&#x8DE8;&#x4E3B;&#x673A;&#x8FB9;&#x754C;&#x4F20;&#x9012;&#x4E86;&#x3002;</p>
<h3 id="sheng-chan-huan-jing-an-li-dump"><a href="#&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;Dump" class="headerlink" title="&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;Dump"></a>&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;Dump <a href="#sheng-chan-huan-jing-an-li-dump" class="header-anchor">#</a></h3><p>&#x53C8;&#x6709;&#x5BA2;&#x6237;&#x524D;&#x6765;&#x63D0;&#x9700;&#x6C42;&#x4E86;&#xFF0C;&#x6709;&#x7684;&#x5BA2;&#x6237;&#x8BF4;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5B58;&#x3001;&#x4E5F;&#x53EF;&#x4EE5;&#x53D6;&#xFF0C;&#x4F46;&#x662F;&#x5982;&#x4F55;&#x624D;&#x80FD;&#x628A;&#x91CC;&#x9762;&#x6240;&#x6709;&#x7684;&#x6570;&#x636E;&#x90FD;&#x83B7;&#x53D6;&#x4E0B;&#x6765;&#xFF1F;&#x4E8E;&#x662F;&#x6709;&#x4E86;&#x9700;&#x6C42;&#xFF0C;&#x5E0C;&#x671B;&#x5B9E;&#x73B0; <code>Dump()</code> &#x64CD;&#x4F5C;&#xFF0C;&#x53EF;&#x4EE5;&#x53D6;&#x56DE;&#x6240;&#x6709;&#x6570;&#x636E;&#x3002;</p>
<p>&#x73B0;&#x5728;&#x5DF2;&#x7ECF;&#x8F7B;&#x8F66;&#x719F;&#x8DEF;&#x4E86;&#xFF0C;&#x6211;&#x4EEC;&#x5148;&#x6539; IDL&#xFF0C;&#x6DFB;&#x52A0;&#x4E00;&#x4E2A; <code>Dump()</code> &#x51FD;&#x6570;&#x3002;</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">service Cache {</span><br><span class="line">  rpc Store(StoreReq) returns (StoreResp) {}</span><br><span class="line">  rpc Get(GetReq) returns (GetResp) {}</span><br><span class="line">  rpc Dump(DumpReq) returns (DumpResp) {}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">message DumpReq{</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">message DumpResp {</span><br><span class="line">  repeated DumpItem items = <span class="number">1</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">message DumpItem {</span><br><span class="line">  <span class="keyword">string</span> key = <span class="number">1</span>;</span><br><span class="line">  bytes val = <span class="number">2</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x91CC; <code>DumpResp</code> &#x91CC;&#x9762;&#x7528;&#x7684;&#x662F; <code>repeated</code>&#xFF0C;&#x56E0;&#x4E3A; protobuf &#x91CC;&#x9762;&#x4E0D;&#x77E5;&#x9053;&#x4E3A;&#x5565;&#x4E0D;&#x53EB; array&#x3002;</p>
<h3 id="sheng-chan-huan-jing-an-li-liu-liang-kong-zhi"><a href="#&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;&#x6D41;&#x91CF;&#x63A7;&#x5236;" class="headerlink" title="&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;&#x6D41;&#x91CF;&#x63A7;&#x5236;"></a>&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;&#x6D41;&#x91CF;&#x63A7;&#x5236; <a href="#sheng-chan-huan-jing-an-li-liu-liang-kong-zhi" class="header-anchor">#</a></h3><p>&#x65B0;&#x529F;&#x80FD; Dump &#x4E0A;&#x7EBF;&#x4E86;&#xFF0C;&#x7ED3;&#x679C;&#x53D1;&#x73B0;&#x5927;&#x5BB6;&#x90FD;&#x5F88;&#x559C;&#x6B22; Dump&#xFF0C;&#x6709;&#x5F88;&#x591A;&#x4EBA;&#x5728; Dump&#xFF0C;&#x7ED3;&#x679C;&#x670D;&#x52A1;&#x5668;&#x7684;&#x5185;&#x5B58;&#x5F00;&#x59CB;&#x4E0D;&#x591F;&#x4E86;&#x3002;&#x4E8E;&#x662F;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x4E00;&#x4E9B;&#x9650;&#x5236;&#x624B;&#x6BB5;&#xFF0C;&#x53EF;&#x4EE5;&#x63A7;&#x5236;&#x6D41;&#x91CF;&#x3002;</p>
<p>&#x67E5;&#x9605;&#x4E86;&#x6587;&#x6863;&#x540E;&#xFF0C;&#x53D1;&#x73B0;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x63A7;&#x5236;&#x540C;&#x65F6;&#x6700;&#x5927;&#x6709;&#x591A;&#x5C11;&#x5E76;&#x53D1;&#x53EF;&#x4EE5;&#x8BBF;&#x95EE;&#xFF0C;&#x4EE5;&#x53CA;&#x53EF;&#x4EE5;&#x591A;&#x9891;&#x7E41;&#x7684;&#x6765;&#x8BBF;&#x95EE;&#x670D;&#x52A1;&#x3002;</p>
<p><strong>server.go</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">runServer</span><span class="params">()</span> <span class="title">error</span></span> {</span><br><span class="line">  ...</span><br><span class="line">  srv := grpc.NewServer(grpc.Creds(tlsCreds),</span><br><span class="line">    ServerInterceptor(),</span><br><span class="line">    grpc.MaxConcurrentStreams(<span class="number">64</span>),</span><br><span class="line">    grpc.InTapHandle(NewTap().Handler))</span><br><span class="line">  rpc.RegisterCacheServer(srv, NewCacheService(accounts))</span><br><span class="line">  l, err := net.Listen(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;localhost:5051&quot;</span>)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">  }</span><br><span class="line">  l = netutil.LimitListener(l, <span class="number">1024</span>)</span><br><span class="line">  <span class="keyword">return</span> srv.Serve(l)</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x91CC;&#x4F7F;&#x7528;&#x4E86; <code>netutil.LimitListener(l, 1024)</code> &#x63A7;&#x5236;&#x4E86;&#x603B;&#x5171;&#x53EF;&#x4EE5;&#x6709;&#x591A;&#x5C11;&#x4E2A;&#x8FDE;&#x63A5;&#xFF0C;&#x7136;&#x540E;&#x7528; <code>grpc.MaxConcurrentStreams(64)</code> &#x6307;&#x5B9A;&#x4E86;&#x6BCF;&#x4E2A; grpc &#x7684;&#x8FDE;&#x63A5;&#x53EF;&#x4EE5;&#x6709;&#x591A;&#x5C11;&#x4E2A;&#x5E76;&#x53D1;&#x6D41;(stream)&#x3002;&#x8FD9;&#x4E24;&#x4E2A;&#x7ED3;&#x5408;&#x8D77;&#x6765;&#x57FA;&#x672C;&#x63A7;&#x5236;&#x4E86;&#x5E76;&#x53D1;&#x7684;&#x603B;&#x6570;&#x3002;</p>
<p>&#x4F46;&#x662F; gRPC &#x91CC;&#x6CA1;&#x6709;&#x5730;&#x65B9;&#x9650;&#x5B9A;&#x53EF;&#x4EE5;&#x591A;&#x9891;&#x7E41;&#x7684;&#x8BBF;&#x95EE;&#x3002;&#x56E0;&#x6B64;&#x8FD9;&#x91CC;&#x7528;&#x4E86; <code>grpc.InTapHandle(NewTap().Handler))</code> &#x6765;&#x8FDB;&#x884C;&#x5B9A;&#x5236;&#xFF0C;&#x8FD9;&#x662F;&#x5728;&#x66F4;&#x9760;&#x524D;&#x7684;&#x4F4D;&#x7F6E;&#x6267;&#x884C;&#x7684;&#x3002;</p>
<p><strong>tap.go</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Tap <span class="keyword">struct</span> {</span><br><span class="line">  lim *rate.Limiter</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewTap</span><span class="params">()</span> *<span class="title">Tap</span></span> {</span><br><span class="line">  <span class="keyword">return</span> &amp;Tap(rate.NewLimiter(<span class="number">150</span>, <span class="number">5</span>))</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *Tap)</span> <span class="title">Handler</span><span class="params">(ctx context.Context, info *tap.Info)</span> <span class="params">(context.Context, error)</span></span> {</span><br><span class="line">  <span class="keyword">if</span> !t.lim.Allow() {</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, status.Errorf(codes.ResourceExhausted, <span class="string">&quot;service is over rate limit&quot;</span>)</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> ctx, <span class="literal">nil</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="sheng-chan-huan-jing-an-li-streaming"><a href="#&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;Streaming" class="headerlink" title="&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;Streaming"></a>&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;Streaming <a href="#sheng-chan-huan-jing-an-li-streaming" class="header-anchor">#</a></h3><p>&#x4E4B;&#x524D;&#x7684;&#x65B9;&#x6848;&#x90E8;&#x7F72;&#x540E;&#xFF0C;&#x5185;&#x5B58;&#x7EC8;&#x4E8E;&#x964D;&#x4E0B;&#x6765;&#x4E86;&#xFF0C;&#x4F46;&#x662F;&#x8FD8;&#x6CA1;&#x4F11;&#x606F;&#xFF0C;&#x5C31;&#x53D1;&#x73B0;&#x5927;&#x5BB6;&#x8D8A;&#x6765;&#x8D8A;&#x559C;&#x6B22;&#x7528;&#x8FD9;&#x4E2A;&#x7F13;&#x5B58;&#x670D;&#x52A1;&#xFF0C;&#x5185;&#x5B58;&#x53C8;&#x4E0D;&#x591F;&#x7528;&#x4E86;&#x3002;&#x8FD9;&#x4E2A;&#x65F6;&#x5019;&#x6211;&#x4EEC;&#x5C31;&#x5F00;&#x59CB;&#x601D;&#x8003;&#xFF0C;&#x662F;&#x4E0D;&#x662F;&#x53EF;&#x4EE5;&#x8C03;&#x6574;&#x4E00;&#x4E0B;&#x8BBE;&#x8BA1;&#xFF0C;&#x4E0D;&#x662F;&#x6BCF;&#x6B21; Dump &#x5C31;&#x7ACB;&#x5373;&#x5728;&#x5185;&#x5B58;&#x751F;&#x6210;&#x5B8C;&#x6574;&#x7684;&#x8FD4;&#x56DE;&#x6570;&#x7EC4;&#xFF0C;&#x800C;&#x662F;&#x4EE5;&#x6D41;&#x7684;&#x5F62;&#x5F0F;&#xFF0C;&#x6309;&#x9700;&#x53D1;&#x56DE;&#x3002;</p>
<p><strong>app.proto</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"><span class="keyword">package</span> rpc;</span><br><span class="line"></span><br><span class="line">service Cache {</span><br><span class="line">  rpc Store(StoreReq) returns (StoreResp) {}</span><br><span class="line">  rpc Get(GetReq) returns (GetResp) {}</span><br><span class="line">  rpc Dump(DumpReq) returns (stream DumpItem) {}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">message DumpReq{</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">message DumpItem {</span><br><span class="line">  <span class="keyword">string</span> key = <span class="number">1</span>;</span><br><span class="line">  bytes val = <span class="number">2</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x91CC;&#x4E0D;&#x518D;&#x4F7F;&#x7528;&#x6570;&#x7EC4;&#x6027;&#x8D28;&#x7684; <code>repeated</code>&#xFF0C;&#x800C;&#x662F;&#x7528; <code>stream</code>&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x8BF7;&#x6C42; <code>Dump()</code> &#x540E;&#xFF0C;&#x5C06;&#x7ED3;&#x679C;&#x4EE5;&#x6D41;&#x7684;&#x5F62;&#x5F0F;&#x53D1;&#x56DE;&#x53BB;&#x3002;</p>
<p><strong>server.go</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *CacheService)</span> <span class="title">Dump</span><span class="params">(req *rpc.DumpReq, stream rpc.Cache_DumpServer)</span> <span class="title">error</span></span> {</span><br><span class="line">  <span class="keyword">for</span> k, v := <span class="keyword">range</span> s.store {</span><br><span class="line">    stream.Send(&amp;rpc.DumpItem{</span><br><span class="line">      Key: k,</span><br><span class="line">      Val: v,</span><br><span class="line">    })</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x6211;&#x4EEC;&#x4FEE;&#x6539; <code>Dump()</code> &#x7684;&#x5B9E;&#x73B0;&#xFF0C;&#x5BF9;&#x4E8E;&#x6BCF;&#x4E2A;&#x8BB0;&#x5F55;&#xFF0C;&#x5229;&#x7528; <code>stream.Send()</code> &#x53D1;&#x9001;&#x5230;&#x6D41;&#x3002;</p>
<p>&#x6CE8;&#x610F;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x6CA1;&#x6709; <code>context</code>&#xFF0C;&#x53EA;&#x6709;&#x4E2A; <code>stream</code>&#x3002;</p>
<p><strong>client.go</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">runClient</span><span class="params">()</span> <span class="title">error</span></span> {</span><br><span class="line">  ...</span><br><span class="line">  stream, err := cache.Dump(context.Background(), &amp;rpc.DumpReq{})</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">    <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to dump: %v&quot;</span>, err)</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">for</span> {</span><br><span class="line">    item, err := stream.Recv()</span><br><span class="line">    <span class="keyword">if</span> err == io.EOF {</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">      <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to stream item: %v&quot;</span>, err)</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="sheng-chan-huan-jing-an-li-heng-xiang-kuo-zhan-fu-zai-jun-heng"><a href="#&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;&#x6A2A;&#x5411;&#x6269;&#x5C55;&#x3001;&#x8D1F;&#x8F7D;&#x5747;&#x8861;" class="headerlink" title="&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;&#x6A2A;&#x5411;&#x6269;&#x5C55;&#x3001;&#x8D1F;&#x8F7D;&#x5747;&#x8861;"></a>&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;&#x6A2A;&#x5411;&#x6269;&#x5C55;&#x3001;&#x8D1F;&#x8F7D;&#x5747;&#x8861; <a href="#sheng-chan-huan-jing-an-li-heng-xiang-kuo-zhan-fu-zai-jun-heng" class="header-anchor">#</a></h3><p>&#x4F7F;&#x7528;&#x6D41;&#x540E;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x6027;&#x80FD;&#x63D0;&#x9AD8;&#x4E86;&#x5F88;&#x591A;&#xFF0C;&#x4F46;&#x662F;&#xFF0C;&#x6211;&#x4EEC;&#x7684;&#x670D;&#x52A1;&#x592A;&#x5438;&#x5F15;&#x4EBA;&#x4E86;&#xFF0C;&#x7528;&#x6237;&#x8D8A;&#x6765;&#x8D8A;&#x591A;&#xFF0C;&#x7ED3;&#x679C;&#x53C8;&#x5185;&#x5B58;&#x4E0D;&#x591F;&#x4E86;&#x3002;&#x8FD9;&#x65F6;&#x5019;&#x6211;&#x4EEC;&#x5BA1;&#x67E5;&#x4EE3;&#x7801;&#xFF0C;&#x611F;&#x89C9;&#x80FD;&#x505A;&#x7684;&#x4E8B;&#x60C5;&#x90FD;&#x505A;&#x4E86;&#xFF0C;&#x6216;&#x8BB8;&#x662F;&#x65F6;&#x5019;&#x4ECE;&#x5355;&#x4E00;&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x6269;&#x5C55;&#x4E3A;&#x591A;&#x4E2A;&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x7136;&#x540E;&#x4E4B;&#x95F4;&#x4F7F;&#x7528;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x3002;</p>
<p>gRPC &#x662F;&#x957F;&#x8FDE;&#x63A5;&#x6027;&#x8D28;&#x7684;&#x901A;&#x8BAF;&#xFF0C;&#x56E0;&#x6B64;&#x5982;&#x679C;&#x4E00;&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;&#x8FDE;&#x63A5;&#x4E86;&#x4E00;&#x4E2A; gRPC Endpoint&#xFF0C;&#x90A3;&#x4E48;&#x4ED6;&#x5C31;&#x4F1A;&#x4E00;&#x76F4;&#x8FDE;&#x63A5;&#x5230;&#x4E00;&#x4E2A;&#x56FA;&#x5B9A;&#x7684;&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x56E0;&#x6B64;&#x591A;&#x670D;&#x52A1;&#x5668;&#x7684;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x5BF9;&#x540C;&#x4E00;&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;&#x6765;&#x8BF4;&#x662F;&#x6CA1;&#x6709;&#x610F;&#x4E49;&#x7684;&#xFF0C;&#x4E0D;&#x4F1A;&#x56E0;&#x4E3A;&#x8FD9;&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;&#x6709;&#x5927;&#x91CF;&#x7684;&#x8BF7;&#x6C42;&#x800C;&#x5BFC;&#x81F4;&#x5206;&#x6563;&#x8BF7;&#x6C42;&#x5230;&#x4E0D;&#x540C;&#x7684;&#x670D;&#x52A1;&#x5668;&#x4E0A;&#x53BB;&#x3002;</p>
<p>&#x5982;&#x679C;&#x6211;&#x4EEC;&#x5E0C;&#x671B;&#x5BA2;&#x6237;&#x7AEF;&#x53EF;&#x4EE5;&#x5229;&#x7528;&#x591A;&#x670D;&#x52A1;&#x5668;&#x7684;&#x673A;&#x5236;&#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x9700;&#x8981;&#x66F4;&#x667A;&#x80FD;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#xFF0C;&#x8BA9;&#x5BA2;&#x6237;&#x7AEF;&#x610F;&#x8BC6;&#x5230;&#x670D;&#x52A1;&#x5668;&#x5B58;&#x5728;&#x591A;&#x4E2A;&#x526F;&#x672C;&#xFF0C;&#x56E0;&#x6B64;&#x5BA2;&#x6237;&#x7AEF;&#x5EFA;&#x7ACB;&#x591A;&#x6761;&#x8FDE;&#x63A5;&#x5230;&#x4E0D;&#x540C;&#x7684;&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x8FD9;&#x6837;&#x5C31;&#x53EF;&#x4EE5;&#x8BA9;&#x5355;&#x4E00;&#x5BA2;&#x6237;&#x7AEF;&#x5229;&#x7528;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x7684;&#x6A2A;&#x5411;&#x6269;&#x5C55;&#x80FD;&#x529B;&#x3002;</p>
<h3 id="sheng-chan-huan-jing-an-li-duo-yu-yan-xie-zuo"><a href="#&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;&#x591A;&#x8BED;&#x8A00;&#x534F;&#x4F5C;" class="headerlink" title="&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;&#x591A;&#x8BED;&#x8A00;&#x534F;&#x4F5C;"></a>&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x6848;&#x4F8B;&#xFF1A;&#x591A;&#x8BED;&#x8A00;&#x534F;&#x4F5C; <a href="#sheng-chan-huan-jing-an-li-duo-yu-yan-xie-zuo" class="header-anchor">#</a></h3><p>&#x5728;&#x590D;&#x6742;&#x7684;&#x73AF;&#x5883;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC; gRPC &#x7684;&#x5BA2;&#x6237;&#x7AEF;&#xFF08;&#x751A;&#x81F3;&#x670D;&#x52A1;&#x7AEF;&#xFF09;&#x53EF;&#x80FD;&#x662F;&#x4E0D;&#x540C;&#x8BED;&#x8A00;&#x5E73;&#x53F0;&#x7684;&#x3002;&#x8FD9;&#x5176;&#x5B9E;&#x662F; gRPC &#x7684;&#x4F18;&#x52BF;&#xFF0C;&#x53EF;&#x4EE5;&#x6BD4;&#x8F83;&#x5BB9;&#x6613;&#x7684;&#x5B9E;&#x73B0;&#x8DE8;&#x8BED;&#x8A00;&#x5E73;&#x53F0;&#x7684;&#x901A;&#x8BAF;&#x3002;</p>
<p>&#x6BD4;&#x5982;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x505A;&#x4E00;&#x4E2A; Python &#x5BA2;&#x6237;&#x7AEF;&#xFF1A;</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> grpc</span><br><span class="line"><span class="keyword">import</span> rpc_pb2 <span class="keyword">as</span> rpc</span><br><span class="line"></span><br><span class="line">channel = grpc.insecure_channel(<span class="string">&apos;localhost:5051&apos;</span>)</span><br><span class="line">cache_svc = rpc.CacheStub(channel)</span><br><span class="line"></span><br><span class="line">resp = cache_svc.Get(rpc.GetReq(</span><br><span class="line">  key=<span class="string">&quot;gopher&quot;</span>,</span><br><span class="line">))</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> resp.val</span><br></pre></td></tr></table></figure>
<p>&#x4E00;&#x4E2A;&#x4E0D;&#x662F;&#x5F88;&#x723D;&#x7684;&#x5730;&#x65B9;&#x662F;&#x867D;&#x7136; gRPC &#x7684;&#x8DE8;&#x8BED;&#x8A00;&#x901A;&#x8BAF;&#x5F88;&#x65B9;&#x4FBF;&#xFF0C;&#x4F46;&#x662F;&#x5404;&#x4E2A;&#x8BED;&#x8A00;&#x7684;&#x5B9E;&#x73B0;&#x90FD;&#x6BD4;&#x8F83;&#x968F;&#x610F;&#xFF0C;&#x6BD4;&#x5982; Go &#x4E2D;&#x53EB;&#x505A; <code>CacheClient()</code>&#xFF0C;&#x800C; Python &#x4E2D;&#x5219;&#x53EB;&#x505A; <code>CacheStub()</code>&#x3002;&#x8FD9;&#x91CC;&#x6CA1;&#x6709;&#x4EC0;&#x4E48;&#x7279;&#x522B;&#x7684;&#x539F;&#x56E0;&#x975E;&#x4E0D;&#x4E00;&#x6837;&#x7684;&#x540D;&#x5B57;&#xFF0C;&#x5C31;&#x662F;&#x7531;&#x4E8E;&#x4E0D;&#x540C;&#x7684;&#x4F5C;&#x8005;&#x5B9E;&#x73B0;&#x7684;&#x65F6;&#x5019;&#x6309;&#x7167;&#x81EA;&#x5DF1;&#x7684;&#x60F3;&#x6CD5;&#x547D;&#x540D;&#x7684;&#x3002;</p>
<h2 id="grpc-shang-bu-wan-mei-de-di-fang"><a href="#gRPC-&#x5C1A;&#x4E0D;&#x5B8C;&#x7F8E;&#x7684;&#x5730;&#x65B9;" class="headerlink" title="gRPC &#x5C1A;&#x4E0D;&#x5B8C;&#x7F8E;&#x7684;&#x5730;&#x65B9;"></a>gRPC &#x5C1A;&#x4E0D;&#x5B8C;&#x7F8E;&#x7684;&#x5730;&#x65B9; <a href="#grpc-shang-bu-wan-mei-de-di-fang" class="header-anchor">#</a></h2><ul>
<li>&#x8D1F;&#x8F7D;&#x5747;&#x8861;</li>
<li>&#x7ED3;&#x6784;&#x5316;&#x7684;&#x9519;&#x8BEF;&#x4FE1;&#x606F;</li>
<li>&#x8FD8;&#x4E0D;&#x652F;&#x6301;&#x6D4F;&#x89C8;&#x5668;&#x7684; JS &#xFF08;&#x67D0;&#x79CD;&#x89D2;&#x5EA6;&#x4E0A;&#x8BB2;&#xFF0C;&#x8FD9;&#x662F;&#x6700;&#x5E38;&#x7528;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#xFF09;</li>
<li>&#x8FD8;&#x7ECF;&#x5E38;&#x53D1;&#x751F; API &#x6539;&#x53D8;&#xFF08;&#x5373;&#x4F7F;&#x90FD;1.0&#x4E86;&#xFF09;</li>
<li>&#x67D0;&#x4E9B;&#x8BED;&#x8A00;&#x5B9E;&#x73B0;&#x7684;&#x6587;&#x6863;&#x975E;&#x5E38;&#x5DEE;</li>
<li>&#x6CA1;&#x6709;&#x8DE8;&#x8BED;&#x8A00;&#x7684;&#x6807;&#x51C6;&#x5316;&#x7684;&#x505A;&#x6CD5;</li>
</ul>
<h2 id="grpc-zai-sheng-chan-huan-jing-zhong-de-yong-li"><a href="#gRPC-&#x5728;&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x4E2D;&#x7684;&#x7528;&#x4F8B;" class="headerlink" title="gRPC &#x5728;&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x4E2D;&#x7684;&#x7528;&#x4F8B;"></a>gRPC &#x5728;&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x4E2D;&#x7684;&#x7528;&#x4F8B; <a href="#grpc-zai-sheng-chan-huan-jing-zhong-de-yong-li" class="header-anchor">#</a></h2><ul>
<li>ngrok&#xFF0C;&#x6240;&#x6709;&#x5185;&#x90E8;20&#x591A;&#x4E2A;&#x901A;&#x8BAF;&#x90FD;&#x8D70;&#x7684;&#x662F; gRPC</li>
<li>Square&#xFF0C;&#x5C06;&#x5185;&#x90E8;&#x7684;&#x901A;&#x8BAF;&#x90FD;&#x6362;&#x6210;&#x4E86; gRPC&#xFF0C;&#x662F;&#x6700;&#x65E9;&#x4F7F;&#x7528; gRPC &#x7684;&#x7528;&#x6237;&#x548C;&#x8D21;&#x732E;&#x8005;</li>
<li>CoreOS&#xFF0C;etcd v3 &#x5B8C;&#x5168;&#x8D70;&#x7684;&#x662F; gRPC</li>
<li>Google&#xFF0C;Google Cloud Service&#xFF08;PubSub, Speech Rec&#xFF09;&#x8D70;&#x7684;&#x662F; gRPC</li>
<li>Netflix, Yik Yak, VSCO, Cockroach, &#x2026;</li>
</ul>
<h2 id="grpc-wei-lai-de-bian-hua"><a href="#gRPC-&#x672A;&#x6765;&#x7684;&#x53D8;&#x5316;" class="headerlink" title="gRPC &#x672A;&#x6765;&#x7684;&#x53D8;&#x5316;"></a>gRPC &#x672A;&#x6765;&#x7684;&#x53D8;&#x5316; <a href="#grpc-wei-lai-de-bian-hua" class="header-anchor">#</a></h2><ul>
<li>&#x60F3;&#x4E86;&#x89E3;&#x672A;&#x6765;&#x7684;&#x53D8;&#x5316;&#x53EF;&#x4EE5;&#x67E5;&#x770B;&#xFF1A;<ul>
<li><a href="https://github.com/grpc/proposal" target="_blank" rel="noopener">grpc/proposal</a></li>
<li><a href="https://groups.google.com/forum/#!forum/grpc-io" target="_blank" rel="noopener">grpc-io &#x90AE;&#x4EF6;&#x5217;&#x8868;</a></li>
</ul>
</li>
<li>&#x65B0;&#x7684;&#x8BED;&#x8A00;&#x652F;&#x6301;&#xFF08;<a href="https://github.com/grpc/grpc-swift" target="_blank" rel="noopener">Swift</a> &#x548C; <a href="https://github.com/grpc/grpc-haskell" target="_blank" rel="noopener">Haskell</a>&#x6B63;&#x5728;&#x8BD5;&#x9A8C;&#x9636;&#x6BB5;&#xFF09;</li>
<li>&#x7A33;&#x5B9A;&#x6027;&#x3001;&#x53EF;&#x9760;&#x6027;&#x3001;&#x6027;&#x80FD;&#x7684;&#x63D0;&#x9AD8;</li>
<li>&#x589E;&#x52A0;&#x66F4;&#x591A;&#x7EC6;&#x5316;&#x7684; API &#x6765;&#x652F;&#x6301;&#x81EA;&#x5B9A;&#x4E49;&#x7684;&#x884C;&#x4E3A;&#xFF08;&#x8FDE;&#x63A5;&#x7BA1;&#x7406;&#x3001;&#x9891;&#x9053;&#x8DDF;&#x8E2A;&#xFF09;</li>
<li>&#x6D4F;&#x89C8;&#x5668;&#x7684; JS</li>
</ul>
</div></article><div class="pagination"><a href="/post/golang-2017-09-23-video-go-for-crypto-developers.html" class="pagination-prev">PREV</a><a href="/post/golang-2017-09-23-video-packet-capture-analysis-with-go.html" class="pagination-next">NEXT</a></div><div class="comments"><div id="disqus_thread"></div></div></div><aside class="sidebar"><h3>分类标签</h3><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Sonatype/">Sonatype</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/blog/">blog</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/coreos/">coreos</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker-summit/">docker summit</a></li></ul><h3>最新文章</h3><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/post/golang-2017-10-27-video-how-to-correctly-use-package-context.html">视频笔记：如何正确使用 Context - Jack Lindamood</a></li><li class="post-list-item"><a class="post-list-link" href="/post/golang-2017-10-20-video-seven-ways-to-profile-go-apps.html">视频笔记：7种 Go 程序性能分析方法 - Dave Cheney</a></li><li class="post-list-item"><a class="post-list-link" href="/post/golang-2017-10-13-video-write-container-in-go-from-scratch.html">视频笔记：容器是什么？让我们用 Go 写一个吧！ - Liz Rice</a></li><li class="post-list-item"><a class="post-list-link" href="/post/golang-2017-10-09-video-the-new-era-of-go-package-management.html">视频笔记：Go 包管理的新时代 - Sam Boyer</a></li><li class="post-list-item"><a class="post-list-link" href="/post/golang-2017-10-05-video-guide-to-syscall.html">视频笔记：Go 和 syscall - Liz Rice</a></li><li class="post-list-item"><a class="post-list-link" href="/post/golang-2017-10-04-video-understanding-channels.html">视频笔记：理解 channels - Kavya Joshi</a></li><li class="post-list-item"><a class="post-list-link" href="/post/golang-2017-10-01-video-go-build-mode.html">视频笔记：Go 的构建模式 - David Crawshaw</a></li><li class="post-list-item"><a class="post-list-link" href="/post/golang-2017-09-23-video-go-for-crypto-developers.html">视频笔记：Go 密码学应用 - George Tankersley</a></li></ul></aside></section></div><div class="extra"></div><footer class="footer"><div class="row-flex-row limit-width vh-center"><div class="copyright"><p>© 2020 <a href="/">王涛</a></p></div><div class="power"><p><a href="https://pages.coding.net/">Hosted by Coding Pages</a>, 
<a href="https://github.com/">GitHub</a>, 
<a href="https://hexo.io">Hexo</a>, 
<a href="https://github.com/twang2218/hexo-theme-jekyll">Jekyll</a></p></div></div></footer><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-80785538-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "//hm.baidu.com/hm.js?ee75cf08ad330aa99f8540efa2570970";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="//cdn.bootcss.com/mermaid/7.0.0/mermaid.min.js"></script><script>(function() {
    var d = document, s = d.createElement('script');
    s.src = '//twang2218-coding.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
})();</script></body></html>