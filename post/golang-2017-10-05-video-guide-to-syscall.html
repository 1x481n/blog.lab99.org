<!DOCTYPE html><html lang="zh-cn"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 视频笔记：Go 和 syscall - Liz Rice · 大桥下的蜗牛</title><meta name="description" content="无善无恶心之体，有善有恶意之动，知善知恶是良知，为善去恶是格物。"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/jekyll.css"><link rel="stylesheet" href="https://cdn.bootcss.com/mermaid/7.0.0/mermaid.min.css"><!--[if lt IE 9]>
<script src="js/html5shiv.min.js"></script>
<script src="js/respond.min.js"></script>
<![endif]--></head><body><header class="row-flex-row limit-width vh-center"><a href="/" class="logo"><img src="/favicon.png"></a><nav><ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-link">主页</a></li><li class="nav-list-item"><a href="/archives/" class="nav-link active">   博客</a></li><li class="nav-list-item"><a href="https://github.com/twang2218" target="_blank" class="nav-link">github</a></li><li class="nav-list-item"><a href="https://coding.net/u/twang2218" target="_blank" class="nav-link">coding</a></li><li class="nav-list-item"><a href="/atom.xml" class="nav-link">rss</a></li></ul></nav></header><div class="container limit-width"><section class="row-flex-row"><div class="post"><article class="post-block"><h2 class="post-title"><a href="/post/golang-2017-10-05-video-guide-to-syscall.html" class="post-title-link">视频笔记：Go 和 syscall - Liz Rice</a></h2><div class="post-meta"><ul class="post-tag-list"><li class="post-tag-item"><a href="/tags/youtube/" class="post-tag-link">youtube</a></li><li class="post-tag-item"><a href="/tags/notes/" class="post-tag-link">notes</a></li><li class="post-tag-item"><a href="/tags/golang/" class="post-tag-link">golang</a></li><li class="post-tag-item"><a href="/tags/gophercon2017/" class="post-tag-link">gophercon2017</a></li></ul><div class="post-time">2017年10月5日 星期四</div></div><div class="post-content"><link rel="stylesheet" href="/style/owl.css"><!-- toc -->
<ul>
<li><a href="#shi-pin-xin-xi">&#x89C6;&#x9891;&#x4FE1;&#x606F;</a></li>
<li><a href="#shi-me-shi-syscall">&#x4EC0;&#x4E48;&#x662F; <code>syscall</code>&#xFF1F;</a><ul>
<li><a href="#ji-shi-shi-jian-dan-cheng-xu-ye-zai-shi-yong-syscall">&#x5373;&#x4F7F;&#x662F;&#x7B80;&#x5355;&#x7A0B;&#x5E8F;&#x4E5F;&#x5728;&#x4F7F;&#x7528; <code>syscall</code></a></li>
<li><a href="#ru-he-jin-xing-de-syscall">&#x5982;&#x4F55;&#x8FDB;&#x884C;&#x7684; <code>syscall</code></a></li>
<li><a href="#syscall-ke-yi-zuo-wei-yi-ge-jian-rong-ceng"><code>syscall</code> &#x53EF;&#x4EE5;&#x4F5C;&#x4E3A;&#x4E00;&#x4E2A;&#x517C;&#x5BB9;&#x5C42;</a></li>
<li><a href="#guan-cha-cheng-xu-de-syscall-diao-yong-qing-kuang">&#x89C2;&#x5BDF;&#x7A0B;&#x5E8F;&#x7684; <code>syscall</code> &#x8C03;&#x7528;&#x60C5;&#x51B5;</a></li>
</ul>
</li>
<li><a href="#yong-go-xie-yi-ge-strace">&#x7528; Go &#x5199;&#x4E00;&#x4E2A; <code>strace</code></a><ul>
<li><a href="#diao-yong-ling-yi-ge-ming-ling">&#x8C03;&#x7528;&#x53E6;&#x4E00;&#x4E2A;&#x547D;&#x4EE4;</a></li>
<li><a href="#tian-jia-ptrace-zhi-chi">&#x6DFB;&#x52A0; <code>ptrace</code> &#x652F;&#x6301;</a></li>
<li><a href="#da-yin-duan-dian-de-ji-cun-qi-bian-liang">&#x6253;&#x5370;&#x65AD;&#x70B9;&#x7684;&#x5BC4;&#x5B58;&#x5668;&#x53D8;&#x91CF;</a></li>
<li><a href="#shu-chu-xi-tong-diao-yong-ming-cheng">&#x8F93;&#x51FA;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x540D;&#x79F0;</a></li>
<li><a href="#shu-chu-suo-you-de-xi-tong-diao-yong">&#x8F93;&#x51FA;&#x6240;&#x6709;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;</a></li>
<li><a href="#qi-shi-ptrace-hui-ting-liang-ci">&#x5176;&#x5B9E; <code>ptrace</code> &#x4F1A;&#x505C;&#x4E24;&#x6B21;&#x2026;&#x2026;</a></li>
<li><a href="#hui-zong-xi-tong-diao-yong">&#x6C47;&#x603B;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;</a></li>
</ul>
</li>
<li><a href="#syscall-yu-xi-tong-an-quan">syscall &#x4E0E;&#x7CFB;&#x7EDF;&#x5B89;&#x5168;</a><ul>
<li><a href="#cheng-xu-zhong-shi-yong-seccomp-pei-zhi">&#x7A0B;&#x5E8F;&#x4E2D;&#x4F7F;&#x7528; seccomp &#x914D;&#x7F6E;</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->
<h1 id="shi-pin-xin-xi"><a href="#&#x89C6;&#x9891;&#x4FE1;&#x606F;" class="headerlink" title="&#x89C6;&#x9891;&#x4FE1;&#x606F;"></a>&#x89C6;&#x9891;&#x4FE1;&#x606F; <a href="#shi-pin-xin-xi" class="header-anchor">#</a></h1><p><strong>A Go programmer&#x2019;s guide to syscalls</strong><br>by Liz Rice<br>at GopherCon 2017</p>
<div class="owl-media owl-video owl-youtube"><iframe src="//www.youtube.com/embed/01w7viEZzXQ" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe></div>
<p><a href="https://www.youtube.com/watch?v=01w7viEZzXQ" target="_blank" rel="noopener">https://www.youtube.com/watch?v=01w7viEZzXQ</a></p>
<ul>
<li>&#x5E7B;&#x706F;&#xFF1A;<a href="https://speakerdeck.com/lizrice/a-go-programmers-guide-to-syscalls" target="_blank" rel="noopener">https://speakerdeck.com/lizrice/a-go-programmers-guide-to-syscalls</a></li>
<li>&#x535A;&#x6587;&#xFF1A;<a href="https://about.sourcegraph.com/go/a-go-guide-to-syscalls" target="_blank" rel="noopener">https://about.sourcegraph.com/go/a-go-guide-to-syscalls</a></li>
<li>&#x4EE3;&#x7801;&#xFF1A;<a href="https://github.com/lizrice/strace-from-scratch" target="_blank" rel="noopener">https://github.com/lizrice/strace-from-scratch</a></li>
</ul>
<h1 id="shi-me-shi-syscall"><a href="#&#x4EC0;&#x4E48;&#x662F;-syscall&#xFF1F;" class="headerlink" title="&#x4EC0;&#x4E48;&#x662F; syscall&#xFF1F;"></a>&#x4EC0;&#x4E48;&#x662F; <code>syscall</code>&#xFF1F; <a href="#shi-me-shi-syscall" class="header-anchor">#</a></h1><blockquote>
<p>&#x201C;&#x5728;&#x7535;&#x8111;&#x4E2D;&#xFF0C;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#xFF08;&#x82F1;&#x8BED;&#xFF1A;system call&#xFF09;&#xFF0C;&#x53C8;&#x79F0;&#x4E3A;&#x7CFB;&#x7EDF;&#x547C;&#x53EB;&#xFF0C;&#x6307;&#x8FD0;&#x884C;&#x5728;&#x7528;&#x6237;&#x7A7A;&#x95F4;&#x7684;&#x7A0B;&#x5E8F;&#x5411;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x5185;&#x6838;&#x8BF7;&#x6C42;&#x9700;&#x8981;&#x66F4;&#x9AD8;&#x6743;&#x9650;&#x8FD0;&#x884C;&#x7684;&#x670D;&#x52A1;&#x3002;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x63D0;&#x4F9B;&#x7528;&#x6237;&#x7A0B;&#x5E8F;&#x4E0E;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x4E4B;&#x95F4;&#x7684;&#x63A5;&#x53E3;&#x3002;&#x5927;&#x591A;&#x6570;&#x7CFB;&#x7EDF;&#x4EA4;&#x4E92;&#x5F0F;&#x64CD;&#x4F5C;&#x9700;&#x6C42;&#x5728;&#x5185;&#x6838;&#x6001;&#x6267;&#x884C;&#x3002;&#x5982;&#x8BBE;&#x5907;IO&#x64CD;&#x4F5C;&#x6216;&#x8005;&#x8FDB;&#x7A0B;&#x95F4;&#x901A;&#x4FE1;&#x3002;&#x201D; - <a href="https://zh.wikipedia.org/zh-cn/&#x7CFB;&#x7EDF;&#x8C03;&#x7528;" target="_blank" rel="noopener">&#x7EF4;&#x57FA;&#x767E;&#x79D1;</a></p>
</blockquote>
<p>&#x5B9E;&#x9645;&#x4E0A;&#xFF0C;&#x4F60;&#x57FA;&#x672C;&#x4E0A;&#x505A;&#x4EFB;&#x4F55;&#x4E8B;&#x60C5;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x90FD;&#x9700;&#x8981;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x3002;</p>
<ul>
<li>&#x8BBF;&#x95EE;&#x6587;&#x4EF6;</li>
<li>&#x8BBF;&#x95EE;&#x8BBE;&#x5907;</li>
<li>&#x8FDB;&#x7A0B;&#x7BA1;&#x7406;</li>
<li>&#x901A;&#x8BAF;</li>
<li>&#x65F6;&#x95F4;</li>
<li>&#x2026;</li>
</ul>
<h2 id="ji-shi-shi-jian-dan-cheng-xu-ye-zai-shi-yong-syscall"><a href="#&#x5373;&#x4F7F;&#x662F;&#x7B80;&#x5355;&#x7A0B;&#x5E8F;&#x4E5F;&#x5728;&#x4F7F;&#x7528;-syscall" class="headerlink" title="&#x5373;&#x4F7F;&#x662F;&#x7B80;&#x5355;&#x7A0B;&#x5E8F;&#x4E5F;&#x5728;&#x4F7F;&#x7528; syscall"></a>&#x5373;&#x4F7F;&#x662F;&#x7B80;&#x5355;&#x7A0B;&#x5E8F;&#x4E5F;&#x5728;&#x4F7F;&#x7528; <code>syscall</code> <a href="#ji-shi-shi-jian-dan-cheng-xu-ye-zai-shi-yong-syscall" class="header-anchor">#</a></h2><p>&#x65E0;&#x8BBA;&#x4F60;&#x662F;&#x5199; C &#x7A0B;&#x5E8F;&#x3001;&#x5199; Go &#x7A0B;&#x5E8F;&#xFF0C;&#x6216;&#x8005;&#x54EA;&#x6015;&#x662F;&#x5199; bash &#x811A;&#x672C;&#xFF0C;&#x4F60;&#x5B9E;&#x9645;&#x4E0A;&#x90FD;&#x4F1A;&#x7528;&#x5230; syscall&#x3002;&#x4E3E;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684; Go &#x7684;&#x4F8B;&#x5B50;&#x3002;</p>
<p><strong>hello.go</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">	fmt.Println(<span class="string">&quot;Hello, GopherCon!&quot;</span>)</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x5982;&#x679C;&#x6211;&#x4EEC;&#x5728; Linux &#x4E0A;&#x6784;&#x5EFA;&#xFF0C;&#x5E76;&#x4E14;&#x4F7F;&#x7528; <code>strace</code> &#x7684;&#x8BDD;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x53D1;&#x751F;&#x4E86;&#x591A;&#x5C11;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x4E86;&#xFF1A;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ go build hello.go</span><br><span class="line">$ strace ./hello</span><br><span class="line">execve(<span class="string">&quot;./hello&quot;</span>, [<span class="string">&quot;./hello&quot;</span>], [/* 23 vars */]) = 0</span><br><span class="line">arch_prctl(ARCH_SET_FS, 0x52c008)       = 0</span><br><span class="line">sched_getaffinity(0, 8192, [0])         = 8</span><br><span class="line">mmap(0xc000000000, 65536, PROT_NONE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0xc000000000</span><br><span class="line">munmap(0xc000000000, 65536)             = 0</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">futex(0x52c0b0, FUTEX_WAIT, 0, NULL)    = 0</span><br><span class="line">mmap(NULL, 262144, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f1eef3ac000</span><br><span class="line">write(1, <span class="string">&quot;Hello, GopherCon!\n&quot;</span>, 18Hello, GopherCon!</span><br><span class="line">)     = 18</span><br><span class="line">futex(0x52ba58, FUTEX_WAKE, 1)          = 1</span><br><span class="line">futex(0x52b990, FUTEX_WAKE, 1)          = 1</span><br><span class="line">exit_group(0)                           = ?</span><br><span class="line">+++ exited with 0 +++</span><br></pre></td></tr></table></figure>
<p>&#x6211;&#x4EEC;&#x770B;&#x5230;&#x4E86;&#x6D77;&#x6D77;&#x7684; syscall&#xFF0C;&#x800C;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5173;&#x6CE8;&#x4E00;&#x4E0B;&#x6700;&#x540E;&#x7684;&#x90A3;&#x4E2A; <code>write()</code>&#xFF1A;</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">write(<span class="number">1</span>, <span class="string">&quot;Hello, GopherCon!\n&quot;</span>, <span class="number">18</span>Hello, GopherCon!</span><br><span class="line">)     = <span class="number">18</span></span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x662F;&#x6700;&#x540E;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#xFF0C;&#x5C06;&#x5B57;&#x7B26;&#x4E32;&#x8F93;&#x51FA;&#x5230;&#x4E86;&#x6807;&#x51C6;&#x8F93;&#x51FA;&#xFF0C;<code>1</code>&#x3002;</p>
<p>&#x90A3;&#x4E48;&#x4E2D;&#x95F4;&#x90FD;&#x7ECF;&#x8FC7;&#x4E86;&#x4EC0;&#x4E48;&#xFF1F;&#x5982;&#x679C;&#x6211;&#x4EEC;&#x987A;&#x7740;&#x4EE3;&#x7801;&#x4E00;&#x6B65;&#x6B65;&#x8DDF;&#x8E2A;&#x8FDB;&#x53BB;&#x5C31;&#x4F1A;&#x770B;&#x5230;&#xFF0C;<code>fmt.Println()</code> &#x7684;&#x5B9A;&#x4E49;&#x5728; <code>fmt/print.go</code> &#x4E2D;&#xFF1A;</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Println</span><span class="params">(a ...<span class="keyword">interface</span>{})</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> {</span><br><span class="line">	<span class="keyword">return</span> Fprintln(os.Stdout, a...)</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><code>Fprintln()</code> &#x7684;&#x5B9A;&#x4E49;&#x4E3A;&#xFF1A;</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Fprintln</span><span class="params">(w io.Writer, a ...<span class="keyword">interface</span>{})</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> {</span><br><span class="line">	p := newPrinter()</span><br><span class="line">	p.doPrintln(a)</span><br><span class="line">	n, err = w.Write(p.buf)</span><br><span class="line">	p.free()</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x6CE8;&#x610F;&#x5230;&#x8FD9;&#x91CC;&#x6700;&#x540E;&#x8C03;&#x7528;&#x7684;&#x662F; <code>w.Write()</code>&#xFF0C;&#x800C; <code>w</code> &#x5B9E;&#x9645;&#x4E0A;&#x662F;&#x524D;&#x9762;&#x7684; <code>os.Stdout</code>&#xFF0C;&#x5176;&#x5B9A;&#x4E49;&#x5728; <code>os/file.go</code> &#x4E2D;&#xFF0C;&#x4E3A;&#xFF1A;</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Stdout = NewFile(<span class="keyword">uintptr</span>(syscall.Stdout), <span class="string">&quot;/dev/stdout&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x91CC;&#x7684; <code>NewFile()</code> &#x4F1A;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x6587;&#x4EF6;&#xFF1A;</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &quot;os/file_unix.go&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newFile</span><span class="params">(fd <span class="keyword">uintptr</span>, name <span class="keyword">string</span>, pollable <span class="keyword">bool</span>)</span> *<span class="title">File</span></span> {</span><br><span class="line">	fdi := <span class="keyword">int</span>(fd)</span><br><span class="line">	<span class="keyword">if</span> fdi &lt; <span class="number">0</span> {</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	}</span><br><span class="line">	f := &amp;File{&amp;file{</span><br><span class="line">		pfd: poll.FD{</span><br><span class="line">			Sysfd:         fdi,</span><br><span class="line">			IsStream:      <span class="literal">true</span>,</span><br><span class="line">			ZeroReadIsEOF: <span class="literal">true</span>,</span><br><span class="line">		},</span><br><span class="line">		name: name,</span><br><span class="line">	}}</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> f</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x7136;&#x540E;&#x53BB;&#x770B;&#x8FD9;&#x4E2A; <code>file</code> &#x7684;&#x5177;&#x4F53;&#x5B9E;&#x73B0;&#xFF1A;</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *File)</span> <span class="title">write</span><span class="params">(b []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> {</span><br><span class="line">	n, err = f.pfd.Write(b)</span><br><span class="line">	runtime.KeepAlive(f)</span><br><span class="line">	<span class="keyword">return</span> n, err</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x8FDB;&#x4E00;&#x6B65;&#x53BB;&#x770B; <code>f.pfd.Write()</code> &#x7684;&#x5B9E;&#x73B0;&#xFF1A;</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fd *FD)</span> <span class="title">Write</span><span class="params">(p []<span class="keyword">byte</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> {</span><br><span class="line">	<span class="keyword">if</span> err := fd.writeLock(); err != <span class="literal">nil</span> {</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>, err</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">defer</span> fd.writeUnlock()</span><br><span class="line">	<span class="keyword">if</span> err := fd.pd.prepareWrite(fd.isFile); err != <span class="literal">nil</span> {</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>, err</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">var</span> nn <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">for</span> {</span><br><span class="line">		max := <span class="built_in">len</span>(p)</span><br><span class="line">		<span class="keyword">if</span> fd.IsStream &amp;&amp; max-nn &gt; maxRW {</span><br><span class="line">			max = nn + maxRW</span><br><span class="line">		}</span><br><span class="line">		n, err := syscall.Write(fd.Sysfd, p[nn:max])</span><br><span class="line">		<span class="keyword">if</span> n &gt; <span class="number">0</span> {</span><br><span class="line">			nn += n</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">if</span> nn == <span class="built_in">len</span>(p) {</span><br><span class="line">			<span class="keyword">return</span> nn, err</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">if</span> err == syscall.EAGAIN &amp;&amp; fd.pd.pollable() {</span><br><span class="line">			<span class="keyword">if</span> err = fd.pd.waitWrite(fd.isFile); err == <span class="literal">nil</span> {</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">			<span class="keyword">return</span> nn, err</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">if</span> n == <span class="number">0</span> {</span><br><span class="line">			<span class="keyword">return</span> nn, io.ErrUnexpectedEOF</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x5C31;&#x770B;&#x5230;&#x4E86;&#x6700;&#x7EC8;&#x7684; <code>syscall</code>&#xFF1A;</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">n, err := syscall.Write(fd.Sysfd, p[nn:max])</span><br></pre></td></tr></table></figure>
<p>Go &#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x4F7F;&#x7528;&#x4E86; <code>syscall</code> &#x8FD9;&#x4E2A;&#x6807;&#x51C6;&#x5E93;&#x7684;&#x5305;&#x3002;&#x5305;&#x91CC;&#x6709;&#x5F88;&#x591A;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x76F8;&#x5173;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x4EE5;&#x53CA;&#x7279;&#x5B9A;&#x6784;&#x67B6;&#x7684;&#x81EA;&#x52A8;&#x751F;&#x6210;&#x7684;&#x4EE3;&#x7801;&#x3002;</p>
<ul>
<li>&#x7CFB;&#x7EDF;&#x76F8;&#x5173;&#x7684;&#x4EE3;&#x7801;&#xFF1A;<ul>
<li>&#x5982;&#xFF1A; <a href="https://golang.org/src/syscall/syscall_linux.go" target="_blank" rel="noopener">https://golang.org/src/syscall/syscall_linux.go</a></li>
</ul>
</li>
<li>&#x81EA;&#x52A8;&#x751F;&#x6210;&#x7684;&#x4EE3;&#x7801;&#xFF1A;<ul>
<li>&#x5982;&#xFF1A;<a href="https://golang.org/src/syscall/zsyscall_linux_386.go" target="_blank" rel="noopener">https://golang.org/src/syscall/zsyscall_linux_386.go</a></li>
</ul>
</li>
</ul>
<p>&#x5BF9;&#x4E8E; Linux &#x800C;&#x8A00;&#xFF0C;&#x73B0;&#x5728;&#x5927;&#x7EA6;&#x6709; <code>330</code> &#x591A;&#x4E2A;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x3002;</p>
<h2 id="ru-he-jin-xing-de-syscall"><a href="#&#x5982;&#x4F55;&#x8FDB;&#x884C;&#x7684;-syscall" class="headerlink" title="&#x5982;&#x4F55;&#x8FDB;&#x884C;&#x7684; syscall"></a>&#x5982;&#x4F55;&#x8FDB;&#x884C;&#x7684; <code>syscall</code> <a href="#ru-he-jin-xing-de-syscall" class="header-anchor">#</a></h2><p>&#x5982;&#x4F55;&#x8FDB;&#x884C;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#xFF1F;&#x548C;&#x5F80;&#x5E38;&#x4E00;&#x6837;&#xFF0C;&#x5148;&#x67E5; <code>man</code>&#xFF1A;</p>
<blockquote>
<p><code>syscall()</code> saves CPU registers before making the system call, restores the registers upon return from the system call, and stores any error code returned by the system call in <code>errno(3)</code> if an error occurs.</p>
</blockquote>
<p>&#x5C31;&#x662F;&#x8BF4;&#x8C03;&#x7528; <code>syscall</code> &#x4E4B;&#x524D;&#x5148;&#x4FDD;&#x5B58;&#x73AF;&#x5883;&#xFF1B;<code>syscall</code> &#x8FD4;&#x56DE;&#x4E4B;&#x540E;&#xFF0C;&#x6062;&#x590D;&#x73AF;&#x5883;&#xFF1B;&#x9519;&#x8BEF;&#x4EE3;&#x7801;&#x5728; <code>errno</code> &#x4E2D;&#x3002;</p>
<p>&#x800C;&#x5B9E;&#x9645;&#x7684;&#x8C03;&#x7528;&#x63A5;&#x53E3;&#xFF0C;&#x53EF;&#x4EE5;&#x53C2;&#x8003;&#xFF1A;<a href="http://blog.rchapman.org/posts/Linux_System_Call_Table_for_x86_64/" target="_blank" rel="noopener">http://blog.rchapman.org/posts/Linux_System_Call_Table_for_x86_64/</a></p>
<p>&#x4EE5; <code>sys_write</code> &#x8C03;&#x7528;&#x4E3A;&#x4F8B;&#xFF0C;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x53F7;&#x653E;&#x5230;&#x4E86; <code>%rax</code> &#x4E4B;&#x4E2D;&#xFF0C;&#x6587;&#x4EF6;&#x7684; <code>fd</code> &#x653E;&#x5230;&#x4E86; <code>%rdi</code> &#x4E2D;&#xFF0C;&#x8981;&#x5199;&#x5165;&#x7684; <code>buf</code> &#x653E;&#x5230;&#x4E86; <code>%rsi</code> &#x4E2D;&#xFF0C;&#x5199;&#x5165;&#x957F;&#x5EA6;&#x653E;&#x5230;&#x4E86; <code>%rdx</code> &#x4E4B;&#x4E2D;&#x3002;</p>
<p>&#x5F53;&#x6267;&#x884C;&#x4E86; <code>syscall()</code> &#x540E;&#xFF0C;&#x5F00;&#x59CB;&#x8FDB;&#x5165; Trap&#xFF0C;&#x7136;&#x540E;&#x8FDB;&#x5165;&#x5185;&#x6838;&#x6001;&#xFF0C;&#x5F00;&#x59CB;&#x6267;&#x884C;&#x5BF9;&#x5E94;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7684;&#x4EE3;&#x7801;&#x3002;&#x800C;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7684;&#x8FD4;&#x56DE;&#x503C;&#xFF0C;&#x4F1A;&#x653E;&#x5230;&#x4E86; <code>%rax</code> &#x4E4B;&#x4E2D;&#x3002;</p>
<p>&#x5F53;&#x7136;&#xFF0C;&#x8FD9;&#x91CC;&#x662F;&#x4EE5; <code>amd64</code> &#x67B6;&#x6784;&#x7684; Linux &#x7CFB;&#x7EDF;&#x4E3E;&#x4F8B;&#xFF0C;&#x4E0D;&#x540C;&#x7684;&#x7CFB;&#x7EDF;&#xFF0C;&#x65E0;&#x8BBA;&#x662F;&#x6307;&#x4EE4;&#x96C6;&#x3001;&#x8FD8;&#x662F;&#x8C03;&#x7528;&#x65B9;&#x5F0F;&#x90FD;&#x4F1A;&#x4E0D;&#x540C;&#x3002;</p>
<h2 id="syscall-ke-yi-zuo-wei-yi-ge-jian-rong-ceng"><a href="#syscall-&#x53EF;&#x4EE5;&#x4F5C;&#x4E3A;&#x4E00;&#x4E2A;&#x517C;&#x5BB9;&#x5C42;" class="headerlink" title="syscall &#x53EF;&#x4EE5;&#x4F5C;&#x4E3A;&#x4E00;&#x4E2A;&#x517C;&#x5BB9;&#x5C42;"></a><code>syscall</code> &#x53EF;&#x4EE5;&#x4F5C;&#x4E3A;&#x4E00;&#x4E2A;&#x517C;&#x5BB9;&#x5C42; <a href="#syscall-ke-yi-zuo-wei-yi-ge-jian-rong-ceng" class="header-anchor">#</a></h2><p>&#x53EF;&#x4EE5;&#x628A; <code>syscall</code> &#x4F5C;&#x4E3A;&#x4E00;&#x5C42;&#x53EF;&#x79FB;&#x690D;&#x5C42;&#x3002;&#x56E0;&#x4E3A;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x5B9E;&#x73B0;&#x4E00;&#x7EC4; <code>syscall</code> &#x63A5;&#x53E3;&#xFF0C;&#x6765;&#x6A21;&#x62DF; Linux&#x3002;</p>
<p>&#x8FD9;&#x4E2A;&#x6982;&#x5FF5;&#x4E0D;&#x65B0;&#x9C9C;&#xFF0C;&#x6BD4;&#x5982; <a href="https://en.wikipedia.org/wiki/Windows_Subsystem_for_Linux" target="_blank" rel="noopener">Windows Subsystem for Linux</a>&#x3001;&#x4EE5;&#x53CA; FreeBSD &#x7684; <a href="https://www.freebsd.org/doc/handbook/linuxemu-lbc-install.html" target="_blank" rel="noopener">Linux emulation layer</a>&#xFF0C;&#x8FD8;&#x6709; <a href="https://en.wikipedia.org/wiki/L4Linux" target="_blank" rel="noopener">L4Linux</a> &#x90FD;&#x662F;&#x8FD9;&#x4E48;&#x505A;&#x7684;&#x3002;</p>
<h2 id="guan-cha-cheng-xu-de-syscall-diao-yong-qing-kuang"><a href="#&#x89C2;&#x5BDF;&#x7A0B;&#x5E8F;&#x7684;-syscall-&#x8C03;&#x7528;&#x60C5;&#x51B5;" class="headerlink" title="&#x89C2;&#x5BDF;&#x7A0B;&#x5E8F;&#x7684; syscall &#x8C03;&#x7528;&#x60C5;&#x51B5;"></a>&#x89C2;&#x5BDF;&#x7A0B;&#x5E8F;&#x7684; <code>syscall</code> &#x8C03;&#x7528;&#x60C5;&#x51B5; <a href="#guan-cha-cheng-xu-de-syscall-diao-yong-qing-kuang" class="header-anchor">#</a></h2><ul>
<li>Linux &#x4E0B;&#x7684; <code>strace</code>&#xFF1A;<ul>
<li><code>strace -c</code> &#x6C47;&#x603B;&#x8F93;&#x51FA;&#x3002;</li>
</ul>
</li>
</ul>
<p>&#x6BD4;&#x5982;&#x521A;&#x624D;&#x7684;&#x90A3;&#x4E2A; <code>hello</code> &#x7A0B;&#x5E8F;&#xFF1A;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ strace -c ./hello</span><br><span class="line">Hello, GopherCon!</span><br><span class="line">% time     seconds  usecs/call     calls    errors syscall</span><br><span class="line">------ ----------- ----------- --------- --------- ----------------</span><br><span class="line">  0.00    0.000000           0         1           write</span><br><span class="line">  0.00    0.000000           0         8           mmap</span><br><span class="line">  0.00    0.000000           0         1           munmap</span><br><span class="line">  0.00    0.000000           0       114           rt_sigaction</span><br><span class="line">  0.00    0.000000           0         6           rt_sigprocmask</span><br><span class="line">  0.00    0.000000           0         2           <span class="built_in">clone</span></span><br><span class="line">  0.00    0.000000           0         1           execve</span><br><span class="line">  0.00    0.000000           0         2           sigaltstack</span><br><span class="line">  0.00    0.000000           0         1           arch_prctl</span><br><span class="line">  0.00    0.000000           0         1           gettid</span><br><span class="line">  0.00    0.000000           0         3           futex</span><br><span class="line">  0.00    0.000000           0         1           sched_getaffinity</span><br><span class="line">  0.00    0.000000           0         1           readlinkat</span><br><span class="line">------ ----------- ----------- --------- --------- ----------------</span><br><span class="line">100.00    0.000000                   142           total</span><br></pre></td></tr></table></figure>
<p>&#x6362;&#x53E5;&#x8BDD;&#x8BF4;&#xFF0C;&#x5982;&#x679C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x8FD0;&#x884C;&#x8FD9;&#x4E2A;&#x7A0B;&#x5E8F;&#x7684;&#x8BDD;&#xFF0C;&#x53EA;&#x8981;&#x6709;&#x4E2A;&#x5185;&#x6838;&#x53EF;&#x4EE5;&#x5B9E;&#x73B0;&#x8FD9;<code>13</code>&#x4E2A;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#xFF0C;&#x5C31;&#x591F;&#x4E86;&#x3002;&#x1F63C;</p>
<p>&#x4E0D;&#x8FC7; <code>strace</code> &#x662F;&#x600E;&#x4E48;&#x505A;&#x5230;&#x76D1;&#x542C;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7684;&#x5462;&#xFF1F;</p>
<p>&#x5B9E;&#x9645;&#x4E0A; <code>strace</code> &#x4F7F;&#x7528;&#x4E86; Linux &#x7684;&#x53E6;&#x4E00;&#x4E2A;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#xFF0C;<code>ptrace</code>&#x3002;<code>ptrace</code> &#x53EF;&#x4EE5;&#x8BA9;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x76D1;&#x542C;&#x3001;&#x63A7;&#x5236;&#x53E6;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x7684;&#x6267;&#x884C;&#xFF0C;&#x68C0;&#x67E5;&#x3001;&#x6539;&#x53D8;&#x8BE5;&#x8FDB;&#x7A0B;&#x7684;&#x5185;&#x5B58;&#x3001;&#x5BC4;&#x5B58;&#x5668;&#x7B49;&#x7B49;&#x3002;&#x8FD9;&#x7ECF;&#x5E38;&#x7528;&#x4E8E;&#x65AD;&#x70B9;&#x8C03;&#x8BD5;&#x3001;&#x548C;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x8DDF;&#x8E2A;&#x3002;&#x5F88;&#x66B4;&#x529B;&#x3001;&#x5F88;&#x5F3A;&#x5927;&#x2026;&#x2026;&#x1F4AA;</p>
<h1 id="yong-go-xie-yi-ge-strace"><a href="#&#x7528;-Go-&#x5199;&#x4E00;&#x4E2A;-strace" class="headerlink" title="&#x7528; Go &#x5199;&#x4E00;&#x4E2A; strace"></a>&#x7528; Go &#x5199;&#x4E00;&#x4E2A; <code>strace</code> <a href="#yong-go-xie-yi-ge-strace" class="header-anchor">#</a></h1><p>&#x65E2;&#x7136; <code>strace</code> &#x662F;&#x4F7F;&#x7528;&#x7684; <code>ptrace</code> &#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#xFF0C;&#x800C; Go &#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x8FDB;&#x884C;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#xFF0C;&#x5E76;&#x4E14;&#x5C01;&#x88C5;&#x4E86;&#x4E00;&#x4E9B; <code>ptrace</code> &#x7684;&#x8C03;&#x7528;&#xFF0C;&#x90A3;&#x4E48;&#x6211;&#x4EEC;&#x5176;&#x5B9E;&#x53EF;&#x4EE5;&#x7528; Go &#x5B9E;&#x73B0;&#x4E00;&#x4E2A; <code>strace</code>&#x3002;</p>
<h2 id="diao-yong-ling-yi-ge-ming-ling"><a href="#&#x8C03;&#x7528;&#x53E6;&#x4E00;&#x4E2A;&#x547D;&#x4EE4;" class="headerlink" title="&#x8C03;&#x7528;&#x53E6;&#x4E00;&#x4E2A;&#x547D;&#x4EE4;"></a>&#x8C03;&#x7528;&#x53E6;&#x4E00;&#x4E2A;&#x547D;&#x4EE4; <a href="#diao-yong-ling-yi-ge-ming-ling" class="header-anchor">#</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//	main.go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">	<span class="string">&quot;os/exec&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">	fmt.Printf(<span class="string">&quot;Run %v\n&quot;</span>, os.Args[<span class="number">1</span>:])</span><br><span class="line"></span><br><span class="line">	cmd := exec.Command(os.Args[<span class="number">1</span>], os.Args[<span class="number">2</span>:]...)</span><br><span class="line">	cmd.Stderr = os.Stderr</span><br><span class="line">	cmd.Stdin = os.Stdin</span><br><span class="line">	cmd.Stdout = os.Stdout</span><br><span class="line"></span><br><span class="line">	cmd.Start()</span><br><span class="line">	err := cmd.Wait()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">		fmt.Printf(<span class="string">&quot;wait() returned: %v\n&quot;</span>, err)</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x4F7F;&#x7528; <code>exec.Command()</code> &#x6765;&#x5EFA;&#x7ACB;&#x8981;&#x6267;&#x884C;&#x7684;&#x547D;&#x4EE4;&#xFF0C;&#x5C06;&#x7CFB;&#x7EDF;&#x7684;&#x6807;&#x51C6;&#x8F93;&#x5165;&#x3001;&#x8F93;&#x51FA;&#x3001;&#x9519;&#x8BEF;&#x5BF9;&#x63A5;&#x8FC7;&#x53BB;&#xFF0C;&#x5E76;&#x4E14;&#x628A;&#x53C2;&#x6570;&#x4F20;&#x9012;&#x8FC7;&#x53BB;&#xFF0C;&#x7136;&#x540E;&#x5F00;&#x59CB;&#x6267;&#x884C;&#x3002;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ./strace ../hello/hello abcd</span><br><span class="line">Run [../hello/hello abcd]</span><br><span class="line">Hello, GopherCon!</span><br></pre></td></tr></table></figure>
<h2 id="tian-jia-ptrace-zhi-chi"><a href="#&#x6DFB;&#x52A0;-ptrace-&#x652F;&#x6301;" class="headerlink" title="&#x6DFB;&#x52A0; ptrace &#x652F;&#x6301;"></a>&#x6DFB;&#x52A0; <code>ptrace</code> &#x652F;&#x6301; <a href="#tian-jia-ptrace-zhi-chi" class="header-anchor">#</a></h2><p>&#x6DFB;&#x52A0; <code>ptrace</code> &#x652F;&#x6301;&#x975E;&#x5E38;&#x7B80;&#x5355;&#xFF0C;&#x8BBE;&#x7F6E; <code>cmd.SysProcAttr</code> &#x5373;&#x53EF;&#x3002;</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">  ...</span><br><span class="line">	cmd.Stdout = os.Stdout</span><br><span class="line">  <span class="comment">//  &#x8BBE;&#x7F6E; Ptrace &#x4E3A; true</span></span><br><span class="line">	cmd.SysProcAttr = &amp;syscall.SysProcAttr{</span><br><span class="line">		Ptrace: <span class="literal">true</span>,</span><br><span class="line">	}</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="comment">//  &#x4E3A;&#x4E86;&#x66F4;&#x660E;&#x663E;&#x7684;&#x770B;&#x51FA;&#x6548;&#x679C;&#xFF0C;&#x5728;&#x9000;&#x51FA;&#x524D;&#x7B49;&#x5F85;&#x4E00;&#x4F1A;&#x513F;</span></span><br><span class="line">	time.Sleep(time.Second * <span class="number">2</span>)</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x6B21;&#x518D;&#x6267;&#x884C;&#xFF0C;&#x5C31;&#x4F1A;&#x53D1;&#x73B0;&#xFF0C;&#x88AB;&#x8C03;&#x7528;&#x7684;&#x7A0B;&#x5E8F;&#x6682;&#x505C;&#x4E86;&#x4E00;&#x6BB5;&#x65F6;&#x95F4;&#xFF0C;&#x7136;&#x540E;&#x624D;&#x7EE7;&#x7EED;&#x6267;&#x884C;&#xFF1A;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ./strace ../hello/hello</span><br><span class="line">Run [../hello/hello]</span><br><span class="line"><span class="built_in">wait</span>() returned: stop signal: trace/breakpoint <span class="built_in">trap</span></span><br><span class="line"><span class="comment"># &lt;- &#x8FD9;&#x91CC;&#x7B49;&#x5019;&#x4E86;2&#x79D2;</span></span><br><span class="line">$ Hello, GopherCon!</span><br></pre></td></tr></table></figure>
<p>&#x7531;&#x4E8E;&#x542F;&#x7528;&#x4E86; <code>ptrace</code>&#xFF0C;&#x5F53; <code>hello</code> &#x88AB;&#x52A0;&#x8F7D;&#x540E;&#xFF0C;&#x5E76;&#x6CA1;&#x6709;&#x7ACB;&#x523B;&#x6267;&#x884C;&#xFF0C;&#x800C;&#x662F;&#x63A7;&#x5236;&#x6743;&#x56DE;&#x5230;&#x4E86;&#x6211;&#x4EEC;&#x8FD9;&#x4E2A;&#x7A0B;&#x5E8F;&#xFF0C;&#x5C31;&#x50CF;&#x662F;&#x65AD;&#x70B9;&#x4E00;&#x6837;&#x3002;&#x6240;&#x4EE5; <code>hello</code> &#x6682;&#x505C;&#x4E86;&#x4E00;&#x6BB5;&#x65F6;&#x95F4;&#x3002;&#x800C;&#x5F53; <code>time.Sleep()</code> &#x7ED3;&#x675F;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x7684;&#x4E3B;&#x7A0B;&#x5E8F;&#x9000;&#x51FA;&#xFF0C;&#x548C; <code>hello</code> &#x65AD;&#x5F00;&#x4E86;&#x8FD9;&#x4E2A;&#x63A7;&#x5236;&#x8054;&#x7CFB;&#xFF0C;&#x4E8E;&#x662F; <code>hello</code> &#x5C31;&#x7EE7;&#x7EED;&#x6267;&#x884C;&#xFF0C;&#x4E8E;&#x662F;&#x770B;&#x5230;&#x4E86;&#x540E;&#x9762;&#x7684; <code>Hello, GopherCon!</code> &#x4E86;&#x3002;</p>
<h2 id="da-yin-duan-dian-de-ji-cun-qi-bian-liang"><a href="#&#x6253;&#x5370;&#x65AD;&#x70B9;&#x7684;&#x5BC4;&#x5B58;&#x5668;&#x53D8;&#x91CF;" class="headerlink" title="&#x6253;&#x5370;&#x65AD;&#x70B9;&#x7684;&#x5BC4;&#x5B58;&#x5668;&#x53D8;&#x91CF;"></a>&#x6253;&#x5370;&#x65AD;&#x70B9;&#x7684;&#x5BC4;&#x5B58;&#x5668;&#x53D8;&#x91CF; <a href="#da-yin-duan-dian-de-ji-cun-qi-bian-liang" class="header-anchor">#</a></h2><p>&#x65E2;&#x7136;&#x662F;&#x65AD;&#x70B9;&#xFF0C;&#x63A7;&#x5236;&#x6743;&#x56DE;&#x5230;&#x4E3B;&#x7A0B;&#x5E8F;&#xFF0C;&#x90A3;&#x4E48;&#x6211;&#x4EEC;&#x5B9E;&#x9645;&#x4E0A;&#x53EF;&#x4EE5;&#x6253;&#x5370;&#x88AB;&#x8C03;&#x8BD5;&#x7A0B;&#x5E8F;&#x7684;&#x5BC4;&#x5B58;&#x5668;&#x53D8;&#x91CF;&#xFF1A;</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pid := cmd.Process.Pid</span><br><span class="line"><span class="keyword">var</span> regs syscall.PtraceRegs</span><br><span class="line"><span class="keyword">if</span> err = syscall.PtraceGetRegs(pid, &amp;regs); err != <span class="literal">nil</span> {</span><br><span class="line">	<span class="built_in">panic</span>(err)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">fmt.Printf(<span class="string">&quot;%#v\n&quot;</span>, regs)</span><br></pre></td></tr></table></figure>
<p>&#x7136;&#x540E;&#x518D;&#x6B21;&#x6267;&#x884C;&#x6211;&#x4EEC;&#x7684; strace&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x5BC4;&#x5B58;&#x5668;&#x4FE1;&#x606F;&#x4E86;&#xFF1A;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ./strace ../hello/hello</span><br><span class="line">Run [../hello/hello]</span><br><span class="line"><span class="built_in">wait</span>() returned: stop signal: trace/breakpoint <span class="built_in">trap</span></span><br><span class="line">syscall.PtraceRegs{R15:0x0, R14:0x0, R13:0x0, R12:0x0, Rbp:0x0, Rbx:0x0, R11:0x0, R10:0x0, R9:0x0, R8:0x0, Rax:0x0, Rcx:0x0, Rdx:0x0, Rsi:0x0, Rdi:0x0, Orig_rax:0x3b, Rip:0x452060, Cs:0x33, Eflags:0x200, Rsp:0x7ffe862afdf0, Ss:0x2b, Fs_base:0x0, Gs_base:0x0, Ds:0x0, Es:0x0, Fs:0x0, Gs:0x0}</span><br><span class="line">$ Hello, GopherCon!</span><br></pre></td></tr></table></figure>
<p><code>hello</code> &#x6240;&#x6709;&#x65AD;&#x70B9;&#x4F4D;&#x7F6E;&#x7684;&#x5BC4;&#x5B58;&#x5668;&#x4FE1;&#x606F;&#x6211;&#x4EEC;&#x5C31;&#x90FD;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x4E86;&#x3002;&#x8FD8;&#x8BB0;&#x5F97;&#x6211;&#x4EEC;&#x4E4B;&#x524D;&#x8BF4;&#x8FC7;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x90FD;&#x7528;&#x4E86;&#x54EA;&#x4E9B;&#x5BC4;&#x5B58;&#x5668;&#x4E48;&#xFF1F;<code>%rax</code> &#x5E94;&#x8BE5;&#x5B58;&#x50A8;&#x7684;&#x662F;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x53F7;&#x7684;&#xFF0C;&#x800C;&#x8FD9;&#x91CC;&#x7684; <code>Rax:0x0</code>&#xFF0C;&#x7ECF;&#x8FC7;&#x4E86;&#x89E3;&#x540E;&#xFF0C;&#x5B9E;&#x9645;&#x7684;&#x65AD;&#x70B9;&#x4F4D;&#x7F6E;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x5B58;&#x5728;&#x4E8E; <code>Orig_rax:0x3b</code>&#x3002;<code>0x3b</code>&#xFF0C;&#x4E5F;&#x5C31;&#x662F; <code>59</code> &#x53F7;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#xFF0C;&#x67E5;&#x8BE2;&#x4E4B;&#x524D;&#x7684;&#x8868;&#x683C;&#xFF0C;&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#x5728; Linux &#x91CC;&#x5BF9;&#x5E94;&#x7684;&#x662F; <code>sys_execve</code>&#x3002;</p>
<h2 id="shu-chu-xi-tong-diao-yong-ming-cheng"><a href="#&#x8F93;&#x51FA;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x540D;&#x79F0;" class="headerlink" title="&#x8F93;&#x51FA;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x540D;&#x79F0;"></a>&#x8F93;&#x51FA;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x540D;&#x79F0; <a href="#shu-chu-xi-tong-diao-yong-ming-cheng" class="header-anchor">#</a></h2><p>&#x65E2;&#x7136;&#x77E5;&#x9053;&#x4E86;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x53F7;&#xFF0C;&#x53EF;&#x4E0D;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x6253;&#x5370;&#x51FA;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x540D;&#x5B57;&#xFF1F;&#x5728; Go &#x4E2D;&#xFF0C;&#x8FD9;&#x5F88;&#x5BB9;&#x6613;&#xFF0C;&#x4F7F;&#x7528; <code>github.com/seccomp/libseccomp-golang</code> &#x5373;&#x53EF;&#xFF0C;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x8FDB;&#x884C;&#x4E00;&#x5C42;&#x5C01;&#x88C5;&#xFF0C;&#x5C01;&#x88C5;&#x4E3A; <code>syscallCounter</code>&#xFF0C;&#x7136;&#x540E;&#x5728;&#x6211;&#x4EEC;&#x7684; <code>main.go</code> &#x4E2D;&#x8C03;&#x7528;&#xFF1A;</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ss syscallCounter</span><br><span class="line">ss = ss.init()</span><br><span class="line"></span><br><span class="line">name := ss.getName(regs.Orig_rax)</span><br><span class="line">fmt.Printf(<span class="string">&quot;%s\n&quot;</span>, name)</span><br></pre></td></tr></table></figure>
<p>&#x7136;&#x540E;&#x518D;&#x6B21;&#x8FD0;&#x884C;&#xFF0C;&#x5C31;&#x4F1A;&#x770B;&#x5230;&#x8F93;&#x51FA;&#x7684;&#x540D;&#x5B57; <code>execve</code> &#x4E86;&#xFF1A;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ./strace ../hello/hello</span><br><span class="line">Run [../hello/hello]</span><br><span class="line"><span class="built_in">wait</span>() returned: stop signal: trace/breakpoint <span class="built_in">trap</span></span><br><span class="line">execve</span><br><span class="line">$ Hello, GopherCon!</span><br></pre></td></tr></table></figure>
<h2 id="shu-chu-suo-you-de-xi-tong-diao-yong"><a href="#&#x8F93;&#x51FA;&#x6240;&#x6709;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;" class="headerlink" title="&#x8F93;&#x51FA;&#x6240;&#x6709;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;"></a>&#x8F93;&#x51FA;&#x6240;&#x6709;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528; <a href="#shu-chu-suo-you-de-xi-tong-diao-yong" class="header-anchor">#</a></h2><p>&#x8FD9;&#x53EA;&#x662F;&#x78B0;&#x5230;&#x7684;&#x7B2C;&#x4E00;&#x4E2A; <code>syscall</code>&#xFF0C;&#x5982;&#x4F55;&#x624D;&#x80FD;&#x663E;&#x793A;&#x63A5;&#x4E0B;&#x6765;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x5462;&#xFF1F;</p>
<p><code>ptrace</code> &#x5141;&#x8BB8;&#x6307;&#x5B9A;&#x5728;&#x4E0B;&#x4E00;&#x4E2A;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7684;&#x65F6;&#x5019;&#x6682;&#x505C;&#xFF0C;&#x6240;&#x4EE5;&#x53EA;&#x9700;&#x8981;&#x5728;&#x6253;&#x5370; <code>syscall</code> &#x540D;&#x5B57;&#x4E4B;&#x540E;&#xFF0C;&#x52A0;&#x5165;&#x8FD9;&#x90E8;&#x5206;&#x8BBE;&#x7F6E;&#xFF0C;&#x7136;&#x540E;&#x6574;&#x4F53;&#x5FAA;&#x73AF;&#x5C31;&#x597D;&#x4E86;&#x3002;</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">for</span> {</span><br><span class="line">	<span class="comment">//	&#x6253;&#x5370;&#x65AD;&#x70B9;&#x5BC4;&#x5B58;&#x5668;&#x503C;</span></span><br><span class="line">	<span class="keyword">if</span> err = syscall.PtraceGetRegs(pid, &amp;regs); err != <span class="literal">nil</span> {</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	}</span><br><span class="line">	<span class="comment">// fmt.Printf(&quot;%#v\n&quot;, regs)</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//	&#x8F93;&#x51FA;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7684;&#x540D;&#x5B57;</span></span><br><span class="line">	<span class="keyword">var</span> ss syscallCounter</span><br><span class="line">	ss = ss.init()</span><br><span class="line">	name := ss.getName(regs.Orig_rax)</span><br><span class="line">	fmt.Printf(<span class="string">&quot;%s\n&quot;</span>, name)</span><br><span class="line"></span><br><span class="line">	<span class="comment">//	&#x8981;&#x6C42;&#x5728;&#x4E0B;&#x4E00;&#x4E2A;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7684;&#x65F6;&#x5019;&#x6682;&#x505C;</span></span><br><span class="line">	<span class="keyword">if</span> err := syscall.PtraceSyscall(pid, <span class="number">0</span>); err != <span class="literal">nil</span> {</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">//	&#x5F00;&#x59CB;&#x7B49;&#x5F85;&#x4E0B;&#x4E00;&#x4E2A;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;</span></span><br><span class="line">	<span class="keyword">if</span> _, err = syscall.Wait4(pid, <span class="literal">nil</span>, <span class="number">0</span>, <span class="literal">nil</span>); err != <span class="literal">nil</span> {</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x6B21;&#x6211;&#x4EEC;&#x518D;&#x6267;&#x884C;&#x6211;&#x4EEC;&#x7684; strace&#xFF0C;&#x5C31;&#x4F1A;&#x53D1;&#x73B0;&#x6240;&#x6709;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x90FD;&#x6253;&#x5370;&#x51FA;&#x6765;&#x4E86;&#xFF1A;</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ ./strace ../hello/hello</span><br><span class="line">Run [../hello/hello]</span><br><span class="line">wait() returned: stop signal: trace/breakpoint trap</span><br><span class="line">execve</span><br><span class="line">arch_prctl</span><br><span class="line">arch_prctl</span><br><span class="line">sched_getaffinity</span><br><span class="line">sched_getaffinity</span><br><span class="line">mmap</span><br><span class="line">mmap</span><br><span class="line">munmap</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">futex</span><br><span class="line">futex</span><br><span class="line">readlinkat</span><br><span class="line">readlinkat</span><br><span class="line">mmap</span><br><span class="line">mmap</span><br><span class="line">write</span><br><span class="line">Hello, GopherCon!</span><br><span class="line">write</span><br><span class="line">exit_group</span><br><span class="line"><span class="built_in">panic</span>: no such process</span><br><span class="line"></span><br><span class="line">goroutine <span class="number">1</span> [running]:</span><br><span class="line">main.main()</span><br><span class="line">        /vagrant/syscall/strace/main.<span class="keyword">go</span>:<span class="number">36</span> +<span class="number">0x530</span></span><br></pre></td></tr></table></figure>
<p>&#x4E0D;&#x8FC7;&#x6CE8;&#x610F;&#x5230;&#x6700;&#x540E;&#x51FA;&#x73B0;&#x4E86; <code>panic: no such process</code> &#x4E86;&#x4E48;&#xFF1F;&#x8FD9;&#x662F;&#x56E0;&#x4E3A; <code>hello</code> &#x7A0B;&#x5E8F;&#x6267;&#x884C;&#x5B8C;&#x540E;&#x9000;&#x51FA;&#x4E86;&#xFF0C;&#x6240;&#x4EE5;&#x81EA;&#x7136;&#x6211;&#x4EEC;&#x7684; <code>main()</code> &#x7A0B;&#x5E8F;&#x65E0;&#x6CD5;&#x7EE7;&#x7EED;&#x53D6;&#x5F97;&#x5176;&#x5BC4;&#x5B58;&#x5668;&#x7684;&#x503C;&#x4E86;&#x3002;</p>
<p>&#x600E;&#x4E48;&#x624D;&#x80FD;&#x4E0D; <code>panic</code> &#x5462;&#xFF1F;&#x5F88;&#x7B80;&#x5355;&#x561B;&#xFF0C;&#x6211;&#x4EEC;&#x5728;<code>36</code>&#x884C;&#x90A3;&#x91CC;&#xFF0C;&#x53BB;&#x6389; <code>panic()</code>&#xFF0C;&#x76F4;&#x63A5; <code>break</code> &#x51FA;&#x5FAA;&#x73AF;&#x5373;&#x53EF;&#x3002;&#x7136;&#x540E;&#x5C31;&#x6CA1;&#x6709; <code>panic</code> &#x5566;&#x3002;&#x1F638;</p>
<h2 id="qi-shi-ptrace-hui-ting-liang-ci"><a href="#&#x5176;&#x5B9E;-ptrace-&#x4F1A;&#x505C;&#x4E24;&#x6B21;&#x2026;&#x2026;" class="headerlink" title="&#x5176;&#x5B9E; ptrace &#x4F1A;&#x505C;&#x4E24;&#x6B21;&#x2026;&#x2026;"></a>&#x5176;&#x5B9E; <code>ptrace</code> &#x4F1A;&#x505C;&#x4E24;&#x6B21;&#x2026;&#x2026; <a href="#qi-shi-ptrace-hui-ting-liang-ci" class="header-anchor">#</a></h2><p>&#x5982;&#x679C;&#x4ED4;&#x7EC6;&#x89C2;&#x5BDF;&#x4E4B;&#x524D;&#x7684;&#x8F93;&#x51FA;&#xFF1A;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line">readlinkat</span><br><span class="line">readlinkat</span><br><span class="line">mmap</span><br><span class="line">mmap</span><br><span class="line">futex</span><br><span class="line">futex</span><br><span class="line">futex</span><br><span class="line">futex</span><br><span class="line">write</span><br><span class="line">Hello, GopherCon!</span><br><span class="line">write</span><br><span class="line">exit_group</span><br></pre></td></tr></table></figure>
<p>&#x6CE8;&#x610F;&#x5230;&#x8C8C;&#x4F3C;&#x6BCF;&#x4E2A;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x90FD;&#x6210;&#x5BF9;&#x51FA;&#x73B0;&#x4E48;&#xFF1F;&#x7279;&#x522B;&#x662F; <code>Hello, GopherCon!</code> &#x7684;&#x524D;&#x540E;&#x5404;&#x5939;&#x4E86;&#x4E00;&#x4E2A; <code>write</code>&#x3002;&#x771F;&#x7684;&#x8FD9;&#x4E48;&#x6574;&#x9F50;&#x7684;&#x90FD;&#x662F;&#x4E24;&#x6B21;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x4E48;&#xFF1F;&#x4E0D;&#x662F;&#x7684;&#x3002;&#x5176;&#x5B9E;<strong>&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x53EA;&#x53D1;&#x751F;&#x4E86;&#x4E00;&#x6B21;</strong>&#xFF0C;&#x4E0D;&#x8FC7;&#x6211;&#x4EEC;&#x7684;&#x7A0B;&#x5E8F;&#x5374;<strong>&#x505C;&#x4E86;&#x4E24;&#x6B21;</strong>&#x3002;</p>
<p>&#x5982;&#x679C;&#x4ED4;&#x7EC6;&#x770B; <code>ptrace</code> &#x7684; <a href="http://man7.org/linux/man-pages/man2/ptrace.2.html" target="_blank" rel="noopener">manpage</a> &#x7684;&#x8BDD;&#xFF0C;&#x7FFB;&#x5230;&#x540E;&#x9762;&#xFF0C;&#x4F1A;&#x53D1;&#x73B0;&#x5B83;&#x63D0;&#x5230;&#xFF0C;&#x5728;&#x88AB;&#x76D1;&#x542C;&#x7A0B;&#x5E8F;&#x8FDB;&#x5165; <code>syscall</code> &#x4E4B;&#x524D;&#xFF0C;&#x4F1A;&#x505C;&#x4E00;&#x4E0B;&#xFF0C;&#x53EB;&#x505A; <code>syscall-enter-stop</code>&#xFF0C;&#x800C;&#x5728;&#x4ECE; <code>syscall</code> &#x8FD4;&#x56DE;&#x540E;&#xFF0C;&#x8FD8;&#x4F1A;&#x505C;&#x4E00;&#x4E0B;&#xFF0C;&#x53EB;&#x505A; <code>syscall-exit-stop</code>&#x3002;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x5B9E;&#x9645;&#x4E0A;&#x5BF9;&#x4E8E;&#x6BCF;&#x4E2A;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x90FD;&#x8F93;&#x51FA;&#x4E86;&#x4E24;&#x8FB9;&#x540D;&#x5B57;&#xFF0C;&#x800C;&#x4E14;&#x4E00;&#x6B21;&#x662F;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x4E4B;&#x524D;&#x3001;&#x4E00;&#x6B21;&#x662F;&#x4E4B;&#x540E;&#x3002;&#x6240;&#x4EE5;&#x5C31;&#x51FA;&#x73B0;&#x4E86;&#x4E09;&#x660E;&#x6CBB;&#x5F62;&#x5F0F;&#x7684;&#x8F93;&#x51FA;&#x4E86;&#xFF1A;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">write</span><br><span class="line">Hello, GopherCon!</span><br><span class="line">write</span><br></pre></td></tr></table></figure>
<p>&#x6BD4;&#x8F83;&#x90C1;&#x95F7;&#x7684;&#x662F;&#xFF0C;&#x4EC5;&#x4ECE;&#x8FD4;&#x56DE;&#x7ED3;&#x679C;&#x6765;&#x770B;&#xFF0C;&#x6211;&#x4EEC;&#x6CA1;&#x6709;&#x529E;&#x6CD5;&#x533A;&#x5206;&#x54EA;&#x6B21;&#x662F; <code>syscall-enter-stop</code>&#xFF0C;&#x54EA;&#x6B21;&#x662F; <code>syscall-exit-stop</code>&#x3002;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x53EA;&#x80FD;&#x5728;&#x5916;&#x9762;&#x505A;&#x4E00;&#x4E2A; tik-tok &#x7684;&#x6807;&#x5FD7;&#x4F4D;&#xFF0C;&#x6765;&#x8868;&#x660E;&#x5230;&#x5E95;&#x662F;&#x5565;&#x3002;</p>
<p>&#x6211;&#x4EEC;&#x518D;&#x6B21;&#x4FEE;&#x6539;&#x7A0B;&#x5E8F;&#xFF0C;&#x6DFB;&#x52A0;&#x4E00;&#x4E2A; <code>exit</code> &#x6807;&#x5FD7;&#x4F4D;&#x3002;</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//	&#x662F;&#x5426;&#x662F; syscall-exit-stop &#x7684;&#x6807;&#x5FD7;&#x4F4D;</span></span><br><span class="line">exit := <span class="literal">true</span></span><br><span class="line"><span class="keyword">for</span> {</span><br><span class="line">	<span class="comment">//	&#x5982;&#x679C;&#x662F; syscall-exit-stop &#x5C31;&#x6253;&#x5370;</span></span><br><span class="line">	<span class="keyword">if</span> exit {</span><br><span class="line">		<span class="comment">//	&#x6253;&#x5370;&#x65AD;&#x70B9;&#x5BC4;&#x5B58;&#x5668;&#x503C;</span></span><br><span class="line">		<span class="keyword">if</span> err := syscall.PtraceGetRegs(pid, &amp;regs); err != <span class="literal">nil</span> {</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		}</span><br><span class="line">		<span class="comment">// fmt.Printf(&quot;%#v\n&quot;, regs)</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">//	&#x8F93;&#x51FA;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7684;&#x540D;&#x5B57;</span></span><br><span class="line">		<span class="keyword">var</span> ss syscallCounter</span><br><span class="line">		ss = ss.init()</span><br><span class="line">		name := ss.getName(regs.Orig_rax)</span><br><span class="line">		fmt.Printf(<span class="string">&quot;%s\n&quot;</span>, name)</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">//	&#x8981;&#x6C42;&#x5728;&#x4E0B;&#x4E00;&#x4E2A;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7684;&#x65F6;&#x5019;&#x6682;&#x505C;</span></span><br><span class="line">	<span class="keyword">if</span> err := syscall.PtraceSyscall(pid, <span class="number">0</span>); err != <span class="literal">nil</span> {</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">//	&#x5F00;&#x59CB;&#x7B49;&#x5F85;&#x4E0B;&#x4E00;&#x4E2A;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;</span></span><br><span class="line">	<span class="keyword">if</span> _, err := syscall.Wait4(pid, <span class="literal">nil</span>, <span class="number">0</span>, <span class="literal">nil</span>); err != <span class="literal">nil</span> {</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">//	&#x6BCF;&#x6B21;&#x5FAA;&#x73AF;&#x7FFB;&#x8F6C;&#x4E00;&#x4E0B;&#xFF0C;&#x6765;&#x8868;&#x660E; enter, exit &#x8FD9;&#x4E00;&#x5BF9;&#x72B6;&#x6001;</span></span><br><span class="line">	exit = !exit</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<blockquote>
<p>&#x6CE8;&#x610F;&#x8FD9;&#x91CC; <code>exit</code> &#x7684;&#x521D;&#x59CB;&#x503C;&#x4E3A; <code>true</code>&#xFF0C;&#x8FD9;&#x662F;&#x56E0;&#x4E3A;&#x7B2C;&#x4E00;&#x6B21;&#x505C;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x662F; <code>execve</code> &#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x3002;&#x719F;&#x6089; Unix/Linux &#x7A0B;&#x5E8F;&#x8BBE;&#x8BA1;&#x7684;&#x4EBA;&#x5E94;&#x8BE5;&#x4E00;&#x4E0B;&#x5C31;&#x53CD;&#x5E94;&#x8FC7;&#x6765;&#x4E86;&#xFF0C;&#x8FD9;&#x662F;&#x7236;&#x8FDB;&#x7A0B;&#x5EFA;&#x7ACB;&#x5B50;&#x8FDB;&#x7A0B;&#x7684;&#x51FD;&#x6570;/&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x3002;&#x5F53;&#x5B50;&#x8FDB;&#x7A0B;&#x7B2C;&#x4E00;&#x6B21;&#x8FDB;&#x5165;&#x7528;&#x6237;&#x6001;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5FC5;&#x7136;&#x662F;&#x4ECE;&#x8FD9;&#x4E2A;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x8FD4;&#x56DE;&#x3002;&#x6362;&#x53E5;&#x8BDD;&#x8BF4;&#xFF0C;&#x8FD9;&#x4E2A; <code>syscall</code> &#x662F;&#x7531;&#x7236;&#x8FDB;&#x7A0B;&#x53D1;&#x8D77;&#x7684;&#xFF0C;&#x5206;&#x522B;&#x5728;&#x5B50;&#x8FDB;&#x7A0B;&#x548C;&#x7236;&#x8FDB;&#x7A0B;&#x4E2D;&#x8FD4;&#x56DE;&#x3002;&#x56E0;&#x6B64;&#x5F53; <code>ptrace</code> &#x7B2C;&#x4E00;&#x6B21;&#x622A;&#x83B7;&#x5B50;&#x8FDB;&#x7A0B;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x4E8B;&#x4EF6;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4E00;&#x5B9A;&#x662F;<strong>&#x9000;&#x51FA;</strong>&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7684;&#x72B6;&#x6001;&#x3002;</p>
</blockquote>
<p>&#x8FD9;&#x4E00;&#x6B21;&#x518D;&#x8F93;&#x51FA;&#xFF0C;&#x5C31;&#x4F1A;&#x53D1;&#x73B0;&#x6210;&#x5BF9;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x53EA;&#x5269;&#x4E0B;&#x540E;&#x534A;&#x90E8;&#x5206;&#x4E86;&#xFF1A;</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ ./strace ../hello/hello</span><br><span class="line">Run [../hello/hello]</span><br><span class="line">wait() returned: stop signal: trace/breakpoint trap</span><br><span class="line">execve</span><br><span class="line">arch_prctl</span><br><span class="line">sched_getaffinity</span><br><span class="line">mmap</span><br><span class="line">munmap</span><br><span class="line">mmap</span><br><span class="line">mmap</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">clone</span><br><span class="line">rt_sigprocmask</span><br><span class="line">futex</span><br><span class="line">futex</span><br><span class="line">futex</span><br><span class="line">readlinkat</span><br><span class="line">mmap</span><br><span class="line">futex</span><br><span class="line">Hello, GopherCon!</span><br><span class="line">write</span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x56DE;&#x5C31;&#x5BF9;&#x4E86;&#xFF0C;&#x6211;&#x4EEC;&#x90FD;&#x662F;&#x5728;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x8FD4;&#x56DE;&#x540E;&#xFF0C;&#x624D;&#x6253;&#x5370;&#x8BE5;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x3002;&#x56E0;&#x6B64; <code>Hello, GopherCon!</code> &#x662F;&#x53D1;&#x751F;&#x5728;&#x6253;&#x5370; <code>write</code> &#x4E4B;&#x524D;&#x3002;</p>
<h2 id="hui-zong-xi-tong-diao-yong"><a href="#&#x6C47;&#x603B;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;" class="headerlink" title="&#x6C47;&#x603B;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;"></a>&#x6C47;&#x603B;&#x7CFB;&#x7EDF;&#x8C03;&#x7528; <a href="#hui-zong-xi-tong-diao-yong" class="header-anchor">#</a></h2><p>&#x6211;&#x4EEC;&#x4E4B;&#x524D;&#x770B;&#x8FC7; <code>strace -c</code> &#x8FD9;&#x4E2A;&#x6C47;&#x603B;&#x7684;&#x7ED3;&#x679C;&#xFF0C;&#x770B;&#x8D77;&#x6765;&#x4E0D;&#x9519;&#x3002;&#x6211;&#x4EEC;&#x8FD9;&#x91CC;&#x5B9E;&#x73B0;&#x4E00;&#x4E0B;&#x3002;</p>
<p>&#x8FD9;&#x91CC;&#x9488;&#x5BF9; <code>syscallCounter</code> &#x5B9E;&#x73B0;&#x4E00;&#x4E2A;&#x8BA1;&#x6570;&#x51FD;&#x6570; <code>ss.inc()</code> &#x548C;&#x4E00;&#x4E2A;&#x6C47;&#x603B;&#x8F93;&#x51FA;&#x51FD;&#x6570; <code>ss.print()</code>&#xFF1A;</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  syscall_counter.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s syscallCounter)</span> <span class="title">inc</span><span class="params">(syscallID <span class="keyword">uint64</span>)</span> <span class="title">error</span></span> {</span><br><span class="line">	<span class="keyword">if</span> syscallID &gt; maxSyscalls {</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;invalid syscall ID (%x)&quot;</span>, syscallID)</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	s[syscallID]++</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s syscallCounter)</span> <span class="title">print</span><span class="params">()</span></span> {</span><br><span class="line">	w := tabwriter.NewWriter(os.Stdout, <span class="number">0</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="string">&apos; &apos;</span>, tabwriter.AlignRight|tabwriter.Debug)</span><br><span class="line">	<span class="keyword">for</span> k, v := <span class="keyword">range</span> s {</span><br><span class="line">		<span class="keyword">if</span> v &gt; <span class="number">0</span> {</span><br><span class="line">			name, _ := sec.ScmpSyscall(k).GetName()</span><br><span class="line">			fmt.Fprintf(w, <span class="string">&quot;%d\t%s\n&quot;</span>, v, name)</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">	w.Flush()</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x7136;&#x540E;&#x5728;&#x6BCF;&#x6B21;&#x6253;&#x5370;&#x51FD;&#x6570;&#x540D;&#x7684;&#x5730;&#x65B9;&#x52A0;&#x5165; <code>ss.inc(regs.Orig_rax)</code> &#x5373;&#x53EF;&#x3002;</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">	fmt.Printf(<span class="string">&quot;Run %v\n&quot;</span>, os.Args[<span class="number">1</span>:])</span><br><span class="line"></span><br><span class="line">	<span class="comment">//	&#x521B;&#x5EFA;&#x8C03;&#x7528;&#x7684;&#x547D;&#x4EE4;</span></span><br><span class="line">	cmd := exec.Command(os.Args[<span class="number">1</span>], os.Args[<span class="number">2</span>:]...)</span><br><span class="line">	cmd.Stderr = os.Stderr</span><br><span class="line">	cmd.Stdin = os.Stdin</span><br><span class="line">	cmd.Stdout = os.Stdout</span><br><span class="line">	<span class="comment">//	&#x542F;&#x7528; ptrace</span></span><br><span class="line">	cmd.SysProcAttr = &amp;syscall.SysProcAttr{</span><br><span class="line">		Ptrace: <span class="literal">true</span>,</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">//	&#x542F;&#x52A8;&#x7A0B;&#x5E8F;</span></span><br><span class="line">	cmd.Start()</span><br><span class="line">	err := cmd.Wait()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">		fmt.Printf(<span class="string">&quot;wait() returned: %v\n&quot;</span>, err)</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	pid := cmd.Process.Pid</span><br><span class="line">	<span class="keyword">var</span> regs syscall.PtraceRegs</span><br><span class="line">	<span class="keyword">var</span> ss syscallCounter</span><br><span class="line">	ss = ss.init()</span><br><span class="line"></span><br><span class="line">	<span class="comment">//	&#x662F;&#x5426;&#x662F; syscall-exit-stop &#x7684;&#x6807;&#x5FD7;&#x4F4D;</span></span><br><span class="line">	exit := <span class="literal">true</span></span><br><span class="line">	<span class="keyword">for</span> {</span><br><span class="line">		<span class="comment">//	&#x5982;&#x679C;&#x662F; syscall-exit-stop &#x5C31;&#x6253;&#x5370;</span></span><br><span class="line">		<span class="keyword">if</span> exit {</span><br><span class="line">			<span class="comment">//	&#x6253;&#x5370;&#x65AD;&#x70B9;&#x5BC4;&#x5B58;&#x5668;&#x503C;</span></span><br><span class="line">			<span class="keyword">if</span> err := syscall.PtraceGetRegs(pid, &amp;regs); err != <span class="literal">nil</span> {</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			}</span><br><span class="line">			<span class="comment">// fmt.Printf(&quot;%#v\n&quot;, regs)</span></span><br><span class="line"></span><br><span class="line">			<span class="comment">//	&#x8F93;&#x51FA;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7684;&#x540D;&#x5B57;</span></span><br><span class="line">			name := ss.getName(regs.Orig_rax)</span><br><span class="line">			fmt.Printf(<span class="string">&quot;%s\n&quot;</span>, name)</span><br><span class="line"></span><br><span class="line">			<span class="comment">//	&#x5BF9;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x8BA1;&#x6570;</span></span><br><span class="line">			ss.inc(regs.Orig_rax)</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="comment">//	&#x8981;&#x6C42;&#x5728;&#x4E0B;&#x4E00;&#x4E2A;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7684;&#x65F6;&#x5019;&#x6682;&#x505C;</span></span><br><span class="line">		<span class="keyword">if</span> err := syscall.PtraceSyscall(pid, <span class="number">0</span>); err != <span class="literal">nil</span> {</span><br><span class="line">			<span class="built_in">panic</span>(err)</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="comment">//	&#x5F00;&#x59CB;&#x7B49;&#x5F85;&#x4E0B;&#x4E00;&#x4E2A;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;</span></span><br><span class="line">		<span class="keyword">if</span> _, err := syscall.Wait4(pid, <span class="literal">nil</span>, <span class="number">0</span>, <span class="literal">nil</span>); err != <span class="literal">nil</span> {</span><br><span class="line">			<span class="built_in">panic</span>(err)</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="comment">//	&#x6BCF;&#x6B21;&#x5FAA;&#x73AF;&#x7FFB;&#x8F6C;&#x4E00;&#x4E0B;&#xFF0C;&#x6765;&#x8868;&#x660E; enter, exit &#x8FD9;&#x4E00;&#x5BF9;&#x72B6;&#x6001;</span></span><br><span class="line">		exit = !exit</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">//	&#x8F93;&#x51FA;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x6C47;&#x603B;</span></span><br><span class="line">	ss.<span class="built_in">print</span>()</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x4E00;&#x6B21;&#x518D;&#x6765;&#x8F93;&#x51FA;&#x770B;&#x770B;&#x3002;</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ ./strace ../hello/hello</span><br><span class="line">Run [../hello/hello]</span><br><span class="line">wait() returned: stop signal: trace/breakpoint trap</span><br><span class="line">execve</span><br><span class="line">arch_prctl</span><br><span class="line">sched_getaffinity</span><br><span class="line">mmap</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">readlinkat</span><br><span class="line">futex</span><br><span class="line">mmap</span><br><span class="line">Hello, GopherCon!</span><br><span class="line">write</span><br><span class="line">          <span class="number">1</span>|write</span><br><span class="line">          <span class="number">8</span>|mmap</span><br><span class="line">          <span class="number">1</span>|munmap</span><br><span class="line">        <span class="number">114</span>|rt_sigaction</span><br><span class="line">          <span class="number">8</span>|rt_sigprocmask</span><br><span class="line">          <span class="number">3</span>|clone</span><br><span class="line">          <span class="number">1</span>|execve</span><br><span class="line">          <span class="number">2</span>|sigaltstack</span><br><span class="line">          <span class="number">1</span>|arch_prctl</span><br><span class="line">          <span class="number">1</span>|gettid</span><br><span class="line">          <span class="number">3</span>|futex</span><br><span class="line">          <span class="number">1</span>|sched_getaffinity</span><br><span class="line">          <span class="number">1</span>|readlinkat</span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x6B21;&#x5C31;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x6C47;&#x603B;&#x6570;&#x636E;&#x4E86;&#x3002;&#x1F601;</p>
<h1 id="syscall-yu-xi-tong-an-quan"><a href="#syscall-&#x4E0E;&#x7CFB;&#x7EDF;&#x5B89;&#x5168;" class="headerlink" title="syscall &#x4E0E;&#x7CFB;&#x7EDF;&#x5B89;&#x5168;"></a>syscall &#x4E0E;&#x7CFB;&#x7EDF;&#x5B89;&#x5168; <a href="#syscall-yu-xi-tong-an-quan" class="header-anchor">#</a></h1><ul>
<li>&#x5BF9;&#x4E8E;&#x5FAE;&#x670D;&#x52A1;&#x800C;&#x8A00;&#xFF0C;&#x6BCF;&#x4E2A;&#x670D;&#x52A1;&#x53EA;&#x4F1A;&#x6267;&#x884C;&#x5F88;&#x5C11;&#x4E00;&#x90E8;&#x5206;&#x529F;&#x80FD;</li>
<li>&#x5BF9;&#x4E8E;&#x5B89;&#x5168;&#x800C;&#x8A00;&#xFF0C;&#x5219;&#x8FFD;&#x6C42;&#x7684;&#x662F;<strong>&#x6700;&#x5C0F;&#x6743;&#x9650;</strong>&#x7684;&#x539F;&#x5219;</li>
</ul>
<p>&#x4ECE;&#x524D;&#x9762;&#x7684;&#x8F93;&#x51FA;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x8FD9;&#x4E2A; <code>hello</code> &#x7A0B;&#x5E8F;&#x53EA;&#x9700;&#x8981;&#x5341;&#x51E0;&#x4E2A; <code>syscall</code>&#xFF0C;&#x90A3;&#x4E48;&#x5BF9;&#x4E8E;&#x62E5;&#x6709; <code>330</code> &#x591A;&#x4E2A; <code>syscall</code> &#x7684; Linux &#x5185;&#x6838;&#x800C;&#x8A00;&#xFF0C;&#x7EDD;&#x5927;&#x591A;&#x6570;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x6211;&#x4EEC;&#x90FD;&#x4E0D;&#x9700;&#x8981;&#x3002;&#x66F4;&#x4F55;&#x51B5;&#x73B0;&#x5728;&#x6211;&#x4EEC;&#x5DF2;&#x7ECF;&#x4E86;&#x89E3;&#x5230; <code>ptrace</code> &#x8FD9;&#x4E2A;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x662F;&#x975E;&#x5E38;&#x5371;&#x9669;&#x7684;&#xFF0C;&#x4E0D;&#x5E94;&#x8BE5;&#x5141;&#x8BB8;&#x4E0D;&#x9700;&#x8981;&#x7684;&#x7A0B;&#x5E8F;&#x6709;&#x8FD9;&#x4E2A;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7684;&#x80FD;&#x529B;&#x3002;</p>
<p>&#x90A3;&#x4E48;&#x6216;&#x8BB8;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x7EA6;&#x675F;&#xFF0C;&#x9650;&#x5B9A;&#x8FD9;&#x4E2A; <code>hello</code> &#x53EA;&#x53EF;&#x4EE5;&#x7528;&#x8FD9;&#x5341;&#x51E0;&#x4E2A;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#xFF0C;&#x5176;&#x5B83;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x90FD;&#x4E0D;&#x5141;&#x8BB8;&#x3002;&#x8FD9;&#x6837;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;<strong>&#x7F29;&#x5C0F;&#x653B;&#x51FB;&#x9762;&#x79EF;</strong>&#xFF0C;&#x4EE5;&#x6EE1;&#x8DB3;<strong>&#x6700;&#x5C0F;&#x6743;&#x9650;</strong>&#x7684;&#x5B89;&#x5168;&#x9700;&#x6C42;&#x3002;</p>
<p>&#x5BF9;&#x4E8E;&#x4F20;&#x7EDF;&#x7684;&#x81C3;&#x80BF;&#x7684;&#x5E94;&#x7528;&#x800C;&#x8A00;&#xFF0C;&#x53EF;&#x80FD;&#x610F;&#x4E49;&#x4E0D;&#x5927;&#xFF0C;&#x56E0;&#x4E3A;&#x5E94;&#x7528;&#x53EF;&#x80FD;&#x4F1A;&#x4EC0;&#x4E48;&#x90FD;&#x5E72;&#xFF0C;&#x5BFC;&#x81F4;&#x7528;&#x4E86;&#x5F88;&#x591A;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x3002;&#x4F46;&#x662F;&#x5BF9;&#x4E8E;&#x5FAE;&#x670D;&#x52A1;&#x800C;&#x8A00;&#xFF0C;&#x6BCF;&#x4E2A;&#x670D;&#x52A1;&#x90FD;&#x5F88;&#x5C0F;&#xFF0C;&#x53EA;&#x505A;&#x7279;&#x5B9A;&#x7684;&#x4E8B;&#x60C5;&#xFF0C;&#x90A3;&#x4E48;&#x5176;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7684;&#x4F7F;&#x7528;&#x5C31;&#x4F1A;&#x88AB;&#x9650;&#x5B9A;&#x5728;&#x4E00;&#x4E2A;&#x5F88;&#x5C0F;&#x7684;&#x8303;&#x56F4;&#x3002;&#x90A3;&#x4E48;&#x5982;&#x679C;&#x53EF;&#x4EE5;&#x8FDB;&#x884C;&#x8FD9;&#x79CD;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7684;&#x7EA6;&#x675F;&#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x63D0;&#x9AD8;&#x7CFB;&#x7EDF;&#x7684;&#x5B89;&#x5168;&#x6027;&#x3002;</p>
<p><a href="https://en.wikipedia.org/wiki/Seccomp" target="_blank" rel="noopener">seccomp</a> &#x53EF;&#x4EE5;&#x8BA9;&#x6211;&#x4EEC;&#x505A;&#x8FD9;&#x4E2A;&#x4E8B;&#x60C5;&#xFF0C;&#x5728; docker &#x4E2D;&#x751A;&#x81F3;&#x76F4;&#x63A5;<a href="https://docs.docker.com/engine/security/seccomp/" target="_blank" rel="noopener">&#x96C6;&#x6210;&#x4E86; seccomp &#x7684;&#x5B89;&#x5168;&#x7EA6;&#x675F;</a>&#xFF0C;&#x56E0;&#x6B64;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x7ED3;&#x5408; Docker &#x6765;&#x7EA6;&#x675F;&#x5FAE;&#x670D;&#x52A1;&#x7684;&#x7EC6;&#x5316;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x6743;&#x9650;&#x3002;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run --security-opt seccomp=/path/sc_profile.json hello-world</span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x4E1C;&#x897F;&#x7684;&#x7F3A;&#x70B9;&#x662F;&#x592A;&#x957F;&#x4E86;&#xFF0C;&#x6BD4;&#x5982;&#x770B;&#x4E00;&#x4E0B;&#x8FD9;&#x4E2A;&#x9ED8;&#x8BA4;&#x914D;&#x7F6E;&#x7684;&#x6587;&#x4EF6;&#xFF1A;<a href="https://github.com/moby/moby/blob/master/profiles/seccomp/default.json" target="_blank" rel="noopener">https://github.com/moby/moby/blob/master/profiles/seccomp/default.json</a></p>
<p>&#x8FD8;&#x6709;&#x66F4;&#x957F;&#x7684;&#xFF0C;&#x6BD4;&#x5982; Jessie Frazelle(Docker Queen) &#x505A;&#x7684;&#x90A3;&#x4E2A;&#x5728; Docker &#x4E2D;&#x8FD0;&#x884C; Chrome &#x7684;&#x955C;&#x50CF;&#x6240;&#x9700;&#x8981;&#x7684; seccomp &#x914D;&#x7F6E;&#xFF1A;<a href="https://github.com/jessfraz/dotfiles/blob/master/etc/docker/seccomp/chrome.json" target="_blank" rel="noopener">https://github.com/jessfraz/dotfiles/blob/master/etc/docker/seccomp/chrome.json</a></p>
<p>&#x8FD9;&#x6CA1;&#x6709;&#x4E2A;&#x57FA;&#x7840;&#x8FD8;&#x771F;&#x5199;&#x4E0D;&#x4E86;&#xFF0C;&#x6216;&#x8BB8;&#x8FD9;&#x5C31;&#x662F;&#x5B89;&#x5168;&#x516C;&#x53F8;&#x5B58;&#x5728;&#x7684;&#x539F;&#x56E0;&#x4E4B;&#x4E00;&#x5427;&#x2026;&#x2026;&#x1F60E;</p>
<h2 id="cheng-xu-zhong-shi-yong-seccomp-pei-zhi"><a href="#&#x7A0B;&#x5E8F;&#x4E2D;&#x4F7F;&#x7528;-seccomp-&#x914D;&#x7F6E;" class="headerlink" title="&#x7A0B;&#x5E8F;&#x4E2D;&#x4F7F;&#x7528; seccomp &#x914D;&#x7F6E;"></a>&#x7A0B;&#x5E8F;&#x4E2D;&#x4F7F;&#x7528; seccomp &#x914D;&#x7F6E; <a href="#cheng-xu-zhong-shi-yong-seccomp-pei-zhi" class="header-anchor">#</a></h2><p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x6307;&#x5B9A; <code>seccomp</code> &#x7684;&#x914D;&#x7F6E;&#x3002;&#x6211;&#x4EEC;&#x6DFB;&#x52A0;&#x4E00;&#x4E2A; <code>disallow()</code> &#x51FD;&#x6570;&#xFF0C;&#x6765;&#x7981;&#x6B62;&#x67D0;&#x4E2A; syscall&#x3002;</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">disallow</span><span class="params">(sc <span class="keyword">string</span>)</span></span> {</span><br><span class="line">	id, err := sec.GetSyscallFromName(sc)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	filter, _ := sec.NewFilter(sec.ActAllow)</span><br><span class="line">	filter.AddRule(id, sec.ActErrno.SetReturnCode(<span class="keyword">int16</span>(syscall.EPERM)))</span><br><span class="line">	filter.Load()</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x7136;&#x540E;&#x6211;&#x4EEC;&#x5728; <code>main()</code> &#x4E2D;&#x6267;&#x884C; <code>hello</code> &#x524D;&#xFF0C;&#x7981;&#x7528;&#x4E00;&#x4E2A; syscall&#xFF0C;&#x5047;&#x8BBE;&#x6211;&#x4EEC;&#x7981;&#x7528; <code>write</code>&#xFF1A;</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">	fmt.Printf(<span class="string">&quot;Run %v\n&quot;</span>, os.Args[<span class="number">1</span>:])</span><br><span class="line"></span><br><span class="line">	<span class="comment">//	&#x7981;&#x7528; write &#x7CFB;&#x7EDF;&#x8C03;&#x7528;</span></span><br><span class="line">	disallow(<span class="string">&quot;write&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">//	&#x521B;&#x5EFA;&#x8C03;&#x7528;&#x7684;&#x547D;&#x4EE4;</span></span><br><span class="line">	cmd := exec.Command(os.Args[<span class="number">1</span>], os.Args[<span class="number">2</span>:]...)</span><br><span class="line">...</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x7136;&#x540E;&#x518D;&#x6B21;&#x6267;&#x884C;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x53D1;&#x73B0;&#x4EC0;&#x4E48;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x90FD;&#x6CA1;&#x8F93;&#x51FA;&#xFF1A;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ./strace ../hello/hello</span><br><span class="line">Run [../hello/hello]</span><br></pre></td></tr></table></figure>
<p>&#x4E3A;&#x4EC0;&#x4E48;&#x8FDE;&#x9664;&#x4E86; <code>write</code> &#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x90FD;&#x6CA1;&#x6709;&#x8F93;&#x51FA;&#x5462;&#xFF1F;&#x56E0;&#x4E3A;&#x6253;&#x5370;&#x90A3;&#x4E9B;&#x5B57;&#x7B26;&#x4E32;&#x5230;&#x5C4F;&#x5E55;&#x7684;&#x8FC7;&#x7A0B;&#xFF0C;&#x4E5F;&#x662F;&#x901A;&#x8FC7;&#x8C03;&#x7528; <code>write</code> &#x6765;&#x5B9E;&#x73B0;&#x7684;&#x3002;&#x800C;&#x8FD9;&#x4E2A;&#x52A0;&#x8F7D;&#x7684; <code>seccomp</code> &#x7684;&#x5B89;&#x5168;&#x914D;&#x7F6E;&#xFF0C;&#x662F;&#x5BF9;&#x5F53;&#x524D;&#x8FDB;&#x7A0B;&#x6709;&#x6548;&#x7684;&#xFF08;&#x5F53;&#x7136;&#xFF0C;<code>hello</code> &#x6267;&#x884C;&#x540E;&#x4E5F;&#x4F1A;&#x96C6;&#x6210;&#x8BE5;&#x914D;&#x7F6E;&#xFF09;&#xFF0C;&#x90A3;&#x4E48;&#x7236;&#x8FDB;&#x7A0B;&#x81EA;&#x7136;&#x4E5F;&#x4E0D;&#x80FD;&#x901A;&#x8FC7; <code>write</code> &#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x6253;&#x5370;&#x8F93;&#x51FA;&#x4E86;&#xFF0C;&#x6211;&#x4EEC;&#x8C8C;&#x4F3C;&#x628A;&#x81EA;&#x5DF1;&#x4E5F;&#x7ED9;&#x7981;&#x4E86;&#x2026;&#x2026;&#x1F605;</p>
<p>&#x597D;&#x5427;&#xFF0C;&#x8FD9;&#x6837;&#x5B50;&#x6211;&#x4EEC;&#x6839;&#x672C;&#x5565;&#x90FD;&#x770B;&#x4E0D;&#x89C1;&#xFF0C;&#x6765;&#x6362;&#x4E00;&#x4E2A;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7981;&#x6B62;&#x4E00;&#x4E0B;&#x3002;&#x8FD9;&#x6B21;&#x6211;&#x4EEC;&#x6362;&#x4E2A;&#x547D;&#x4EE4;&#xFF0C;&#x4E0D;&#x7528; <code>hello</code> &#x4E86;&#xFF0C;&#x7528; <code>echo hello</code>&#x3002;&#x7136;&#x540E;&#x7528;&#x6211;&#x4EEC;&#x7684; strace &#x770B;&#x770B;&#x90FD;&#x6709;&#x5565;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#xFF1A;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1|<span class="built_in">read</span></span><br><span class="line">1|write</span><br><span class="line">3|open</span><br><span class="line">5|close</span><br><span class="line">4|fstat</span><br><span class="line">7|mmap</span><br><span class="line">4|mprotect</span><br><span class="line">1|munmap</span><br><span class="line">3|brk</span><br><span class="line">3|access</span><br><span class="line">1|execve</span><br><span class="line">1|arch_prctl</span><br></pre></td></tr></table></figure>
<p>&#x55EF;&#xFF0C;&#x8FD9;&#x91CC;&#x770B; <code>open</code> &#x4E0D;&#x987A;&#x773C;&#xFF0C;&#x5C31;&#x7981;&#x7528;&#x5B83;&#x4E86;&#x3002;</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//	&#x7981;&#x7528; open &#x7CFB;&#x7EDF;&#x8C03;&#x7528;</span></span><br><span class="line">disallow(<span class="string">&quot;open&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>&#x6784;&#x5EFA;&#x540E;&#xFF0C;&#x518D;&#x6B21;&#x8FD0;&#x884C;&#xFF1A;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ ./strace <span class="built_in">echo</span> hello</span><br><span class="line">Run [<span class="built_in">echo</span> hello]</span><br><span class="line"><span class="built_in">wait</span>() returned: stop signal: trace/breakpoint <span class="built_in">trap</span></span><br><span class="line">execve</span><br><span class="line">brk</span><br><span class="line">access</span><br><span class="line">mmap</span><br><span class="line">access</span><br><span class="line">open</span><br><span class="line">open</span><br><span class="line"><span class="built_in">stat</span></span><br><span class="line">open</span><br><span class="line"><span class="built_in">stat</span></span><br><span class="line">open</span><br><span class="line"><span class="built_in">stat</span></span><br><span class="line">open</span><br><span class="line"><span class="built_in">stat</span></span><br><span class="line"><span class="built_in">echo</span>: error <span class="keyword">while</span> loading shared libraries: libc.so.6: cannot open shared object file: Operation not permitted</span><br><span class="line">writev</span><br><span class="line">        5|open</span><br><span class="line">        4|<span class="built_in">stat</span></span><br><span class="line">        1|mmap</span><br><span class="line">        1|brk</span><br><span class="line">        1|writev</span><br><span class="line">        2|access</span><br><span class="line">        1|execve</span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x770B;&#x5230;&#x4E86; <code>cannot open shared object file: Operation not permitted</code> &#x7684;&#x62A5;&#x9519;&#xFF0C;&#x8FD9;&#x5C31;&#x662F;&#x7531;&#x4E8E;&#x6211;&#x4EEC;&#x7981;&#x6B62;&#x4E86; <code>open</code> &#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#xFF0C;&#x4ECE;&#x800C;&#x5BFC;&#x81F4; <code>echo hello</code> &#x8FDB;&#x884C;&#x8BE5;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x51FA;&#x9519;&#x4E86;&#x3002;&#x800C;&#x4E14;&#x53EF;&#x4EE5;&#x6CE8;&#x610F;&#x5230;&#xFF0C;<code>echo hello</code> &#x7684;&#x5185;&#x90E8;&#x6709;&#x9519;&#x8BEF;&#x5904;&#x7406;&#xFF0C;&#x5C1D;&#x8BD5;&#x4E86;&#x597D;&#x51E0;&#x6B21;&#x624D;&#x6700;&#x540E;&#x62A5;&#x9519;&#x9000;&#x51FA;&#x7684;&#x3002;</p>
</div></article><div class="pagination"><a href="/post/golang-2017-10-09-video-the-new-era-of-go-package-management.html" class="pagination-prev">PREV</a><a href="/post/golang-2017-10-04-video-understanding-channels.html" class="pagination-next">NEXT</a></div><div class="comments"><div id="disqus_thread"></div></div></div><aside class="sidebar"><h3>分类标签</h3><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Sonatype/">Sonatype</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/blog/">blog</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/coreos/">coreos</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker-summit/">docker summit</a></li></ul><h3>最新文章</h3><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/post/golang-2017-10-27-video-how-to-correctly-use-package-context.html">视频笔记：如何正确使用 Context - Jack Lindamood</a></li><li class="post-list-item"><a class="post-list-link" href="/post/golang-2017-10-20-video-seven-ways-to-profile-go-apps.html">视频笔记：7种 Go 程序性能分析方法 - Dave Cheney</a></li><li class="post-list-item"><a class="post-list-link" href="/post/golang-2017-10-13-video-write-container-in-go-from-scratch.html">视频笔记：容器是什么？让我们用 Go 写一个吧！ - Liz Rice</a></li><li class="post-list-item"><a class="post-list-link" href="/post/golang-2017-10-09-video-the-new-era-of-go-package-management.html">视频笔记：Go 包管理的新时代 - Sam Boyer</a></li><li class="post-list-item"><a class="post-list-link" href="/post/golang-2017-10-05-video-guide-to-syscall.html">视频笔记：Go 和 syscall - Liz Rice</a></li><li class="post-list-item"><a class="post-list-link" href="/post/golang-2017-10-04-video-understanding-channels.html">视频笔记：理解 channels - Kavya Joshi</a></li><li class="post-list-item"><a class="post-list-link" href="/post/golang-2017-10-01-video-go-build-mode.html">视频笔记：Go 的构建模式 - David Crawshaw</a></li><li class="post-list-item"><a class="post-list-link" href="/post/golang-2017-09-23-video-go-for-crypto-developers.html">视频笔记：Go 密码学应用 - George Tankersley</a></li></ul></aside></section></div><div class="extra"></div><footer class="footer"><div class="row-flex-row limit-width vh-center"><div class="copyright"><p>© 2020 <a href="/">王涛</a></p></div><div class="power"><p><a href="https://pages.coding.net/">Hosted by Coding Pages</a>, 
<a href="https://github.com/">GitHub</a>, 
<a href="https://hexo.io">Hexo</a>, 
<a href="https://github.com/twang2218/hexo-theme-jekyll">Jekyll</a></p></div></div></footer><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-80785538-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "//hm.baidu.com/hm.js?ee75cf08ad330aa99f8540efa2570970";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="//cdn.bootcss.com/mermaid/7.0.0/mermaid.min.js"></script><script>(function() {
    var d = document, s = d.createElement('script');
    s.src = '//twang2218-coding.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
})();</script></body></html>